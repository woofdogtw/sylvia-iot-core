<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture - Sylvia-IoT Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/overview.html"><strong aria-hidden="true">1.1.</strong> What is Sylvia-IoT?</a></li><li class="chapter-item expanded "><a href="../intro/concept.html"><strong aria-hidden="true">1.2.</strong> Concept</a></li></ol></li><li class="chapter-item expanded "><a href="../guide/index.html"><strong aria-hidden="true">2.</strong> User Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guide/quick.html"><strong aria-hidden="true">2.1.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="../guide/configuration.html"><strong aria-hidden="true">2.2.</strong> Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../arch/index.html"><strong aria-hidden="true">3.</strong> Internal Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../arch/arch.html" class="active"><strong aria-hidden="true">3.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../arch/flow.html"><strong aria-hidden="true">3.2.</strong> Data Flow</a></li><li class="chapter-item expanded "><a href="../arch/cache.html"><strong aria-hidden="true">3.3.</strong> Cache</a></li></ol></li><li class="chapter-item expanded "><a href="../dev/index.html"><strong aria-hidden="true">4.</strong> Developer's Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/oauth2.html"><strong aria-hidden="true">4.1.</strong> OAuth2 Authentication</a></li><li class="chapter-item expanded "><a href="../dev/network.html"><strong aria-hidden="true">4.2.</strong> Network Services</a></li><li class="chapter-item expanded "><a href="../dev/application.html"><strong aria-hidden="true">4.3.</strong> Application Services</a></li><li class="chapter-item expanded "><a href="../dev/core.html"><strong aria-hidden="true">4.4.</strong> Sylvia-IoT Core</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/dir.html"><strong aria-hidden="true">4.4.1.</strong> Directory Structure</a></li><li class="chapter-item expanded "><a href="../dev/style.html"><strong aria-hidden="true">4.4.2.</strong> Code Style</a></li><li class="chapter-item expanded "><a href="../dev/testing.html"><strong aria-hidden="true">4.4.3.</strong> Writing Tests</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../appendex/index.html"><strong aria-hidden="true">5.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendex/source.html"><strong aria-hidden="true">5.1.</strong> Data Sources</a></li><li class="chapter-item expanded "><a href="../appendex/repo.html"><strong aria-hidden="true">5.2.</strong> Supplementary Projects</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sylvia-IoT Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p><img src="arch.svg" alt="Architecture" /></p>
<p>Here is the diagram of Sylvia-IoT components. In this chapter, we will explain each one in detail.</p>
<h2 id="sylvia-iot-core-components"><a class="header" href="#sylvia-iot-core-components">Sylvia-IoT Core Components</a></h2>
<p>Abbreviated as ABCD (laughs ðŸ˜Š)</p>
<h3 id="auth-sylvia-iot-auth"><a class="header" href="#auth-sylvia-iot-auth">Auth (sylvia-iot-auth)</a></h3>
<ul>
<li>Purpose
<ul>
<li>Provides the validity and information of access tokens for HTTP APIs, allowing APIs to
determine whether to authorize access with the token.</li>
<li>Offers the authorization mechanism for OAuth2, currently supporting the following flows:
<ul>
<li>Authorization code grant flow
<ul>
<li>Clients need to use a webview to display login and authorization pages.</li>
<li>Currently used by coremgr CLI.</li>
</ul>
</li>
<li>Client credentials grant flow
<ul>
<li>Currently reserved and not actively used.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Managed entities
<ul>
<li>User accounts
<ul>
<li>User's basic information.</li>
<li>Permissions (roles).</li>
</ul>
</li>
<li>Clients
<ul>
<li>Access permissions (scopes) for HTTP APIs.</li>
</ul>
</li>
</ul>
</li>
<li>Dependencies
<ul>
<li>None. It can operate independently.</li>
</ul>
</li>
</ul>
<h3 id="broker-sylvia-iot-broker"><a class="header" href="#broker-sylvia-iot-broker">Broker (sylvia-iot-broker)</a></h3>
<ul>
<li>Purpose
<ul>
<li>Manages entities related to devices.</li>
<li>Binds devices and applications, forwards device data to applications, or receives data from
applications to devices.</li>
<li>(Optional) Can send all traffic passing through networks and application data via the data
channel to the <strong>Data service</strong> for storage or analysis.</li>
</ul>
</li>
<li>Managed entities
<ul>
<li>Units
<ul>
<li>Composed of one owner and multiple members.</li>
<li>Independently manage devices, applications, networks, and route (binding) rules.</li>
</ul>
</li>
<li>Applications
<ul>
<li>Analyze data and present results based on device data.</li>
</ul>
</li>
<li>Networks
<ul>
<li>Can use services directly connected to Sylvia-IoT or connect existing network services
(e.g., <a href="https://www.thethingsnetwork.org/"><strong>The Things Network (TTN)</strong></a> or
<a href="https://www.chirpstack.io/"><strong>ChirpStack</strong></a>) to Sylvia-IoT using adapters.</li>
<li>One network address can be used to transmit data from one device.</li>
<li>Administrators (admin role) can create public networks.</li>
</ul>
</li>
<li>Devices
<ul>
<li>Each device represents an application on an endpoint, such as a tracker, meter, sensor,
etc.</li>
<li>Devices need to be attached to a network address under a network to transmit data.
<ul>
<li>Devices can be attached to public networks, but it requires administrator accounts
(admin/manager roles) to set up.</li>
<li>Each device has a unique identifier (device ID). If the application relies on this
identifier, even if the network and address are changed, there is no need to change
the application's management.</li>
</ul>
</li>
<li>Each device can be assigned a device profile based on the data content.
<ul>
<li>With the profile, applications can quickly parse data without the need to create a
mapping table for identifiers.</li>
</ul>
</li>
</ul>
</li>
<li>Route rules
<ul>
<li>Binds devices to applications.
<ul>
<li>Many-to-many relationships are supported.</li>
</ul>
</li>
<li>Binds networks to applications, and all devices under that network will be routed, meaning
there is no need to bind them one by one.
<ul>
<li>Many-to-many relationships are supported.</li>
<li>Public networks cannot be bound.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Dependencies
<ul>
<li>Depends on Auth service.</li>
</ul>
</li>
</ul>
<h3 id="coremgr-sylvia-iot-coremgr"><a class="header" href="#coremgr-sylvia-iot-coremgr">Coremgr (sylvia-iot-coremgr)</a></h3>
<ul>
<li>Purpose
<ul>
<li>Coremgr, short for Core Manager, is responsible for managing the core components of
Sylvia-IoT.</li>
<li>Provides the main HTTP APIs for external direct access.
<ul>
<li>The Auth service only exposes authentication/authorization APIs. User and client
management still requires the use of coremgr API.</li>
<li>Uses bridging to indirectly access Auth and Broker HTTP APIs to manage various entities.</li>
</ul>
</li>
<li>Creates queues and corresponding permissions using the management API for RabbitMQ/EMQX, and
other message brokers.
<ul>
<li>Broker only manages associations between entities and AMQP/MQTT connections. The actual
configuration of RabbitMQ/EMQX is performed by coremgr.</li>
</ul>
</li>
<li>(Optional) Sends operation records, including additions, modifications, deletions, etc.,
through the data channel to the <strong>Data service</strong> for storage or analysis.</li>
</ul>
</li>
<li>Managed entities
<ul>
<li>(None)</li>
</ul>
</li>
<li>Dependencies
<ul>
<li>Depends on Auth and Broker services.</li>
<li>Depends on the management API of the message broker.</li>
</ul>
</li>
</ul>
<h3 id="coremgr-cli-sylvia-iot-coremgr-cli"><a class="header" href="#coremgr-cli-sylvia-iot-coremgr-cli">Coremgr CLI (sylvia-iot-coremgr-cli)</a></h3>
<ul>
<li>Purpose
<ul>
<li>Provides a command-line interface (CLI) for users to configure Sylvia-IoT using commands.</li>
</ul>
</li>
<li>Dependencies
<ul>
<li>Depends on Auth and Coremgr services. Auth is only used for authentication/authorization.</li>
<li>Can depend on the Data service to read historical data.</li>
</ul>
</li>
</ul>
<h3 id="control-channel-vs-data-channel"><a class="header" href="#control-channel-vs-data-channel">Control Channel vs. Data Channel</a></h3>
<ul>
<li>The control channel is used to transmit messages related to entity management (users, units,
devices, etc.). It can be categorized as follows:
<ul>
<li>Unicast: Each message has only one consumer and is used for Sylvia-IoT to push messages to
networks or applications, which will be explained in the later <a href="./flow.html"><strong>Data Flow</strong></a>
section.</li>
<li>Broadcast: Used to broadcast messages to various core processes within the Sylvia-IoT cluster,
which will be explained in the later <a href="./cache.html"><strong>Cache</strong></a> section.</li>
</ul>
</li>
<li>The data channel is used to transmit device data or historical data.
<ul>
<li>It covers Application Data, Network Data, and Coremgr OP Data.</li>
<li>Currently, AMQP 0-9-1 and MQTT 3.1.1 protocols are implemented. Additionally, AMQP 1.0, Kafka,
NATS, and other protocols can also be implemented.</li>
</ul>
</li>
</ul>
<h4 id="general-mq"><a class="header" href="#general-mq">general-mq</a></h4>
<p>Sylvia-IoT utilizes <a href="https://crates.io/crates/general-mq"><strong>general-mq</strong></a> to implement unicast and
broadcast, abstracting the details of communication protocols.</p>
<p>By implementing unicast/broadcast modes for AMQP 1.0, Kafka, or other protocols in general-mq and
corresponding management APIs in coremgr, Sylvia-IoT can support more protocols.</p>
<h3 id="data-sylvia-iot-data"><a class="header" href="#data-sylvia-iot-data">Data (sylvia-iot-data)</a></h3>
<ul>
<li>Purpose
<ul>
<li>Record or analyze data from the data channel.</li>
</ul>
</li>
</ul>
<p>This module is unique in that it does not have a specific implementation. Currently,
<strong>sylvia-iot-data</strong> in Sylvia-IoT Core provides storage and retrieval of raw data.</p>
<p>Below are some possible scenarios for extension:</p>
<ul>
<li>Rule engine.
<ul>
<li>Since the data channel contains all network data, the Data module can be implemented as a
common rule engine in IoT platforms.</li>
</ul>
</li>
<li>Stream processing.
<ul>
<li>The data channel can be implemented as a Kafka queue for stream processing.</li>
</ul>
</li>
</ul>
<h2 id="message-brokers"><a class="header" href="#message-brokers">Message Brokers</a></h2>
<blockquote>
<p>Here, message brokers refer to services like RabbitMQ and EMQX, not Sylvia-IoT Broker.
Unless specifically mentioned, &quot;Broker&quot; in this document refers to Sylvia-IoT Broker.</p>
</blockquote>
<p>Some important points:</p>
<ul>
<li>Since coremgr needs to configure queues through the management APIs, relevant implementations must
be provided to support this feature. Currently, coremgr supports the following message brokers:
<ul>
<li>RabbitMQ</li>
<li>EMQX</li>
<li>In the future, Kafka or other protocols can be implemented to broaden the application scope of
Sylvia-IoT.</li>
</ul>
</li>
<li>Sylvia-IoT has the following requirements:
<ul>
<li>Message queuing, which refers to the traditional message pattern (one message has only one
consumer).
<ul>
<li>MQTT is implemented using shared subscription.</li>
</ul>
</li>
<li>Publish/Subscribe, used for broadcasting control channel messages. This will be covered in the
<a href="./cache.html"><strong>Cache</strong></a> section.
<ul>
<li>AMQP is implemented using fanout exchanges and temporary queues.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="rumqttd"><a class="header" href="#rumqttd">rumqttd</a></h3>
<p>In the <a href="../guide/quick.html"><strong>Quick Start</strong></a> section, we used <strong>sylvia-iot-core</strong> as an example. This
executable includes the complete Auth/Broker/Coremgr/Data and rumqttd.</p>
<p>To make it possible to run in resource-constrained environments, <strong>sylvia-iot-core</strong> contains the
<a href="https://github.com/bytebeamio/rumqtt"><strong>rumqttd</strong></a> MQTT broker.
By configuring it to use SQLite as the database and MQTT for message delivery, the sylvia-iot-core
achieves the full functionality of Sylvia-IoT in just two files.</p>
<blockquote>
<p>The &quot;core&quot; is an executable that contains all the complete functionalities, whereas &quot;coremgr&quot; only
contains management functionalities and does not include rumqttd.</p>
</blockquote>
<p>To accommodate this limited environment, Sylvia-IoT adopts rumqttd.
Currently, Sylvia-IoT does not have an implementation of rumqttd management APIs, so it is not
suitable for use in a cluster architecture. It is also not recommended to use this mode for queue
permission requirements.</p>
<h2 id="third-party-components"><a class="header" href="#third-party-components">Third-Party Components</a></h2>
<h3 id="application-servers-network-servers"><a class="header" href="#application-servers-network-servers">Application Servers, Network Servers</a></h3>
<p>In addition to using the data channel to send and receive device data, applications and networks can
also access Sylvia-IoT HTTP APIs and control channel messages to build their own management systems.</p>
<h3 id="devices"><a class="header" href="#devices">Devices</a></h3>
<p>Devices in Sylvia-IoT refer to narrow-definition terminal devices that only process the data
required by applications, and they are generally bound to network modules. The network module,
however, can be interchangeable.</p>
<p>Here's an example of replacing the network module: Suppose the device uses a Raspberry Pi to connect
sensors for specific application development. The network part can be changed to different protocols
at any time (e.g., switching from LoRa to WiFi or even using an Ethernet cable). In Sylvia-IoT, you
only need to modify the corresponding network and address settings for the device.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../arch/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../arch/flow.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../arch/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../arch/flow.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
