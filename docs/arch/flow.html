<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Data Flow - Sylvia-IoT Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sylvia-IoT Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="data-flow"><a class="header" href="#data-flow">Data Flow</a></h1>
<p>This chapter introduces how Sylvia-IoT handles data flow, including the following scenarios:</p>
<ul>
<li>Uplink data: Data sent from devices to applications.</li>
<li>Downlink data: Data sent from applications to devices.</li>
<li>Control channel: Messages transmitted from Broker to the network.</li>
<li>Coremgr operation data: Records of system operation history, including management operations.</li>
</ul>
<h2 id="uplink-data"><a class="header" href="#uplink-data">Uplink Data</a></h2>
<p><img src="flow-uplink.svg" alt="Uplink" /></p>
<p>When device data is sent to the corresponding queue through the network service, the data will be
processed and sent to the application as follows:</p>
<ol>
<li>If the data format is correct, it will proceed to the next step; otherwise, it will be discarded.</li>
<li>Broker first sends the data directly to the Data module (via the queue) to store the complete
uplink data content.</li>
<li>Scan all device routes and perform the following actions:
<ul>
<li>Send the data to the corresponding application queue.</li>
<li>Store the data sent to the application in the Data module.</li>
</ul>
</li>
<li>Scan all network routes and perform the following actions:
<ul>
<li>Check if the data has already been sent during the device route stage. If yes, move to the
next network route action; if not, continue with the following actions:</li>
<li>Send the data to the corresponding application queue.</li>
<li>Store the data sent to the application in the Data module.</li>
</ul>
</li>
</ol>
<blockquote>
<p>The purpose of the comparison in Step 4 is to avoid duplicate sending when device routes and
network routes overlap.</p>
</blockquote>
<h2 id="downlink-data"><a class="header" href="#downlink-data">Downlink Data</a></h2>
<p><img src="flow-downlink.svg" alt="Downlink" /></p>
<p>When the application service sends data to be delivered to a device through the queue, the data is
processed as follows:</p>
<ol>
<li>If the format is correct, proceed to the next step; otherwise, respond with an error message
through the <code>resp</code> queue.</li>
<li>Check if the destination device belongs to the specified unit. If it does, proceed to the next
step; otherwise, respond with an error message through the <code>resp</code> queue.</li>
<li>Assign a unique identifier (ID) to this data as an independent entry and store it in the Data
module.</li>
<li>Store the ID and the source application of this data in the database to facilitate reporting the
delivery status back to the application service in the future.</li>
<li>Send the data (including the data ID) to the queue of the corresponding network service.</li>
<li>If the data is sent to the network service queue, report the data ID back to the application
service to track the delivery status.</li>
</ol>
<blockquote>
<p>Compared to uplink data, downlink data is slightly more complex, mainly because
<strong>reporting the delivery status is required</strong>.</p>
</blockquote>
<p>The Broker does not retain the <code>resp</code> queue for the network service to report data correctness. This
is because the Broker, being part of the infrastructure, always ensures data correctness.
The network service only needs to focus on delivering the data to the device and reporting the final
result. Even if the data sent by the Broker is invalid, the network service can directly report it
through the <code>result</code> queue.</p>
<p><img src="flow-downlink-result.svg" alt="Downlink-Result" /></p>
<p>After processing the data (regardless of success or failure), the network service <strong>MUST</strong> use the
data ID to report back to the Broker in the following order:</p>
<ol>
<li>If the format is correct, proceed to the next step; otherwise, discard the message.</li>
<li>Submit a request to the Data module for result updates using the ID.</li>
<li>Retrieve the application service information associated with that ID and report the result back
to the application service that sent this downlink data (ensuring that other applications will
not receive the result).</li>
<li>If step 3 is successful, clear the ID information from the database.</li>
</ol>
<blockquote>
<p>The use of an additional ID database aims to retain the source application of the downlink data.
After all, if data is sent by application A, why should application B receive the result
😊?</p>
</blockquote>
<h2 id="control-channel"><a class="header" href="#control-channel">Control Channel</a></h2>
<p><img src="flow-ctrl.svg" alt="Ctrl" /></p>
<p>The Broker or coremgr provides APIs that allow the network service to update device data at any
time. However, relying on periodic API requests for synchronization is inefficient and may impact
routing performance due to frequent requests.
The Broker provides a mechanism that when there are changes in device data, information is provided
to the corresponding network service through <code>broker.network.[unit-code].[network-code].ctrl</code>.</p>
<p>Sylvia-IoT allows devices to change their associated networks or addresses. When this operation
occurs, the network service will receive the following messages based on different scenarios:</p>
<ul>
<li>Changing from network A to network B:
<ul>
<li>Notify network A that a specific address has been removed.</li>
<li>Notify network B that a specific address has been added.</li>
</ul>
</li>
<li>Changing the address within network A:
<ul>
<li>Notify network A that a specific address has been removed.</li>
<li>Notify network A that a specific address has been added.</li>
</ul>
</li>
</ul>
<h2 id="operation-data"><a class="header" href="#operation-data">Operation Data</a></h2>
<p><img src="flow-opdata.svg" alt="OpData" /></p>
<p>Coremgr has an optional configuration to store all system operation logs (limited to coremgr HTTP
APIs, of course). The current scope includes POST/PUT/PATCH/DELETE, etc.</p>
<p>As shown in the diagram, after each API operation, coremgr records the following data:</p>
<ul>
<li>Request time</li>
<li>Response time</li>
<li>Processing time</li>
<li>HTTP status</li>
<li>Source IP address</li>
<li>HTTP method</li>
<li>(Optional) HTTP request body
<ul>
<li>The content of <code>data.password</code> is filtered. When the request contains a <code>password</code> field, its
content is cleared. The key is retained to indicate that this request involves password modification.</li>
</ul>
</li>
<li>User ID</li>
<li>Client ID</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../arch/arch.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../arch/cache.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../arch/arch.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../arch/cache.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
