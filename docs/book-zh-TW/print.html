<!DOCTYPE HTML>
<html lang="zh-TW" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sylvia-IoT èªªæ˜æ–‡ä»¶</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sylvia-IoT èªªæ˜æ–‡ä»¶</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>é€™ä»½æ–‡ä»¶æœƒå¸¶æ‚¨é€æ­¥èªè­˜ä»€éº¼æ˜¯ <strong>Sylvia-IoT ç‰©è¯ç¶²å¹³å°</strong>ï¼Œæ¥è‘—æä¾›å¦‚ä½•å®‰è£èˆ‡ä½¿ç”¨çš„èªªæ˜ã€‚</p>
<p>åœ¨åˆæ­¥äº†è§£ Sylvia-IoT å’Œä½¿ç”¨æ–¹å¼å¾Œï¼Œæœƒé€²ä¸€æ­¥ä»‹ç´¹å…§éƒ¨æ¶æ§‹ï¼Œè®“æ‚¨çŸ¥é“ Sylvia-IoT çš„æ¨¡çµ„å’Œé‹ä½œåŸç†ï¼Œä»¥åŠå®ƒåœ¨æå‡æ•ˆèƒ½ä¸Šçš„è¨­è¨ˆæ€ç¶­ã€‚</p>
<p>é–‹ç™¼æŒ‡å—ï¼Œæœƒå…ˆèªªæ˜ç¬¬ä¸‰æ–¹çš„é–‹ç™¼è€…æˆ–å» å•†è©²å¦‚ä½•é–‹ç™¼ä»–å€‘çš„æ‡‰ç”¨æˆ–æ˜¯ç¶²è·¯æœå‹™ã€‚
å¦‚æœå° Sylvia-IoT çš„æ ¸å¿ƒé–‹ç™¼æœ‰èˆˆè¶£çš„äººï¼ŒæŒ‡å—ä¹Ÿæä¾›äº†ç¨‹å¼ç¢¼çš„æ¶æ§‹ä»¥åŠé¢¨æ ¼ã€‚</p>
<p>è®“æˆ‘å€‘é–‹å§‹å§ï¼</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»€éº¼æ˜¯-sylvia-iot"><a class="header" href="#ä»€éº¼æ˜¯-sylvia-iot">ä»€éº¼æ˜¯ Sylvia-IoTï¼Ÿ</a></h1>
<p><strong>Sylvia-IoT</strong> æ˜¯ä¸€å€‹ç‰©è¯ç¶²å¹³å°ï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯å°‡è£ç½®çš„è¨Šæ¯è½‰ç™¼çµ¦æ‡‰ç”¨ç¨‹å¼ï¼Œæˆ–æ˜¯æ‡‰ç”¨ç¨‹å¼ç™¼é€å‘½ä»¤çµ¦è£ç½®ã€‚</p>
<p><img src="intro/intro.svg" alt="Introduction" /></p>
<p>ä¸Šåœ–æ˜¯ä¸€å€‹ç°¡å–®çš„èªªæ˜ã€‚è£ç½®ï¼ˆå¦‚æ„Ÿæ‡‰å™¨ï¼‰æœƒç¶å®šæŸä¸€ç¨®å‚³è¼¸æ¨¡çµ„ï¼Œé€éç¶²è·¯é–˜é“å™¨æˆ–ç¶²è·¯ä¼ºæœå™¨å‚³è¼¸è³‡æ–™ã€‚
Sylvia-IoT å°±æ˜¯ä¸€å€‹æä¾›è¨Šæ¯è½‰ç™¼çš„è§’è‰²ï¼Œæ¯å€‹æ‡‰ç”¨ç¨‹å¼å¯ä»¥è¨‚é–±ä»–å€‘é—œæ³¨çš„è£ç½®ä¾†åˆ†æè³‡æ–™ï¼Œæˆ–æ˜¯å‚³è¼¸è³‡æ–™åˆ°è£ç½®ã€‚</p>
<h2 id="ç‰¹é»"><a class="header" href="#ç‰¹é»">ç‰¹é»</a></h2>
<p>ä½¿ç”¨ Sylvia-IoT å¹³å°ï¼Œå°æ–¼å„å€‹ä¾›æ‡‰å•†å¯ä»¥æä¾›ä»¥ä¸‹å¥½è™•ï¼š</p>
<ul>
<li>è£ç½®ä¾›æ‡‰å•†ï¼ˆDevice Providerï¼‰
<ul>
<li>å¯ä»¥æ›´å®¹æ˜“è®Šæ›´ç¶²è·¯ä¾›æ‡‰å•†çš„æ¨¡çµ„ï¼Œç„¡é ˆè®Šæ›´æ‡‰ç”¨ç¨‹å¼å³å¯ç„¡ç¸«æ¥è»Œã€‚</li>
</ul>
</li>
<li>ç¶²è·¯ä¾›æ‡‰å•†ï¼ˆNetwork Providerï¼‰
<ul>
<li>å°ˆæ³¨é–‹ç™¼ç¶²è·¯å‚³è¼¸å”å®šä¾›è£ç½®ä½¿ç”¨ã€‚</li>
<li>å¯ä»¥é–‹ç™¼é€£æ¥å™¨ï¼ˆadapterï¼‰é€£æ¥ Sylvia-IoT å¹³å°ã€‚</li>
</ul>
</li>
<li>æ‡‰ç”¨ä¾›æ‡‰å•†ï¼ˆApplication Providerï¼‰
<ul>
<li>å¯ä»¥éš¨æ™‚æŒ‡å®šä»»æ„æ•¸é‡çš„æ‡‰ç”¨æ¥æ”¶ä¾†è‡ªåŒä¸€å€‹è£ç½®çš„è³‡æ–™ã€‚</li>
<li>é€é Sylvia-IoT çš„é€šè¨Šå”å®šéš”é›¢ï¼Œå¯ä»¥ä»»æ„æ›´æ›è£ç½®çš„ç¶²è·¯ä¾›æ‡‰å•†è€Œç„¡é ˆæ”¹å¯«ç¨‹å¼ç¢¼ã€‚</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ¦‚å¿µ"><a class="header" href="#æ¦‚å¿µ">æ¦‚å¿µ</a></h1>
<p>Sylvia-IoT æä¾›äº† HTTP API ç®¡ç†ä»¥ä¸‹å¯¦é«”ï¼š</p>
<ul>
<li>ä½¿ç”¨è€…å¸³è™Ÿï¼ˆUser Accountï¼‰
<ul>
<li>é€éä½¿ç”¨è€…å¸³è™Ÿå¯ä»¥å­˜å– Sylvia-IoT çš„ç®¡ç†ä»‹é¢ã€‚</li>
<li>å¯ä»¥é€éå®¢æˆ¶ç«¯å–å¾—è¨ªå•ä»¤ç‰Œï¼ˆaccess tokenï¼‰å­˜å– HTTP APIã€‚</li>
</ul>
</li>
<li>å®¢æˆ¶ç«¯æ‡‰ç”¨ç¨‹å¼ï¼ˆClientï¼‰
<ul>
<li>å­˜å– HTTP API çš„å¯¦é«”ã€‚</li>
<li>ç¬¬ä¸‰æ–¹å¯ä»¥é€é HTTP API é–‹ç™¼ Sylvia-IoT çš„ç®¡ç†åŠŸèƒ½ã€‚</li>
<li>é€é OAuth2 è®“ä½¿ç”¨è€…æˆæ¬Šå®¢æˆ¶ç«¯å­˜å–è³‡æºã€‚</li>
</ul>
</li>
<li>å–®ä½ï¼ˆUnitï¼‰
<ul>
<li>æ¯å€‹å–®ä½å¯ä»¥æŒ‡æ´¾ä¸€å€‹æ“æœ‰è€…å’Œå¤šå€‹æˆå“¡ã€‚</li>
<li>æ¯å€‹å–®ä½å¯ä»¥ç®¡ç†è‡ªå·±çš„è£ç½®ã€ç¶²è·¯ã€æ‡‰ç”¨ã€‚</li>
</ul>
</li>
<li>è£ç½®ï¼ˆDeviceï¼‰
<ul>
<li>å¦‚æ„Ÿæ‡‰å™¨ã€è¿½è¹¤å™¨ç­‰ç‰©è¯ç¶²çš„çµ‚ç«¯è£ç½®ã€‚</li>
</ul>
</li>
<li>æ‡‰ç”¨ï¼ˆApplicationï¼‰
<ul>
<li>ä¾æ“šéœ€æ±‚ï¼Œåˆ†æè£ç½®çš„è³‡æ–™ä¸¦å‘ˆç¾ï¼Œæ¯”å¦‚æ™ºæ…§å®¶é›»æ§åˆ¶ä¸­å¿ƒã€‚</li>
</ul>
</li>
<li>ç¶²è·¯ï¼ˆNetworkï¼‰
<ul>
<li>ä¾è£ç½®çš„é€šè¨Šéœ€æ±‚ï¼Œé€£æ¥ä¸åŒçš„ç¶²è·¯ä¼ºæœå™¨ä¾†æ”¶é€è£ç½®è³‡æ–™ã€‚</li>
<li>å¸¸è¦‹çš„é€šè¨Šå”å®šæœ‰ LoRaã€WiFi ç­‰ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ TCP/IPã€‚</li>
<li>å¯ä»¥é–‹ç™¼ç¶²è·¯é€£æ¥å™¨ï¼ˆnetwork adapterï¼‰ï¼Œå°‡æ—¢æœ‰çš„ç¶²è·¯ä¼ºæœå™¨ï¼ˆnetwork serverï¼Œå¦‚ TTNã€ChirpStackï¼‰å’Œ Sylvia-IoT æ•´åˆã€‚</li>
</ul>
</li>
<li>è·¯ç”±è¦å‰‡ï¼ˆRouting Rulesï¼‰
<ul>
<li>è£ç½®å’Œæ‡‰ç”¨çš„é—œè¯ã€‚</li>
<li>å¯ä»¥å°‡å€‹åˆ¥è£ç½®é€éç¶²è·¯ä½å€ï¼ˆnetwork addressï¼‰ç¶å®šã€æˆ–æ˜¯å°‡æ•´å€‹ç¶²è·¯ç¶å®šåˆ°ç‰¹å®šæ‡‰ç”¨ã€‚</li>
<li>å¤šå°å¤šçš„é—œä¿‚ã€‚ä¹Ÿå°±æ˜¯å¤šå€‹è£ç½®å¯ä»¥ç¶å®šä¸€å€‹æ‡‰ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸€å€‹è£ç½®ç¶å®šå¤šå€‹æ‡‰ç”¨ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å‚³è¼¸å”å®š"><a class="header" href="#å‚³è¼¸å”å®š">å‚³è¼¸å”å®š</a></h2>
<p>ç›®å‰ Sylvia-IoT æ”¯æ´ä»¥ä¸‹å”å®šï¼Œå’Œæ‡‰ç”¨èˆ‡ç¶²è·¯é€²è¡Œè¨Šæ¯å‚³è¼¸ï¼š</p>
<ul>
<li>AMQP 0-9-1</li>
<li>MQTT 3.1.1</li>
</ul>
<p>åªè¦èƒ½ç¬¦åˆæ˜ç¢ºåç¨±ï¼ˆä¸å«è¬ç”¨å­—å…ƒï¼‰çš„æ¶ˆæ¯ä½‡åˆ—æ¨¡å¼ï¼ˆmessage queuing modelï¼‰éƒ½å¯ä»¥æ”¯æ´ã€‚æ¯”å¦‚ AMQP 1.0ã€Apache Kafkaã€NATS ç­‰ã€‚
ç›®å‰é‚„ä¸æ”¯æ´ä¸»é¡Œå¼ç™¼å¸ƒè¨‚é–±ï¼ˆtopic publish/subscribeï¼‰æˆ–å»£æ’­ï¼ˆbroadcastï¼‰ã€å¤šæ’­ï¼ˆmulticastï¼‰çš„æ¨¡å¼ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä½¿ç”¨æŒ‡å—"><a class="header" href="#ä½¿ç”¨æŒ‡å—">ä½¿ç”¨æŒ‡å—</a></h1>
<p>æœ¬ç« å…§å®¹ï¼š</p>
<ul>
<li>å¸¶æ‚¨å¿«é€Ÿé‹è¡Œä¸€å€‹å¯ç”¨çš„ Sylvia-IoT ä¸¦å¯¦éš›æ¨¡æ“¬æ¥æ”¶è£ç½®è³‡æ–™ã€‚</li>
<li>æä¾›å®Œæ•´çš„è¨­å®šæª”å…§å®¹èˆ‡æ¦‚è¿°ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¿«é€Ÿé–‹å§‹"><a class="header" href="#å¿«é€Ÿé–‹å§‹">å¿«é€Ÿé–‹å§‹</a></h1>
<p>æœ¬ç« ç¯€æè¿°åœ¨ Ubuntu 22.04 ç’°å¢ƒçš„å¿«é€Ÿå®‰è£æ­¥é©Ÿã€‚</p>
<blockquote>
<p>ç›®å‰çš„å¯åŸ·è¡Œæª”æ¡ç”¨ GLIBC 2.31 ç·¨è­¯ï¼Œå¯ä»¥åœ¨ Ubuntu 22.04 æˆ–ä»¥ä¸Šçš„ OS åŸ·è¡Œã€‚
è¼ƒèˆŠçš„ OS å¯ä»¥ä½¿ç”¨ <a href="https://hub.docker.com/r/woofdogtw/sylvia-iot-core"><strong>Docker æ˜ åƒ</strong></a>ã€‚
ç›¸é—œçš„è¨­å®šå’Œç’°å¢ƒè®Šæ•¸å°‡æ–¼ <a href="guide/configuration.html"><strong>è¨­å®šæª”</strong></a> èªªæ˜ã€‚</p>
</blockquote>
<h2 id="å®‰è£å·¥å…·"><a class="header" href="#å®‰è£å·¥å…·">å®‰è£å·¥å…·</a></h2>
<pre><code class="language-shell">sudo apt -y install curl jq
</code></pre>
<h2 id="å®‰è£-docker"><a class="header" href="#å®‰è£-docker">å®‰è£ Docker</a></h2>
<p>é€™è£¡åƒè€ƒ <a href="https://docs.docker.com/engine/install/ubuntu/"><strong>Docker å®˜æ–¹ç¶²ç«™</strong></a> çš„å®‰è£æ­¥é©Ÿã€‚</p>
<pre><code class="language-shell">sudo apt -y install apt-transport-https ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
sudo apt update
sudo apt -y install docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo usermod -aG docker $USER
</code></pre>
<blockquote>
<p>è¨˜å¾—é‡å•Ÿ shell å¥—ç”¨ä½¿ç”¨è€…æ¬Šé™ã€‚</p>
</blockquote>
<h2 id="å®‰è£-mongodbrabbitmqemqx"><a class="header" href="#å®‰è£-mongodbrabbitmqemqx">å®‰è£ MongoDBã€RabbitMQã€EMQX</a></h2>
<p>å•Ÿå‹•æœå‹™ï¼ˆç‰ˆæœ¬å’Œè³‡æ–™ä¿å­˜çš„è³‡æ–™å¤¾å¯ä»¥è¦–æƒ…å½¢èª¿æ•´ï¼‰ï¼š</p>
<pre><code class="language-shell">export MONGODB_VER=7.0.9
export RABBITMQ_VER=3.13.2
export EMQX_VER=5.6.1

export MONGODB_DIR=$HOME/db/mongodb
export RABBITMQ_DIR=$HOME/db/rabbitmq
export EMQX_DIR=$HOME/db/emqx

mkdir -p $MONGODB_DIR
docker run --rm --name mongodb -d \
  -p 27017:27017 \
  -v $MONGODB_DIR:/data/db \
  mongo:$MONGODB_VER

mkdir -p $RABBITMQ_DIR
docker run --rm --name rabbitmq -d \
  -e RABBITMQ_NODENAME="rabbit@localhost" \
  -p 5671:5671 -p 5672:5672 -p 15672:15672 \
  -v $RABBITMQ_DIR:/var/lib/rabbitmq \
  rabbitmq:$RABBITMQ_VER-management-alpine

mkdir -p $EMQX_DIR
docker run --rm --name emqx -d \
  -e EMQX_LOADED_PLUGINS="emqx_dashboard|emqx_management|emqx_auth_mnesia" \
  -e EMQX_LOADED_MODULES="emqx_mod_acl_internal,emqx_mod_presence,emqx_mod_topic_metrics" \
  -p 1883:1883 -p 8883:8883 -p 18083:18083 \
  -v $EMQX_DIR:/opt/emqx/data \
  emqx/emqx:$EMQX_VER
</code></pre>
<blockquote>
<p>é€™è£¡åªæ˜¯ä»‹ç´¹ EMQX éœ€è¦ä½¿ç”¨çš„ pluginï¼Œä¸‹é¢çš„å±•ç¤ºä¸æœƒä½¿ç”¨ã€‚æ‚¨ä¹Ÿå¯ä»¥å…ˆä¸å•Ÿå‹• EMQXã€‚</p>
</blockquote>
<h2 id="ä¸‹è¼‰-sylvia-iot"><a class="header" href="#ä¸‹è¼‰-sylvia-iot">ä¸‹è¼‰ Sylvia-IoT</a></h2>
<pre><code class="language-shell">curl -LO https://github.com/woofdogtw/sylvia-iot-core/releases/latest/download/sylvia-iot-core.tar.xz
curl -LO https://github.com/woofdogtw/sylvia-iot-core/releases/latest/download/sylvia-iot-coremgr-cli.tar.xz
curl -L -o config.json5 https://github.com/woofdogtw/sylvia-iot-core/raw/main/files/config.json5.example
tar xf sylvia-iot-core.tar.xz
tar xf sylvia-iot-coremgr-cli.tar.xz
</code></pre>
<h2 id="ä¿®æ”¹-configjson5"><a class="header" href="#ä¿®æ”¹-configjson5">ä¿®æ”¹ config.json5</a></h2>
<p>ç‚ºäº†æ–¹ä¾¿å±•ç¤ºï¼Œé€™è£¡å°ç¯„ä¾‹çš„ config.json5 åšäº†ä¸€äº›ä¿®æ”¹ï¼š</p>
<ul>
<li>ç”±æ–¼é€™è£¡è¦å±•ç¤ºçš„æ˜¯ MongoDBï¼Œå°‡æ‰€æœ‰çš„ <code>"engine": "sqlite"</code> æ”¹æˆ <code>"engine": "mongodb"</code>ã€‚
<pre><code>"db": {
    "engine": "mongodb",
    ...
},
</code></pre>
</li>
<li>å…ˆä¸å•Ÿç”¨ HTTPSï¼Œå°‡æ†‘è­‰æª”è¨­å®šè¨»è§£æ‰ï¼š
<pre><code>//"cacertFile": "/etc/ssl/certs/ca-certificates.crt",
//"certFile": "/home/user/rust/conf/certs/sylvia-iot.crt",
//"keyFile": "/home/user/rust/conf/certs/sylvia-iot.key",
</code></pre>
</li>
<li>å»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ä½œç‚ºéœæ…‹æª”æ¡ˆçš„å­˜æ”¾è™•ï¼Œæ­¤è™•çš„ä¾‹å­æ˜¯ <code>/home/user/static</code>ã€‚
<pre><code>"staticPath": "/home/user/static",
</code></pre>
</li>
<li>ä½¿ç”¨é è¨­çš„ç™»å…¥é é¢æ¨£æ¿ï¼Œå°‡ç¯„ä¾‹çš„è¨»è§£æ‰ï¼š
<pre><code>"templates": {      // Jinja2 template paths.
    //"login": "/home/user/rust/static/login.j2",
    //"grant": "/home/user/rust/static/grant.j2",
},
</code></pre>
</li>
<li>ä½¿ç”¨ <a href="https://github.com/bytebeamio/rumqtt"><strong>rumqttd</strong></a> è€Œé EMQXï¼š
<pre><code>"coremgr": {
  ...
  "mq": {
    "engine": {
      "amqp": "rabbitmq",
      "mqtt": "rumqttd",
    },
    ...
  },
  ...
},
</code></pre>
</li>
</ul>
<h2 id="è¨­å®šåˆå§‹è³‡æ–™"><a class="header" href="#è¨­å®šåˆå§‹è³‡æ–™">è¨­å®šåˆå§‹è³‡æ–™</a></h2>
<p>å…ˆé€²å…¥ MongoDB shellï¼š</p>
<pre><code class="language-shell">docker exec -it mongodb mongosh
</code></pre>
<p>åœ¨ MongoDB shell ä»‹é¢å»ºç«‹åŸºæœ¬è³‡æ–™ï¼š</p>
<pre><code>use test1

db.user.insertOne({
  userId: 'admin',
  account: 'admin',
  createdAt: new Date(),
  modifiedAt: new Date(),
  verifiedAt: new Date(),
  expiredAt: null,
  disabledAt: null,
  roles: {"admin":true,"dev":false},
  password: '27258772d876ffcef7ca2c75d6f4e6bcd81c203bd3e93c0791c736e5a2df4afa',
  salt: 'YsBsou2O',
  name: 'Admin',
  info: {}
})

db.client.insertOne({
  clientId: 'public',
  createdAt: new Date(),
  modifiedAt: new Date(),
  clientSecret: null,
  redirectUris: ['http://localhost:1080/auth/oauth2/redirect'],
  scopes: [],
  userId: 'dev',
  name: 'Public',
  imageUrl: null
})
</code></pre>
<p>æ¥è‘—æŒ‰å…©æ¬¡ <code>Ctrl+C</code> é›¢é–‹ã€‚</p>
<h2 id="é–‹å§‹ä½¿ç”¨"><a class="header" href="#é–‹å§‹ä½¿ç”¨">é–‹å§‹ä½¿ç”¨</a></h2>
<p>å•Ÿå‹• Sylvia-IoT coreï¼š</p>
<pre><code class="language-shell">./sylvia-iot-core -f config.json5
</code></pre>
<p>å¦‚æœç¨‹å¼æ²’æœ‰çµæŸï¼Œè¡¨ç¤ºå·²ç¶“å•Ÿå‹•æˆåŠŸäº† ğŸ˜Šã€‚</p>
<p>å¦å¤–é–‹ä¸€å€‹å‘½ä»¤åˆ—è¦–çª—ï¼Œä½¿ç”¨ CLI ç™»å…¥ï¼š</p>
<pre><code class="language-shell">./sylvia-iot-coremgr-cli -f config.json5 login -a admin -p admin
</code></pre>
<p>å°‡æœƒçœ‹åˆ°å¦‚ä¸‹çš„ç•«é¢ï¼ˆæ‚¨çœ‹åˆ°çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>$ ./sylvia-iot-coremgr-cli -f config.json5 login -a admin -p admin
{
  "access_token": "ef9cf7cfc645f9092b9af62666d903c5a8e4579ff6941b479c1d9c9b63b0b634",
  "refresh_token": "265983a08af706fbe2912ff2edb1750311d1b689e4dab3a83c4b494c4cf2d033",
  "token_type": "bearer",
  "expires_in": 3599
}
OK (146 ms)
</code></pre>
<p>Access token æœƒè‡ªå‹•è¢«ä¿ç•™åœ¨ <code>$HOME/.sylvia-iot-coremgr-cli.json</code> é€™å€‹æª”æ¡ˆä¸­ï¼ŒCLI æœƒä¾æ“šè£¡é¢çš„å…§å®¹ä¾†å­˜å– APIã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>./sylvia-iot-coremgr-cli help</code> æŸ¥è©¢æŒ‡ä»¤çš„ä½¿ç”¨æ–¹å¼ã€‚</p>
<h2 id="å»ºç«‹è³‡æº"><a class="header" href="#å»ºç«‹è³‡æº">å»ºç«‹è³‡æº</a></h2>
<p>ç‚ºäº†æ–¹ä¾¿ä½¿ç”¨ <a href="https://mosquitto.org/download/"><strong>mosquitto CLI</strong></a>ï¼Œé€™è£¡æˆ‘å€‘åˆ†åˆ¥ä»¥ä¸‹çš„å¯¦é«”ï¼š</p>
<ul>
<li>ä¸€å€‹å–®ä½ï¼Œå–®ä½ä»£ç¢¼æ˜¯ <strong>demo</strong></li>
<li>ä¸€å€‹ MQTT æ‡‰ç”¨ï¼Œæ‡‰ç”¨ä»£ç¢¼æ˜¯ <strong>test-app-mqtt</strong></li>
<li>ä¸€å€‹ MQTT ç¶²è·¯ï¼Œç¶²è·¯ä»£ç¢¼æ˜¯ <strong>test-net-mqtt</strong></li>
<li>ä¸€å€‹è£ç½®ï¼Œè£ç½®ç¶²è·¯ä½å€ç‚º <strong>01000461</strong></li>
<li>ä¸€å€‹è·¯ç”±ï¼Œå°‡è©²è£ç½®ç¶å®šçµ¦æ‡‰ç”¨</li>
</ul>
<p>éç¨‹æœƒéœ€è¦è®Šæ›´é€£ç·šå¯†ç¢¼ç‚º <strong>password</strong>ï¼ˆæ‚¨çœ‹åˆ°çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code class="language-shell">UNIT_ID=$(./sylvia-iot-coremgr-cli -f config.json5 unit add -c demo -o admin -n 'Demo' | jq -r .unitId)
APP_ID=$(./sylvia-iot-coremgr-cli -f config.json5 application add -c test-app-mqtt -u $UNIT_ID --host 'mqtt://localhost' -n 'TestApp-MQTT' | jq -r .applicationId)
NET_ID=$(./sylvia-iot-coremgr-cli -f config.json5 network add -c test-net-mqtt -u $UNIT_ID --host 'mqtt://localhost' -n 'TestNet-MQTT' | jq -r .networkId)
./sylvia-iot-coremgr-cli -f config.json5 application update -i $APP_ID -p password
./sylvia-iot-coremgr-cli -f config.json5 network update -i $NET_ID -p password
DEV_ID=$(./sylvia-iot-coremgr-cli -f config.json5 device add -u $UNIT_ID --netid $NET_ID -a 01000461 -n 01000461 | jq -r .deviceId)
./sylvia-iot-coremgr-cli -f config.json5 device-route add -d $DEV_ID -a $APP_ID
</code></pre>
<h2 id="ä¸Šå‚³è£ç½®è³‡æ–™"><a class="header" href="#ä¸Šå‚³è£ç½®è³‡æ–™">ä¸Šå‚³è£ç½®è³‡æ–™</a></h2>
<p>å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤å®‰è£ mosquitto CLIï¼š</p>
<pre><code class="language-shell">sudo apt -y install mosquitto-clients
</code></pre>
<p>é–‹å•Ÿä¸€å€‹ shell è¨‚é–±æ‡‰ç”¨ä¸»é¡Œï¼ˆæ ¼å¼ç‚º <code>broker.application.[å–®ä½ä»£ç¢¼].[æ‡‰ç”¨ä»£ç¢¼].uldata</code>ï¼‰ï¼š</p>
<pre><code class="language-shell">mosquitto_sub -u test-app-mqtt -P password -t broker.application.demo.test-app-mqtt.uldata
</code></pre>
<p>é–‹å•Ÿå¦ä¸€å€‹ shell æ¨¡æ“¬ç¶²è·¯ç³»çµ±å‚³é€è£ç½®è³‡æ–™ï¼ˆä¸»é¡Œæ ¼å¼ç‚º <code>broker.network.[å–®ä½ä»£ç¢¼].[ç¶²è·¯ä»£ç¢¼].uldata</code>ï¼‰ï¼š</p>
<pre><code class="language-shell">mosquitto_pub -u test-net-mqtt -P password -t broker.network.demo.test-net-mqtt.uldata -m '{"time":"2023-07-08T06:55:02.000Z","networkAddr":"01000461","data":"74657374"}'
</code></pre>
<p>é€™æ™‚æ‚¨æ‡‰è©²æœƒåœ¨è¨‚é–±çš„ shell çœ‹åˆ°å¦‚ä¸‹ç•«é¢ï¼ˆå…§å®¹å¯èƒ½æœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>$ mosquitto_sub -u test-app-mqtt -P password -t broker.application.demo.test-app-mqtt.uldata
{"dataId":"1688799672075-iJ4YQeQ5Lyv4","time":"2023-07-08T06:55:02.000Z","pub":"2023-07-08T07:01:12.075Z","deviceId":"1688798563252-aWcZVRML","networkId":"1688798370824-RwAbBDFh","networkCode":"test-net-mqtt","networkAddr":"01000461","isPublic":true,"profile":"","data":"74657374"}
</code></pre>
<p>å¦‚æœæœ‰çœ‹åˆ°è³‡æ–™ï¼Œæ­å–œæ‚¨å®ŒæˆåŸºæœ¬çš„ Sylvia-IoT çš„ä½¿ç”¨äº†ï¼ˆæ­å–œä½ è§£é–æˆå°± ğŸ˜†ï¼‰ï¼</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¨­å®šæª”"><a class="header" href="#è¨­å®šæª”">è¨­å®šæª”</a></h1>
<p>æœ¬ç« ç¯€æè¿° Sylvia-IoT çš„è¨­å®šæ ¼å¼å’Œç”¨é€”ã€‚</p>
<p>Sylvia-IoT çš„è¨­å®šæ”¯æ´å››ç¨®ä¾†æºï¼Œå„ªå…ˆæ¬Šä¾åºç‚ºï¼ˆé«˜åˆ°ä½ï¼‰ï¼š</p>
<ul>
<li>JSON5 è¨­å®šæª”</li>
<li>å‘½ä»¤åˆ—åƒæ•¸</li>
<li>ç’°å¢ƒè®Šæ•¸</li>
<li>å…§éƒ¨é è¨­å€¼ï¼ˆä¸ä¸€å®šå­˜åœ¨ï¼Œå¦‚ç‚ºå¿…å¡«ä¸”ä¸æä¾›å‰‡æœƒæœ‰éŒ¯èª¤è¨Šæ¯ï¼‰</li>
</ul>
<p>JSON5 å¯ä»¥åƒè€ƒç¯„ä¾‹æª”æ¡ˆï¼Œè©²æª”æ¡ˆæä¾›äº†å®Œæ•´çš„è¨­å®šé …ç›®ã€‚
æœ¬ç« ç¯€å°‡æœƒæä¾›å°æ‡‰çš„èªªæ˜ã€‚ä»¥ä¸‹ç‚ºè¨­å®šçš„æ…£ä¾‹ï¼š</p>
<ul>
<li>JSON5 çš„å·¢ç‹€å½¢å¼æœƒä»¥ <code>.</code> ä¾†è¡¨ç¤ºã€‚</li>
<li>å‘½ä»¤åˆ—åƒæ•¸é‡åˆ° JSON5 çš„å·¢ç‹€æœƒä»¥ <code>.</code> ä¾†è¡¨ç¤ºã€‚</li>
<li>å‘½ä»¤åˆ—åƒæ•¸é‡åˆ° JSON5 ç‚ºé§å³°çš„æƒ…å½¢ï¼Œæœƒä»¥å…¨å°å¯«æˆ–æ˜¯ <code>-</code> å°¾éš¨å°å¯«ä¾†è¡¨ç¤ºã€‚ä»¥ä¸‹ç‚ºä¾‹å­ï¼š
<ul>
<li>JSON5 çš„ <code>server.httpPort</code> å°æ‡‰ <code>--server.httpport</code>ã€‚</li>
<li>JSON5 çš„ <code>broker.mqChannels</code> å°æ‡‰ <code>--broker.mq-channels</code>ã€‚</li>
</ul>
</li>
<li>ç’°å¢ƒè®Šæ•¸å…¨å¤§å¯«ã€‚</li>
<li>ç’°å¢ƒè®Šæ•¸é‡åˆ° JSON5 çš„å·¢ç‹€æœƒä»¥ <code>_</code> ä¾†è¡¨ç¤ºã€‚</li>
<li>ç’°å¢ƒè®Šæ•¸é‡åˆ° JSON5 ç‚ºé§å³°çš„æƒ…å½¢ï¼Œæœƒä»¥å…¨å¤§å¯«æˆ–æ˜¯ <code>_</code> åˆ†é–‹ä¾†è¡¨ç¤ºã€‚ä»¥ä¸‹ç‚ºä¾‹å­ï¼š
<ul>
<li>JSON5 çš„ <code>server.httpPort</code> å°æ‡‰ <code>SERVER_HTTP_PORT</code></li>
<li>JSON5 çš„ <code>broker.mqChannels</code> å°æ‡‰ <code>BROKER_MQCHANNELS</code></li>
</ul>
</li>
</ul>
<p>æ¥ä¸‹ä¾†æ˜¯å®Œæ•´çš„è¡¨æ ¼èªªæ˜ã€‚</p>
<blockquote>
<p>å¦‚æœ‰æ¨™ç¤º <strong>åƒç…§ç¯„ä¾‹</strong> è¡¨ç¤ºç¯„ä¾‹çš„ JSON5 æœ‰æä¾›ï¼Œæˆ–æ˜¯å¯ä»¥ä½¿ç”¨ CLI <strong>help</strong> æŒ‡ä»¤æŸ¥çœ‹æ”¯æ´çš„é¸é …ã€‚</p>
</blockquote>
<h2 id="å…±åŒè¨­å®š"><a class="header" href="#å…±åŒè¨­å®š">å…±åŒè¨­å®š</a></h2>
<div class="table-wrapper"><table><thead><tr><th>JSON5</th><th>å‘½ä»¤åˆ—åƒæ•¸</th><th>ç’°å¢ƒè®Šæ•¸</th><th>é è¨­å€¼</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td>log.level</td><td>log.level</td><td>LOG_LEVEL</td><td>info</td><td>Log ç­‰ç´šã€‚åƒç…§ç¯„ä¾‹</td></tr>
<tr><td>log.style</td><td>log.style</td><td>LOG_STYLE</td><td>json</td><td>Log æ¨£å¼ã€‚åƒç…§ç¯„ä¾‹</td></tr>
<tr><td>server.httpPort</td><td>log.httpport</td><td>SERVER_HTTP_PORT</td><td>1080</td><td>HTTP ç›£è½é€£æ¥åŸ </td></tr>
<tr><td>server.httpsPort</td><td>log.httpsport</td><td>SERVER_HTTPS_PORT</td><td>1443</td><td>HTTPS ç›£è½é€£æ¥åŸ </td></tr>
<tr><td>server.cacertFile</td><td>log.cacertfile</td><td>SERVER_CACERT_FILE</td><td></td><td>HTTPS æ ¹æ†‘è­‰æ“‹ä½ç½®</td></tr>
<tr><td>server.certFile</td><td>log.certfile</td><td>SERVER_CERT_FILE</td><td></td><td>HTTPS æ†‘è­‰æ“‹ä½ç½®</td></tr>
<tr><td>server.keyFile</td><td>log.keyfile</td><td>SERVER_KEY_FILE</td><td></td><td>HTTPS ç§é‘°ä½ç½®</td></tr>
<tr><td>server.staticPath</td><td>log.static</td><td>SERVER_STATIC_PATH</td><td></td><td>éœæ…‹æª”æ¡ˆç›®éŒ„ä½ç½®</td></tr>
</tbody></table>
</div>
<h3 id="è©³ç´°èªªæ˜"><a class="header" href="#è©³ç´°èªªæ˜">è©³ç´°èªªæ˜</a></h3>
<ul>
<li>ç›®å‰é‚„æœªä½¿ç”¨æ ¹æ†‘è­‰ã€‚</li>
<li>å¿…é ˆåŒæ™‚ä½¿ç”¨æ†‘è­‰å’Œç§é‘°æ‰èƒ½å•Ÿç”¨ HTTPS æœå‹™ã€‚</li>
</ul>
<h2 id="api-scopes"><a class="header" href="#api-scopes">API Scopes</a></h2>
<p>æ‰€æœ‰çš„ API éƒ½éœ€è¦é€éåœ¨ç³»çµ±è¨»å†Šçš„å®¢æˆ¶ç«¯ï¼ˆclientï¼‰ä»¥åŠè¨ªå•ä»¤ç‰Œï¼ˆaccess tokenï¼‰æ‰èƒ½å­˜å–ã€‚æ¯ä¸€å€‹ä»¤ç‰Œæœƒè¨˜éŒ„æ‰€å±¬çš„å®¢æˆ¶ç«¯ï¼Œåªæœ‰ç¶“éæˆæ¬Šçš„å®¢æˆ¶ç«¯æ‰èƒ½å­˜å– APIã€‚</p>
<p>ç•¶æŸå€‹ API å°æ‡‰çš„ <code>apiScopes</code> çš„è¨­å®šè¢«é–‹å•Ÿæ™‚ï¼Œé™¤éå®¢æˆ¶ç«¯åœ¨è¨»å†Šçš„æ™‚å€™æœ‰å•Ÿç”¨é€™äº› scope ä¸¦è¢«ä½¿ç”¨è€…æˆæ¬Šï¼Œå–å¾—çš„ä»¤ç‰Œæ‰èƒ½å­˜å–è©² APIã€‚</p>
<p>å‘½ä»¤åˆ—åƒæ•¸å’Œç’°å¢ƒè®Šæ•¸éƒ½è¦æ˜¯ JSON stringï¼Œèˆ‰ä¾‹ï¼š</p>
<pre><code>--auth.api-scopes='{"auth.tokeninfo.get":[]}'
</code></pre>
<p>æ‚¨å¯ä»¥è‡ªè¡Œå®šç¾© scope åç¨±ï¼Œä¸¦å¥—ç”¨åˆ°å„å€‹ API scope ä¸­ã€‚å¯ä»¥åƒè€ƒä¸‹é¢<strong>èªè­‰æœå‹™</strong>çš„ç¯„ä¾‹ã€‚</p>
<h2 id="èªè­‰æœå‹™auth"><a class="header" href="#èªè­‰æœå‹™auth">èªè­‰æœå‹™ï¼ˆauthï¼‰</a></h2>
<div class="table-wrapper"><table><thead><tr><th>JSON5</th><th>å‘½ä»¤åˆ—åƒæ•¸</th><th>ç’°å¢ƒè®Šæ•¸</th><th>é è¨­å€¼</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td>auth.db.engine</td><td>auth.db.engine</td><td>AUTH_DB_ENGINE</td><td>sqlite</td><td>ä½¿ç”¨çš„è³‡æ–™åº«ç¨®é¡</td></tr>
<tr><td>auth.db.mongodb.url</td><td>auth.db.mongodb.url</td><td>AUTH_DB_MONGODB_URL</td><td>mongodb://localhost:27017</td><td>MongoDB é€£ç·šçš„ URL</td></tr>
<tr><td>auth.db.mongodb.database</td><td>auth.db.mongodb.database</td><td>AUTH_DB_MONGODB_DATABASE</td><td>auth</td><td>MongoDB è³‡æ–™åº«åç¨±</td></tr>
<tr><td>auth.db.mongodb.poolSize</td><td>auth.db.mongodb.poolsize</td><td>AUTH_DB_MONGODB_POOLSIZE</td><td></td><td>MongoDB æœ€å¤§é€£ç·šæ•¸é‡</td></tr>
<tr><td>auth.db.sqlite.path</td><td>auth.db.sqlite.path</td><td>AUTH_DB_SQLITE_PATH</td><td>auth.db</td><td>SQLite æª”æ¡ˆä½ç½®</td></tr>
<tr><td>auth.db.templates.login</td><td>auth.db.templates</td><td>AUTH_TEMPLATES</td><td></td><td>ç™»å…¥é é¢æ¨£æ¿ä½å€</td></tr>
<tr><td>auth.db.templates.grant</td><td>auth.db.templates</td><td>AUTH_TEMPLATES</td><td></td><td>æˆæ¬Šé é¢æ¨£æ¿ä½å€</td></tr>
<tr><td>auth.db.apiScopes</td><td>auth.api-scopes</td><td>AUTH_API_SCOPES</td><td></td><td>API æ¬Šé™è¨­å®š</td></tr>
</tbody></table>
</div>
<h3 id="è©³ç´°èªªæ˜-1"><a class="header" href="#è©³ç´°èªªæ˜-1">è©³ç´°èªªæ˜</a></h3>
<ul>
<li>templatesï¼ˆæ¨£æ¿ï¼‰
<ul>
<li>ä½¿ç”¨ OAuth2 authorization code æˆæ¬Šæµç¨‹éœ€è¦ä½¿ç”¨çš„ç¶²é ã€‚<strong>sylvia-iot-auth</strong> æœ‰æä¾›é è¨­çš„é é¢ï¼Œè€Œ Sylvia-IoT å…è¨±æ‚¨è‡ªè¨‚ç¬¦åˆè‡ªå·±é¢¨æ ¼çš„ç¶²é ã€‚</li>
<li>æ¨£æ¿ä½¿ç”¨ Jinja2 æ ¼å¼ï¼ˆç›¸ä¾ <a href="https://tera.netlify.app/"><strong>tera</strong></a> å¥—ä»¶ï¼‰ã€‚</li>
<li>å‘½ä»¤åˆ—åƒæ•¸å’Œç’°å¢ƒè®Šæ•¸éƒ½è¦ç”¨ JSON stringï¼Œæ¯”å¦‚
<pre><code>--auth.templates='{"login":"xxx"}'
</code></pre>
</li>
<li>è©³ç´°èªªæ˜è«‹åƒè€ƒ <a href="guide/../dev/oauth2.html"><strong>OAuth2 èªè­‰</strong></a>ã€‚</li>
</ul>
</li>
<li>API scopes
<ul>
<li><strong>auth</strong> æ¨¡çµ„æä¾›äº†ä»¥ä¸‹å¹¾å€‹ scope å¯ä¾›è¨­å®šçµ¦å°æ‡‰çš„ APIï¼Œé™åˆ¶ client å¯ä»¥å­˜å–çš„ç¯„åœï¼š
<ul>
<li><code>auth.tokeninfo.get</code>: æˆæ¬Š client è®€å–ä»¤ç‰Œçš„è³‡æ–™ã€‚
<ul>
<li><code>GET /api/v1/auth/tokeninfo</code></li>
</ul>
</li>
<li><code>auth.logout.post</code>: æˆæ¬Š client å°‡ä»¤ç‰Œç™»å‡ºã€‚
<ul>
<li><code>POST /auth/api/v1/auth/logout</code></li>
</ul>
</li>
<li><code>user.get</code>: æˆæ¬Š client å­˜å–ç›®å‰ä½¿ç”¨è€…çš„å€‹äººè³‡æ–™ã€‚
<ul>
<li><code>GET /api/v1/user</code></li>
</ul>
</li>
<li><code>user.path</code>: æˆæ¬Š client ä¿®æ”¹ç›®å‰ä½¿ç”¨è€…çš„å€‹äººè³‡æ–™ã€‚
<ul>
<li><code>PATCH /api/v1/user</code></li>
</ul>
</li>
<li><code>user.get.admin</code>: æˆæ¬Š client å–å¾—ç³»çµ±æ‰€æœ‰ä½¿ç”¨è€…çš„è³‡æ–™ã€‚
<ul>
<li><code>GET /api/v1/user/count</code></li>
<li><code>GET /api/v1/user/list</code></li>
<li><code>GET /api/v1/user/{userId}</code></li>
</ul>
</li>
<li><code>user.post.admin</code>: æˆæ¬Š client åœ¨ç³»çµ±å»ºç«‹æ–°çš„ä½¿ç”¨è€…ã€‚
<ul>
<li><code>POST /api/v1/user</code></li>
</ul>
</li>
<li><code>user.patch.admin</code>: æˆæ¬Š client ä¿®æ”¹ç³»çµ±ä»»æ„ä½¿ç”¨è€…çš„è³‡æ–™ã€‚
<ul>
<li><code>PATCH /api/v1/user/{userId}</code></li>
</ul>
</li>
<li><code>user.delete.admin</code>: æˆæ¬Š client åˆªé™¤ç³»çµ±ä»»æ„ä½¿ç”¨è€…çš„è³‡æ–™ã€‚
<ul>
<li><code>DELETE /api/v1/user/{userId}</code></li>
</ul>
</li>
<li><code>client.get</code>: æˆæ¬Š client å­˜å–å¾—ç³»çµ±æ‰€æœ‰å®¢æˆ¶ç«¯è³‡æ–™ã€‚
<ul>
<li><code>GET /api/v1/client/count</code></li>
<li><code>GET /api/v1/client/list</code></li>
<li><code>GET /api/v1/client/{clientId}</code></li>
</ul>
</li>
<li><code>client.post</code>: æˆæ¬Š client åœ¨ç³»çµ±å»ºç«‹æ–°çš„å®¢æˆ¶ç«¯ã€‚
<ul>
<li><code>POST /api/v1/client</code></li>
</ul>
</li>
<li><code>client.patch</code>: æˆæ¬Š client ä¿®æ”¹ç³»çµ±ä»»æ„å®¢æˆ¶ç«¯çš„è³‡æ–™ã€‚
<ul>
<li><code>PATCH /api/v1/client/{clientId}</code></li>
</ul>
</li>
<li><code>client.delete</code>: æˆæ¬Š client åˆªé™¤ç³»çµ±ä»»æ„å®¢æˆ¶ç«¯çš„è³‡æ–™ã€‚
<ul>
<li><code>DELETE /api/v1/client/{clientId}</code></li>
</ul>
</li>
<li><code>client.delete.user</code>: æˆæ¬Š client åˆªé™¤ç³»çµ±ä»»æ„ä½¿ç”¨è€…çš„æ‰€æœ‰å®¢æˆ¶ç«¯ã€‚
<ul>
<li><code>DELETE /api/v1/client/user/{userId}</code></li>
</ul>
</li>
</ul>
</li>
<li>èˆ‰ä¾‹ï¼Œåœ¨æ‚¨çš„æœå‹™å®šç¾©å¦‚ä¸‹çš„ scopeï¼š
<ul>
<li><code>api.admin</code>: åƒ…èƒ½æˆæ¬Šç§»é™¤ä½¿ç”¨è€…çš„æ‰€æœ‰å®¢æˆ¶ç«¯ã€‚</li>
<li><code>api.rw</code>: å¯ä»¥è®€å¯«é™¤äº† <code>DELETE /api/v1/client/user/{userId}</code> çš„æ‰€æœ‰ APIã€‚</li>
<li><code>api.readonly</code>ï¼š åªèƒ½å­˜å– GET APIã€‚</li>
<li>å–å¾—ä»¤ç‰Œè³‡æ–™å’Œç™»å‡ºï¼Œé€™å…©å€‹å‹•ä½œé–‹æ”¾æ‰€æœ‰å®¢æˆ¶ç«¯å¯ä»¥ä½¿ç”¨ã€‚</li>
</ul>
<pre><code>"auth": {
    ...
    "apiScopes": {
        "auth.tokeninfo.get": [],
        "auth.logout.post": [],
        "user.get": ["api.rw", "api.readonly"],
        "user.patch": ["api.rw"],
        "user.post.admin": ["api.rw"],
        "user.get.admin": ["api.rw", "api.readonly"],
        "user.patch.admin": ["api.rw"],
        "user.delete.admin": ["api.rw"],
        "client.post": ["api.rw"],
        "client.get": ["api.rw", "api.readonly"],
        "client.patch": ["api.rw"],
        "client.delete": ["api.rw"],
        "client.delete.user": ["api.admin"],
    },
    ...
}
</code></pre>
<ul>
<li>ä»¥é€™å€‹ä¾‹å­ï¼Œè¨»å†Šçš„å®¢æˆ¶ç«¯å¯ä»¥ä»»æ„å‹¾é¸é€™ä¸‰ç¨® scopeã€‚ä¹‹å¾Œä½¿ç”¨è€…æœƒåœ¨æˆæ¬Šé é¢å¾—çŸ¥é€™äº›è¨Šæ¯ï¼Œä¸¦ä¸”æ±ºå®šæ˜¯å¦æˆæ¬Šå®¢æˆ¶ç«¯ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="æ¶ˆæ¯ä»£ç†æœå‹™broker"><a class="header" href="#æ¶ˆæ¯ä»£ç†æœå‹™broker">æ¶ˆæ¯ä»£ç†æœå‹™ï¼ˆbrokerï¼‰</a></h2>
<div class="table-wrapper"><table><thead><tr><th>JSON5</th><th>å‘½ä»¤åˆ—åƒæ•¸</th><th>ç’°å¢ƒè®Šæ•¸</th><th>é è¨­å€¼</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td>broker.auth</td><td>broker.auth</td><td>BROKER_AUTH</td><td>http://localhost:1080/auth</td><td>èªè­‰æœå‹™ä½å€</td></tr>
<tr><td>broker.db.engine</td><td>broker.db.engine</td><td>BROKER_DB_ENGINE</td><td>sqlite</td><td>ä½¿ç”¨çš„è³‡æ–™åº«ç¨®é¡</td></tr>
<tr><td>broker.db.mongodb.url</td><td>broker.db.mongodb.url</td><td>BROKER_DB_MONGODB_URL</td><td>mongodb://localhost:27017</td><td>MongoDB é€£ç·šçš„ URL</td></tr>
<tr><td>broker.db.mongodb.database</td><td>broker.db.mongodb.database</td><td>BROKER_DB_MONGODB_DATABASE</td><td>auth</td><td>MongoDB è³‡æ–™åº«åç¨±</td></tr>
<tr><td>broker.db.mongodb.poolSize</td><td>broker.db.mongodb.poolsize</td><td>BROKER_DB_MONGODB_POOLSIZE</td><td></td><td>MongoDB æœ€å¤§é€£ç·šæ•¸é‡</td></tr>
<tr><td>broker.db.sqlite.path</td><td>broker.db.sqlite.path</td><td>BROKER_DB_SQLITE_PATH</td><td>auth.db</td><td>SQLite æª”æ¡ˆä½ç½®</td></tr>
<tr><td>broker.cache.engine</td><td>broker.cache.engine</td><td>BROKER_CACHE_ENGINE</td><td>none</td><td>ä½¿ç”¨çš„å¿«å–ç¨®é¡</td></tr>
<tr><td>broker.cache.memory.device</td><td>broker.cache.memory.device</td><td>BROKER_CACHE_MEMORY_DEVICE</td><td>1,000,000</td><td>Memory å°è£ç½®çš„å¿«å–æ•¸é‡</td></tr>
<tr><td>broker.cache.memory.deviceRoute</td><td>broker.cache.memory.device-route</td><td>BROKER_CACHE_MEMORY_DEVICE_ROUTE</td><td>1,000,000</td><td>Memory å°è£ç½®è·¯ç”±çš„å¿«å–æ•¸é‡</td></tr>
<tr><td>broker.cache.memory.networkRoute</td><td>broker.cache.memory.network-route</td><td>BROKER_CACHE_MEMORY_NETWORK_ROUTE</td><td>1,000,000</td><td>Memory å°ç¶²è·¯è·¯ç”±çš„å¿«å–æ•¸é‡</td></tr>
<tr><td>broker.mq.prefetch</td><td>broker.mq.prefetch</td><td>BROKER_MQ_PREFETCH</td><td>100</td><td>AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mq.persistent</td><td>broker.mq.persistent</td><td>BROKER_MQ_PERSISTENT</td><td>false</td><td>AMQP ç”¢ç”Ÿè€…ä½¿ç”¨æŒä¹…æ€§å‚³é€</td></tr>
<tr><td>broker.mq.sharedPrefix</td><td>broker.mq.sharedprefix</td><td>BROKER_MQ_SHAREDPREFIX</td><td>$share/sylvia-iot-broker/</td><td>MQTT shared subscription çš„å‰ç¶´</td></tr>
<tr><td>broker.mqChannels.unit.url</td><td>broker.mq-channels.unit.url</td><td>BROKER_MQCHANNELS_UNIT_URL</td><td>amqp://localhost</td><td>å–®ä½çš„æ§åˆ¶è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.unit.prefetch</td><td>broker.mq-channels.unit.prefetch</td><td>BROKER_MQCHANNELS_UNIT_PREFETCH</td><td>100</td><td>å–®ä½çš„æ§åˆ¶è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mqChannels.application.url</td><td>broker.mq-channels.application.url</td><td>BROKER_MQCHANNELS_APPLICATION_URL</td><td>amqp://localhost</td><td>æ‡‰ç”¨çš„æ§åˆ¶è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.application.prefetch</td><td>broker.mq-channels.application.prefetch</td><td>BROKER_MQCHANNELS_APPLICATION_PREFETCH</td><td>100</td><td>æ‡‰ç”¨çš„æ§åˆ¶è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mqChannels.network.url</td><td>broker.mq-channels.network.url</td><td>BROKER_MQCHANNELS_NETWORK_URL</td><td>amqp://localhost</td><td>å–®ä½çš„æ§åˆ¶è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.network.prefetch</td><td>broker.mq-channels.network.prefetch</td><td>BROKER_MQCHANNELS_NETWORK_PREFETCH</td><td>100</td><td>å–®ä½çš„æ§åˆ¶è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mqChannels.device.url</td><td>broker.mq-channels.device.url</td><td>BROKER_MQCHANNELS_DEVICE_URL</td><td>amqp://localhost</td><td>è£ç½®çš„æ§åˆ¶è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.device.prefetch</td><td>broker.mq-channels.device.prefetch</td><td>BROKER_MQCHANNELS_DEVICE_PREFETCH</td><td>100</td><td>è£ç½®çš„æ§åˆ¶è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mqChannels.deviceRoute.url</td><td>broker.mq-channels.device-route.url</td><td>BROKER_MQCHANNELS_DEVICE_ROUTE_URL</td><td>amqp://localhost</td><td>è£ç½®è·¯ç”±çš„æ§åˆ¶è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.deviceRoute.prefetch</td><td>broker.mq-channels.device-route.prefetch</td><td>BROKER_MQCHANNELS_DEVICE_ROUTE_PREFETCH</td><td>100</td><td>è£ç½®è·¯ç”±çš„æ§åˆ¶è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mqChannels.networkRoute.url</td><td>broker.mq-channels.network-route.url</td><td>BROKER_MQCHANNELS_NETWORK_ROUTE_URL</td><td>amqp://localhost</td><td>ç¶²è·¯è·¯ç”±çš„æ§åˆ¶è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.networkRoute.prefetch</td><td>broker.mq-channels.network-route.prefetch</td><td>BROKER_MQCHANNELS_NETWORK_ROUTE_PREFETCH</td><td>100</td><td>ç¶²è·¯è·¯ç”±çš„æ§åˆ¶è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>broker.mqChannels.data.url</td><td>broker.mq-channels.data.url</td><td>BROKER_MQCHANNELS_DATA_URL</td><td></td><td>è³‡æ–™è¨Šæ¯ä½å€</td></tr>
<tr><td>broker.mqChannels.data.persistent</td><td>broker.mq-channels.data.persistent</td><td>BROKER_MQCHANNELS_DATA_PERSISTENT</td><td>false</td><td>è³‡æ–™è¨Šæ¯ä½¿ç”¨æŒä¹…æ€§å‚³é€</td></tr>
<tr><td>broker.db.apiScopes</td><td>broker.api-scopes</td><td>BROKER_API_SCOPES</td><td></td><td>API æ¬Šé™è¨­å®š</td></tr>
</tbody></table>
</div>
<h3 id="è©³ç´°èªªæ˜-2"><a class="header" href="#è©³ç´°èªªæ˜-2">è©³ç´°èªªæ˜</a></h3>
<ul>
<li>
<p>æŒ‡å®šèªè­‰æœå‹™ä½å€ï¼ˆ<code>broker.auth</code>ï¼‰çš„ç”¨æ„åœ¨æª¢æŸ¥å‘¼å« API çš„ä»¤ç‰Œçš„åˆæ³•æ€§ï¼ŒåŒ…å«ä½¿ç”¨è€…å¸³è™Ÿèˆ‡å®¢æˆ¶ç«¯ã€‚</p>
</li>
<li>
<p>MQ channels:</p>
<ul>
<li>ç”±æ–¼ Sylvia-IoT è¨Šæ¯ä»£ç†æœå‹™æ˜¯æ±ºå®šæ•ˆèƒ½çš„é—œéµæ¨¡çµ„ï¼Œæœƒå°‡è¨±å¤šè¨­å®šæ”¾åœ¨è¨˜æ†¶é«”ä¸­ã€‚é€™äº›è¨­å®šéœ€è¦é€é <strong>æ§åˆ¶è¨Šæ¯ï¼ˆcontrol channel messageï¼‰</strong> å°‡ API è®Šæ›´çš„å…§å®¹é€éè¨Šæ¯ä½‡åˆ—å‚³éåˆ°å¢é›†çš„å„å€‹åŸ·è¡Œå€‹é«”ä¸­ã€‚
<ul>
<li>ç›¸é—œè¨Šæ¯è«‹è¦‹ <a href="guide/../arch/cache.html"><strong>å¿«å–</strong></a> ç« ç¯€ã€‚</li>
</ul>
</li>
<li><strong>data</strong> æ˜¯ <strong>è³‡æ–™è¨Šæ¯ï¼ˆdata channel messageï¼‰</strong>ï¼Œå°‡æ‰€æœ‰è³‡æ–™è¨˜éŒ„åˆ° <strong>sylvia-iot-data</strong> æ¨¡çµ„ä¸­ã€‚
<ul>
<li>ä¸æŒ‡å®šåƒæ•¸ï¼ˆæˆ–æ˜¯ JSON5 è¨­å®š <strong>null</strong>ï¼‰å°±æœƒä¸å„²å­˜ä»»ä½•è³‡æ–™ã€‚</li>
<li>ç›¸é—œè¨Šæ¯è«‹è¦‹ <a href="guide/../arch/flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>API scopes: è«‹åƒè€ƒ<strong>èªè­‰æœå‹™</strong>çš„èªªæ˜ã€‚</p>
</li>
</ul>
<h2 id="æ ¸å¿ƒç®¡ç†æœå‹™coremgr"><a class="header" href="#æ ¸å¿ƒç®¡ç†æœå‹™coremgr">æ ¸å¿ƒç®¡ç†æœå‹™ï¼ˆcoremgrï¼‰</a></h2>
<div class="table-wrapper"><table><thead><tr><th>JSON5</th><th>å‘½ä»¤åˆ—åƒæ•¸</th><th>ç’°å¢ƒè®Šæ•¸</th><th>é è¨­å€¼</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td>coremgr.auth</td><td>coremgr.auth</td><td>COREMGR_AUTH</td><td>http://localhost:1080/auth</td><td>èªè­‰æœå‹™ä½å€</td></tr>
<tr><td>coremgr.broker</td><td>coremgr.broker</td><td>COREMGR_BROKER</td><td>http://localhost:2080/broker</td><td>è¨Šæ¯ä»£ç†æœå‹™ä½å€</td></tr>
<tr><td>coremgr.mq.engine.amqp</td><td>coremgr.mq.engine.amqp</td><td>COREMGR_MQ_ENGINE_AMQP</td><td>rabbitmq</td><td>AMQP ç¨®é¡</td></tr>
<tr><td>coremgr.mq.engine.mqtt</td><td>coremgr.mq.engine.mqtt</td><td>COREMGR_MQ_ENGINE_MQTT</td><td>emqx</td><td>MQTT ç¨®é¡</td></tr>
<tr><td>coremgr.mq.rabbitmq.username</td><td>coremgr.mq.rabbitmq.username</td><td>COREMGR_MQ_RABBITMQ_USERNAME</td><td>guest</td><td>RabbitMQ ç®¡ç†è€…å¸³è™Ÿ</td></tr>
<tr><td>coremgr.mq.rabbitmq.password</td><td>coremgr.mq.rabbitmq.password</td><td>COREMGR_MQ_RABBITMQ_PASSWORD</td><td>guest</td><td>RabbitMQ ç®¡ç†è€…å¯†ç¢¼</td></tr>
<tr><td>coremgr.mq.rabbitmq.ttl</td><td>coremgr.mq.rabbitmq.ttl</td><td>COREMGR_MQ_RABBITMQ_TTL</td><td></td><td>RabbitMQ é è¨­ä½‡åˆ—è¨Šæ¯å­˜æ´»é•·åº¦ï¼ˆç§’ï¼‰</td></tr>
<tr><td>coremgr.mq.rabbitmq.length</td><td>coremgr.mq.rabbitmq.length</td><td>COREMGR_MQ_RABBITMQ_LENGTH</td><td></td><td>RabbitMQ é è¨­ä½‡åˆ—è¨Šæ¯æœ€å¤šå€‹æ•¸</td></tr>
<tr><td>coremgr.mq.rabbitmq.hosts</td><td>coremgr.mq.rabbitmq.hosts</td><td>COREMGR_MQ_RABBITMQ_HOSTS</td><td></td><td>ï¼ˆä¿ç•™ï¼‰</td></tr>
<tr><td>coremgr.mq.emqx.apiKey</td><td>coremgr.mq.emqx.apikey</td><td>COREMGR_MQ_EMQX_APIKEY</td><td></td><td>EMQX ç®¡ç† API key</td></tr>
<tr><td>coremgr.mq.emqx.apiSecret</td><td>coremgr.mq.emqx.apisecret</td><td>COREMGR_MQ_EMQX_APISECRET</td><td></td><td>EMQX ç®¡ç† API secret</td></tr>
<tr><td>coremgr.mq.emqx.hosts</td><td>coremgr.mq.emqx.hosts</td><td>COREMGR_MQ_EMQX_HOSTS</td><td></td><td>ï¼ˆä¿ç•™ï¼‰</td></tr>
<tr><td>coremgr.mq.rumqttd.mqttPort</td><td>coremgr.mq.rumqttd.mqtt-port</td><td>COREMGR_MQ_RUMQTTD_MQTT_PORT</td><td>1883</td><td>rumqttd MQTT é€£æ¥åŸ </td></tr>
<tr><td>coremgr.mq.rumqttd.mqttsPort</td><td>coremgr.mq.rumqttd.mqtts-port</td><td>COREMGR_MQ_RUMQTTD_MQTTS_PORT</td><td>8883</td><td>rumqttd MQTTS é€£æ¥åŸ </td></tr>
<tr><td>coremgr.mq.rumqttd.consolePort</td><td>coremgr.mq.rumqttd.console-port</td><td>COREMGR_MQ_RUMQTTD_CONSOLE_PORT</td><td>18083</td><td>rumqttd ç®¡ç† API é€£æ¥åŸ </td></tr>
<tr><td>coremgr.mqChannels.data.url</td><td>coremgr.mq-channels.data.url</td><td>COREMGR_MQCHANNELS_DATA_URL</td><td></td><td>è³‡æ–™è¨Šæ¯ä½å€</td></tr>
<tr><td>coremgr.mqChannels.data.persistent</td><td>coremgr.mq-channels.data.persistent</td><td>COREMGR_MQCHANNELS_DATA_PERSISTENT</td><td>false</td><td>è³‡æ–™è¨Šæ¯ä½¿ç”¨æŒä¹…æ€§å‚³é€</td></tr>
</tbody></table>
</div>
<h3 id="è©³ç´°èªªæ˜-3"><a class="header" href="#è©³ç´°èªªæ˜-3">è©³ç´°èªªæ˜</a></h3>
<ul>
<li>MQ channels:
<ul>
<li><strong>data</strong> æ˜¯ <strong>è³‡æ–™è¨Šæ¯ï¼ˆdata channel messageï¼‰</strong>
<ul>
<li>ç›®å‰ coremgr æ”¯æ´ç´€éŒ„ GET API ä»¥å¤–çš„ HTTP è«‹æ±‚å…§å®¹ï¼Œé–‹å•Ÿè³‡æ–™é€šé“å³å¯ç´€éŒ„ API ä½¿ç”¨æ­·ç¨‹ã€‚</li>
<li>ä¸æŒ‡å®šåƒæ•¸ï¼ˆæˆ–æ˜¯ JSON5 è¨­å®š <strong>null</strong>ï¼‰å°±æœƒä¸å„²å­˜ä»»ä½•è³‡æ–™ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="æ ¸å¿ƒç®¡ç†æœå‹™ç®¡ç†ä»‹é¢coremgr-cli"><a class="header" href="#æ ¸å¿ƒç®¡ç†æœå‹™ç®¡ç†ä»‹é¢coremgr-cli">æ ¸å¿ƒç®¡ç†æœå‹™ç®¡ç†ä»‹é¢ï¼ˆcoremgr-cliï¼‰</a></h2>
<div class="table-wrapper"><table><thead><tr><th>JSON5</th><th>å‘½ä»¤åˆ—åƒæ•¸</th><th>ç’°å¢ƒè®Šæ•¸</th><th>é è¨­å€¼</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td>coremgrCli.auth</td><td>coremgr-cli.auth</td><td>COREMGRCLI_AUTH</td><td>http://localhost:1080/auth</td><td>èªè­‰æœå‹™ä½å€</td></tr>
<tr><td>coremgrCli.coremgr</td><td>coremgr-cli.coremgr</td><td>COREMGRCLI_COREMGR</td><td>http://localhost:3080/coremgr</td><td>æ ¸å¿ƒç®¡ç†æœå‹™ä½å€</td></tr>
<tr><td>coremgrCli.data</td><td>coremgr-cli.data</td><td>COREMGRCLI_DATA</td><td>http://localhost:4080/data</td><td>è³‡æ–™æœå‹™ä½å€</td></tr>
<tr><td>coremgrCli.clientId</td><td>coremgr-cli.client-id</td><td>COREMGRCLI_CLIENT_ID</td><td></td><td>å‘½ä»¤åˆ—å®¢æˆ¶ç«¯ ID</td></tr>
<tr><td>coremgrCli.redirectUri</td><td>coremgr-cli.redirect-uri</td><td>COREMGRCLI_REDIRECT_URI</td><td></td><td>å‘½ä»¤åˆ—å®¢æˆ¶ç«¯é‡è½‰å‘ç¶²å€</td></tr>
</tbody></table>
</div>
<h2 id="è³‡æ–™æœå‹™data"><a class="header" href="#è³‡æ–™æœå‹™data">è³‡æ–™æœå‹™ï¼ˆdataï¼‰</a></h2>
<div class="table-wrapper"><table><thead><tr><th>JSON5</th><th>å‘½ä»¤åˆ—åƒæ•¸</th><th>ç’°å¢ƒè®Šæ•¸</th><th>é è¨­å€¼</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td>data.auth</td><td>data.auth</td><td>DATA_AUTH</td><td>http://localhost:1080/auth</td><td>èªè­‰æœå‹™ä½å€</td></tr>
<tr><td>data.broker</td><td>data.broker</td><td>DATA_BROKER</td><td>http://localhost:2080/broker</td><td>è¨Šæ¯ä»£ç†æœå‹™ä½å€</td></tr>
<tr><td>data.db.engine</td><td>data.db.engine</td><td>DATA_DB_ENGINE</td><td>sqlite</td><td>ä½¿ç”¨çš„è³‡æ–™åº«ç¨®é¡</td></tr>
<tr><td>data.db.mongodb.url</td><td>data.db.mongodb.url</td><td>DATA_DB_MONGODB_URL</td><td>mongodb://localhost:27017</td><td>MongoDB é€£ç·šçš„ URL</td></tr>
<tr><td>data.db.mongodb.database</td><td>data.db.mongodb.database</td><td>DATA_DB_MONGODB_DATABASE</td><td>data</td><td>MongoDB è³‡æ–™åº«åç¨±</td></tr>
<tr><td>data.db.mongodb.poolSize</td><td>data.db.mongodb.poolsize</td><td>DATA_DB_MONGODB_POOLSIZE</td><td></td><td>MongoDB æœ€å¤§é€£ç·šæ•¸é‡</td></tr>
<tr><td>data.db.sqlite.path</td><td>data.db.sqlite.path</td><td>DATA_DB_SQLITE_PATH</td><td>data.db</td><td>SQLite æª”æ¡ˆä½ç½®</td></tr>
<tr><td>data.mqChannels.broker.url</td><td>data.mq-channels.broker.url</td><td>DATA_MQCHANNELS_BROKER_URL</td><td>amqp://localhost</td><td>è³‡æ–™è¨Šæ¯ä½å€</td></tr>
<tr><td>data.mqChannels.broker.prefetch</td><td>data.mq-channels.broker.prefetch</td><td>DATA_MQCHANNELS_BROKER_PREFETCH</td><td>100</td><td>è³‡æ–™è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>data.mqChannels.broker.sharedPrefix</td><td>data.mq-channels.broker.sharedprefix</td><td>DATA_MQCHANNELS_BROKER_SHAREDPREFIX</td><td>$share/sylvia-iot-data/</td><td>MQTT shared subscription çš„å‰ç¶´</td></tr>
<tr><td>data.mqChannels.coremgr.url</td><td>data.mq-channels.coremgr.url</td><td>DATA_MQCHANNELS_COREMGR_URL</td><td>amqp://localhost</td><td>è³‡æ–™è¨Šæ¯ä½å€</td></tr>
<tr><td>data.mqChannels.coremgr.prefetch</td><td>data.mq-channels.coremgr.prefetch</td><td>DATA_MQCHANNELS_COREMGR_PREFETCH</td><td>100</td><td>è³‡æ–™è¨Šæ¯ AMQP æ¶ˆè²»è€…æœ€å¤§åŒæ™‚æ¶ˆè²»çš„æ•¸é‡</td></tr>
<tr><td>data.mqChannels.coremgr.sharedPrefix</td><td>data.mq-channels.coremgr.sharedprefix</td><td>DATA_MQCHANNELS_COREMGR_SHAREDPREFIX</td><td>$share/sylvia-iot-data/</td><td>MQTT shared subscription çš„å‰ç¶´</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="å…§éƒ¨æ¶æ§‹"><a class="header" href="#å…§éƒ¨æ¶æ§‹">å…§éƒ¨æ¶æ§‹</a></h1>
<p>æœ¬ç« å…§å®¹ï¼š</p>
<ul>
<li>è©³è§£ Sylvia-IoT çš„å„å€‹å…ƒä»¶ã€‚</li>
<li>äº†è§£ä¸Šè¡Œè³‡æ–™ï¼ˆuplinkï¼‰èˆ‡ä¸‹è¡Œè³‡æ–™ï¼ˆdownlinkï¼‰çš„æµç¨‹ã€‚</li>
<li>ä»‹ç´¹å¿«å–çš„æ©Ÿåˆ¶ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ¶æ§‹"><a class="header" href="#æ¶æ§‹">æ¶æ§‹</a></h1>
<p><img src="arch/arch.svg" alt="Architecture" /></p>
<p>ä¸Šé¢æ˜¯ Sylvia-IoT å…ƒä»¶çš„ç¤ºæ„åœ–ã€‚é€™ç« ç¯€æˆ‘å€‘å°‡é€ä¸€è§£é‡‹ã€‚</p>
<h2 id="sylvia-iot-æ ¸å¿ƒå…ƒä»¶"><a class="header" href="#sylvia-iot-æ ¸å¿ƒå…ƒä»¶">Sylvia-IoT æ ¸å¿ƒå…ƒä»¶</a></h2>
<p>ç°¡ç¨± ABCDï¼ˆç¬‘ ğŸ˜Šï¼‰</p>
<h3 id="auth-sylvia-iot-auth"><a class="header" href="#auth-sylvia-iot-auth">Auth (sylvia-iot-auth)</a></h3>
<ul>
<li>ç”¨é€”
<ul>
<li>ç‚º HTTP API æä¾›ä»¤ç‰Œï¼ˆaccess tokenï¼‰çš„åˆæ³•æ€§å’Œè³‡è¨Šï¼Œè®“ API å¯ä»¥æ±ºå®šæ˜¯å¦æˆæ¬Šæ­¤ä»¤ç‰Œå­˜å–ã€‚</li>
<li>æä¾› OAuth2 çš„æˆæ¬Šæ©Ÿåˆ¶ï¼Œç›®å‰æ”¯æ´ä¸‹åˆ—æµç¨‹ï¼š
<ul>
<li>Authorization code grant flow
<ul>
<li>å®¢æˆ¶ç«¯éœ€ä½¿ç”¨ webview é¡¯ç¤ºç™»å…¥å’Œæˆæ¬Šé é¢ã€‚</li>
<li>ç›®å‰ coremgr CLI ä½¿ç”¨æ­¤æµç¨‹ã€‚</li>
</ul>
</li>
<li>Client credentials grant flow
<ul>
<li>ç›®å‰ä¿ç•™æ­¤åŠŸèƒ½ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç®¡ç†çš„å¯¦é«”
<ul>
<li>ä½¿ç”¨è€…å¸³è™Ÿ
<ul>
<li>ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™ã€‚</li>
<li>æ¬Šé™ï¼ˆroleï¼‰ã€‚</li>
</ul>
</li>
<li>å®¢æˆ¶ç«¯
<ul>
<li>HTTP API çš„å­˜å–æ¬Šé™ï¼ˆscopeï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç›¸ä¾æ€§
<ul>
<li>ç„¡ã€‚å¯ç¨ç«‹é‹ä½œã€‚</li>
</ul>
</li>
</ul>
<h3 id="broker-sylvia-iot-broker"><a class="header" href="#broker-sylvia-iot-broker">Broker (sylvia-iot-broker)</a></h3>
<ul>
<li>ç”¨é€”
<ul>
<li>ç®¡ç†å’Œè£ç½®ç›¸é—œçš„å¯¦é«”ã€‚</li>
<li>ç¶å®šè£ç½®å’Œæ‡‰ç”¨ã€è½‰ç™¼è£ç½®è³‡æ–™çµ¦æ‡‰ç”¨ï¼Œæˆ–æ˜¯æ¥æ”¶æ‡‰ç”¨ç™¼å‡ºçš„è³‡æ–™çµ¦è£ç½®ã€‚</li>
<li>ï¼ˆå¯é¸ï¼‰å°‡æµç¶“çš„ç¶²è·¯ã€æ‡‰ç”¨è³‡æ–™å…¨éƒ¨é€éè³‡æ–™é€šé“ï¼ˆdata channelï¼‰é€çµ¦ <strong>Data æœå‹™</strong> å„²å­˜æˆ–åˆ†æã€‚</li>
</ul>
</li>
<li>ç®¡ç†çš„å¯¦é«”
<ul>
<li>å–®ä½
<ul>
<li>ç”±ä¸€å€‹æ“æœ‰è€…å’Œå¤šå€‹æˆå“¡çµ„æˆã€‚</li>
<li>å¯ä»¥ç¨ç«‹ç®¡ç†è£ç½®ã€æ‡‰ç”¨ã€ç¶²è·¯ã€è·¯ç”±ï¼ˆç¶å®šï¼‰è¦å‰‡ã€‚</li>
</ul>
</li>
<li>æ‡‰ç”¨
<ul>
<li>è§£æè£ç½®è³‡æ–™ä¸¦ä¾æ“šéœ€æ±‚åˆ†ææ•¸æ“šå’Œå‘ˆç¾çµæœã€‚</li>
</ul>
</li>
<li>ç¶²è·¯
<ul>
<li>å¯ä»¥ä½¿ç”¨ç›´æ¥èˆ‡ Sylvia-IoT ä»‹é¢é€£æ¥çš„æœå‹™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€£æ¥å™¨ï¼ˆadapterï¼‰å°‡ç›®å‰æ—¢æœ‰çš„ç¶²è·¯æœå‹™ï¼ˆå¦‚ <a href="https://www.thethingsnetwork.org/"><strong>The Things Network (TTN)</strong></a> æˆ–æ˜¯ <a href="https://www.chirpstack.io/"><strong>ChirpStack</strong></a> ç­‰ï¼‰é€£æ¥åˆ° Slvia-IoTã€‚</li>
<li>ä¸€å€‹ç¶²è·¯ä½å€å¯ä»¥ç”¨ä¾†å‚³è¼¸ä¸€å€‹è£ç½®çš„è³‡æ–™ã€‚</li>
<li>ç®¡ç†å“¡ï¼ˆadmin roleï¼‰å¯ä»¥å»ºç«‹å…¬ç”¨çš„ç¶²è·¯ã€‚</li>
</ul>
</li>
<li>è£ç½®
<ul>
<li>æ¯ä¸€å€‹è£ç½®è¡¨ç¤ºä¸€ç¨®çµ‚ç«¯çš„æ‡‰ç”¨ï¼Œæ¯”å¦‚è¿½è¹¤å™¨ã€é›»éŒ¶ã€æ„Ÿæ‡‰å™¨ç­‰ã€‚</li>
<li>è£ç½®éœ€ä¾é™„æ–¼ä¸€å€‹ç¶²è·¯ä¸‹çš„ç¶²è·¯ä½å€æ‰èƒ½å‚³è¼¸è³‡æ–™ã€‚
<ul>
<li>å¯ä»¥å°‡è£ç½®ä¾é™„æ–¼å…¬ç”¨ç¶²è·¯ä¸­ï¼Œä½†éœ€è¦é€éç®¡ç†å“¡å¸³è™Ÿï¼ˆadmin/manager rolesï¼‰æ‰èƒ½è¨­å®šã€‚</li>
<li>æ¯ä¸€å€‹è£ç½®æœ‰å”¯ä¸€çš„è­˜åˆ¥ç¢¼ï¼ˆdevice IDï¼‰ï¼Œæ‡‰ç”¨å¦‚æœä¾é çš„æ˜¯æ­¤è­˜åˆ¥ç¢¼ï¼Œå³ä½¿è®Šæ›´ç¶²è·¯å’Œä½å€ï¼Œéƒ½å¯ä»¥ç„¡éœ€è®Šæ›´æ‡‰ç”¨çš„ç®¡ç†ã€‚</li>
</ul>
</li>
<li>æ¯ä¸€å€‹è£ç½®å¯ä»¥ä¾æ“šè³‡æ–™å…§å®¹ï¼Œçµ¦å®šä¸€å€‹è£ç½®è¨­å®šæª”ï¼ˆprofileï¼‰ã€‚
<ul>
<li>é€é profileï¼Œæ‡‰ç”¨å°±å¯ä»¥å¿«é€Ÿè§£æè³‡æ–™è€Œç„¡éœ€å»ºç«‹è­˜åˆ¥ç¢¼çš„å°æ‡‰è¡¨äº†ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>è·¯ç”±è¦å‰‡
<ul>
<li>å°‡è£ç½®ç¶å®šåˆ°æ‡‰ç”¨ã€‚
<ul>
<li>å¯ä»¥å¤šå°å¤šã€‚</li>
</ul>
</li>
<li>å°‡ç¶²è·¯ç¶å®šåˆ°æ‡‰ç”¨ï¼Œæ‰€æœ‰è©²ç¶²è·¯ä¸‹çš„è£ç½®éƒ½æœƒè¢«è·¯ç”±ï¼Œäº¦å³ç„¡é ˆä¸€å°ä¸€å°ç¶å®šã€‚
<ul>
<li>å¯ä»¥å¤šå°å¤šã€‚</li>
<li>ä¸å¯ä»¥ç¶å®šå…¬ç”¨ç¶²è·¯ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç›¸ä¾æ€§
<ul>
<li>éœ€ä¾è³´ Auth æœå‹™</li>
</ul>
</li>
</ul>
<h3 id="coremgr-sylvia-iot-coremgr"><a class="header" href="#coremgr-sylvia-iot-coremgr">Coremgr (sylvia-iot-coremgr)</a></h3>
<ul>
<li>ç”¨é€”
<ul>
<li>coremgr å³ core managerï¼Œè² è²¬ç®¡ç† Sylvia-IoT æ ¸å¿ƒçš„å…ƒä»¶ã€‚</li>
<li>æä¾›ä¸»è¦çš„ HTTP API çµ¦å¤–éƒ¨ç›´æ¥å­˜å–ã€‚
<ul>
<li>Auth åƒ…é–‹æ”¾èªè­‰ï¼æˆæ¬Š APIã€‚ä½¿ç”¨è€…å’Œå®¢æˆ¶ç«¯ç®¡ç†ä»éœ€ä½¿ç”¨ coremgr APIã€‚</li>
<li>é€éæ©‹æ¥çš„æ–¹å¼é–“æ¥ä½¿ç”¨ Authã€Broker HTTP API ä¾†ç®¡ç†å„ç¨®å¯¦é«”ã€‚</li>
</ul>
</li>
<li>é€é management API è¨­å®š RabbitMQ/EMQX ç­‰è¨Šæ¯ä»£ç†ä¾†å»ºç«‹ä½‡åˆ—å’Œå°æ‡‰çš„æ¬Šé™ã€‚
<ul>
<li>Broker åªè² è²¬ç®¡ç†å¯¦é«”é–“çš„é—œè¯å’Œ AMQP/MQTT çš„é€£ç·šï¼Œå¯¦éš›çš„ RabbitMQ/EMQX çš„è¨­å®šæ˜¯é  coremgr é€²è¡Œè¨­å®šã€‚</li>
</ul>
</li>
<li>ï¼ˆå¯é¸ï¼‰å°‡æ“ä½œç´€éŒ„ï¼ŒåŒ…å«æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤ç­‰ï¼Œé€éè³‡æ–™é€šé“ï¼ˆdata channelï¼‰é€çµ¦ <strong>Data æœå‹™</strong> å„²å­˜æˆ–åˆ†æã€‚</li>
</ul>
</li>
<li>ç®¡ç†çš„å¯¦é«”
<ul>
<li>ï¼ˆç„¡ï¼‰</li>
</ul>
</li>
<li>ç›¸ä¾æ€§
<ul>
<li>éœ€ä¾è³´ Authã€Broker æœå‹™ã€‚</li>
<li>éœ€ä¾è³´è¨Šæ¯ä»£ç†çš„ management APIã€‚</li>
</ul>
</li>
</ul>
<h3 id="coremgr-cli-sylvia-iot-coremgr-cli"><a class="header" href="#coremgr-cli-sylvia-iot-coremgr-cli">Coremgr CLI (sylvia-iot-coremgr-cli)</a></h3>
<ul>
<li>ç”¨é€”
<ul>
<li>æä¾›å‘½ä»¤åˆ—ä»‹é¢ï¼ˆCLIï¼‰çµ¦ä½¿ç”¨è€…é€éæŒ‡ä»¤ä¾†è¨­å®š Sylvia-IoTã€‚</li>
</ul>
</li>
<li>ç›¸ä¾æ€§
<ul>
<li>éœ€ä¾è³´ Authã€Coremgr æœå‹™ã€‚Auth åƒ…ä½¿ç”¨èªè­‰ï¼æˆæ¬Šéƒ¨åˆ†ã€‚</li>
<li>å¯ä»¥ç›¸ä¾ Data æœå‹™ä¾†è®€å–æ­·å²è³‡æ–™ã€‚</li>
</ul>
</li>
</ul>
<h3 id="æ§åˆ¶é€šé“-control-channal-vs-è³‡æ–™é€šé“-data-channel"><a class="header" href="#æ§åˆ¶é€šé“-control-channal-vs-è³‡æ–™é€šé“-data-channel">æ§åˆ¶é€šé“ (Control Channal) vs. è³‡æ–™é€šé“ (Data Channel)</a></h3>
<ul>
<li>æ§åˆ¶é€šé“ç”¨ä¾†å‚³è¼¸å¯¦é«”ï¼ˆä½¿ç”¨è€…ã€å–®ä½ã€è£ç½®ç­‰ï¼‰ç®¡ç†çš„è¨Šæ¯ã€‚ä¸€èˆ¬åˆ†ç‚ºï¼š
<ul>
<li>Unicastï¼ˆå–®æ’­ï¼‰ï¼Œä¸€å€‹è¨Šæ¯åªæœ‰ä¸€å€‹æ¶ˆè²»è€…ï¼Œç”¨æ–¼ Sylvia-IoT æ¨é€è¨Šæ¯çµ¦ç¶²è·¯æˆ–æ‡‰ç”¨çš„æ™‚å€™ã€‚é€™å€‹æœƒåœ¨ç¨å¾Œçš„ <a href="arch/./flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€èªªæ˜ã€‚</li>
<li>Broadcastï¼ˆå»£æ’­ï¼‰ï¼Œç”¨ä¾†å»£æ’­çµ¦ Sylvia-IoT å¢é›†ä¸­çš„å„å€‹æ ¸å¿ƒç¨‹åºã€‚é€™å€‹æœƒåœ¨ç¨å¾Œçš„ <a href="arch/./cache.html"><strong>å¿«å–</strong></a> ç« ç¯€èªªæ˜ã€‚</li>
</ul>
</li>
<li>è³‡æ–™é€šé“ç”¨ä¾†å‚³è¼¸è£ç½®è³‡æ–™æˆ–æ­·å²è³‡æ–™ã€‚
<ul>
<li>æ³›æŒ‡ Application Dataã€Network Dataã€Coremgr OP Dataã€‚</li>
<li>ç›®å‰å¯¦ä½œäº† AMQP 0-9-1ã€MQTT 3.1.1 å”è­°ã€‚ä¹Ÿå¯ä»¥å¯¦ä½œ AMQP 1.0ã€Kafkaã€NATS ç­‰ã€‚</li>
</ul>
</li>
</ul>
<h4 id="general-mq"><a class="header" href="#general-mq">general-mq</a></h4>
<p>Sylvia-IoT ä½¿ç”¨ <a href="https://crates.io/crates/general-mq"><strong>general-mq</strong></a> å¯¦ç¾ unicast å’Œ broadcastï¼Œä¸¦éš±è—äº†é€šè¨Šå”è­°çš„ç´°ç¯€ã€‚</p>
<p>åªè¦åœ¨ general-mq å¯¦ä½œ AMQP 1.0ã€Kafka ç­‰å”è­°çš„ unicast/broadcast æ¨¡å¼ï¼Œä¸¦åœ¨ coremgr å¯¦ä½œå°æ‡‰çš„ management APIï¼Œå³å¯è®“ Sylvia-IoT æ”¯æ´æ›´å¤šå”è­°ã€‚</p>
<h3 id="data-sylvia-iot-data"><a class="header" href="#data-sylvia-iot-data">Data (sylvia-iot-data)</a></h3>
<ul>
<li>ç”¨é€”
<ul>
<li>ç´€éŒ„æˆ–åˆ†æè³‡æ–™é€šé“ä¸­çš„è³‡æ–™ã€‚</li>
</ul>
</li>
</ul>
<p>é€™å€‹æ¨¡çµ„æ¯”è¼ƒç‰¹åˆ¥çš„åœ°æ–¹åœ¨æ–¼æ²’æœ‰ç‰¹å®šçš„å¯¦ä½œã€‚ç›®å‰ Sylvia-IoT Core çš„ <strong>sylvia-iot-data</strong> æä¾›äº†åŸå§‹è³‡æ–™çš„å„²å­˜å’Œè®€å–ã€‚</p>
<p>ä»¥ä¸‹åˆ—å‡ºå¯ä»¥å»¶ä¼¸çš„å ´æ™¯ï¼š</p>
<ul>
<li>è¦å‰‡å¼•æ“ï¼ˆrule engineï¼‰ã€‚
<ul>
<li>ç”±æ–¼è³‡æ–™é€šé“å«æœ‰æ‰€æœ‰ç¶²è·¯è³‡æ–™ï¼Œå¯ä»¥å°‡ Data æ¨¡çµ„å¯¦ä½œç‚ºä¸€èˆ¬ IoT å¹³å°å¸¸è¦‹çš„è¦å‰‡å¼•æ“ã€‚</li>
</ul>
</li>
<li>æµè™•ç†ï¼ˆstream processingï¼‰ã€‚
<ul>
<li>å¯ä»¥å°‡è³‡æ–™é€šé“å¯¦ä½œæˆ Kafka ä½‡åˆ—ï¼Œé€²è¡Œæµè™•ç†ã€‚</li>
</ul>
</li>
</ul>
<h2 id="è¨Šæ¯ä»£ç†æœå‹™-message-brokers"><a class="header" href="#è¨Šæ¯ä»£ç†æœå‹™-message-brokers">è¨Šæ¯ä»£ç†æœå‹™ (Message Brokers)</a></h2>
<blockquote>
<p>é€™è£¡çš„è¨Šæ¯ä»£ç†æŒ‡çš„æ˜¯ RabbitMQã€EMQX ç­‰æœå‹™ï¼Œä¸æ˜¯ Sylvia-IoT Brokerã€‚
é™¤éç‰¹åˆ¥å¼·èª¿ RabbitMQã€EMQX ç­‰ï¼Œæœ¬æ–‡ä»¶çš„ã€ŒBrokerã€æ³›æŒ‡ Sylvia-IoT Brokerã€‚</p>
</blockquote>
<p>å¹¾å€‹æ³¨æ„äº‹é …ï¼š</p>
<ul>
<li>ç”±æ–¼ coremgr éœ€è¦é€é management API è¨­å®šä½‡åˆ—ï¼Œå¿…é ˆæä¾›ç›¸é—œçš„å¯¦ä½œæ‰èƒ½æ”¯æ´ã€‚ç›®å‰ coremgr æ”¯æ´çš„è¨Šæ¯ä»£ç†æœå‹™å¦‚ä¸‹ï¼š
<ul>
<li>RabbitMQ</li>
<li>EMQX</li>
<li>æœªä¾†å¯ä»¥å¯¦ä½œ Kafka æˆ–å…¶ä»–å”è­°ï¼Œè®“ Sylvia-IoT çš„æ‡‰ç”¨å¯ä»¥æ›´å»£æ³›ã€‚</li>
</ul>
</li>
<li>Sylvia-IoT çš„éœ€æ±‚æœ‰ä»¥ä¸‹æ¨¡å¼ï¼š
<ul>
<li>Message queuingï¼Œå³å‚³çµ±çš„è¨Šæ¯æ¨¡å¼ï¼ˆä¸€å€‹è¨Šæ¯åªæœ‰ä¸€å€‹æ¶ˆè²»è€…ï¼‰ã€‚
<ul>
<li>MQTT é€é shared subscription å¯¦ä½œã€‚</li>
</ul>
</li>
<li>Publish/Subscribeï¼ˆæ¨æ’­ï¼è¨‚é–±ï¼‰ï¼Œç”¨ä½œæ§åˆ¶é€šé“ï¼ˆcontrol channelï¼‰çš„å»£æ’­è¨Šæ¯ã€‚åœ¨ <a href="arch/./cache.html"><strong>å¿«å–</strong></a> çš„ç« ç¯€æœƒä»‹ç´¹ã€‚
<ul>
<li>AMQP é€é fanout exchage å’Œ temorary queue å¯¦ä½œã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="rumqttd"><a class="header" href="#rumqttd">rumqttd</a></h3>
<p>åœ¨ <a href="arch/../guide/quick.html"><strong>å¿«é€Ÿé–‹å§‹</strong></a> ç« ç¯€ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨äº† <strong>sylvia-iot-core</strong> ä½œç‚ºç¯„ä¾‹ã€‚é€™å€‹å¯åŸ·è¡Œæª”æœ¬èº«åŒ…å«äº†å®Œæ•´çš„ Auth/Broker/Coremgr/Dataï¼Œä»¥åŠ rumqttdã€‚</p>
<p>ç‚ºäº†åœ¨å°å®¹é‡çš„ç’°å¢ƒä¹Ÿå¯ä»¥åŸ·è¡Œï¼Œ<strong>sylvia-iot-core</strong> å…§å«äº† <a href="https://github.com/bytebeamio/rumqtt"><strong>rumqttd</strong></a> MQTT brokerã€‚
åªè¦é…åˆè¨­å®šï¼Œå°±å¯ä»¥ç”¨ SQLite ä½œç‚ºè³‡æ–™åº«ï¼Œæ­é… MQTT å‚³éè¨Šæ¯ï¼Œä»¥å…©å€‹æª”æ¡ˆçš„è¦æ¨¡ï¼Œå¯¦ç¾å®Œæ•´çš„ Sylvia-IoT çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>core æ˜¯é›†çµå®Œæ•´åŠŸèƒ½çš„å¯åŸ·è¡Œæª”ã€‚è€Œ coremgr åªæœ‰ç®¡ç†éƒ¨åˆ†ï¼Œä¸”ä¸å« rumqttdã€‚</p>
</blockquote>
<p>ç‚ºäº†å› æ‡‰é€™å€‹å—é™çš„ç’°å¢ƒï¼ŒSylvia-IoT æ‰æ¡ç”¨äº† rumqttdã€‚
Sylvia-IoT ç›®å‰æ²’æœ‰å¯¦ä½œ rumqttd management APIï¼Œè«‹å‹¿ä½¿ç”¨æ–¼å¢é›†æ¶æ§‹ï¼ˆclusterï¼‰ã€‚æœ‰ä½‡åˆ—æ¬Šé™éœ€æ±‚è€…ä¹Ÿä¸å»ºè­°ä½¿ç”¨é€™æ¨¡å¼ã€‚</p>
<h2 id="ç¬¬ä¸‰æ–¹å…ƒä»¶-3rd-party-components"><a class="header" href="#ç¬¬ä¸‰æ–¹å…ƒä»¶-3rd-party-components">ç¬¬ä¸‰æ–¹å…ƒä»¶ (3rd Party Components)</a></h2>
<h3 id="application-servers-network-servers"><a class="header" href="#application-servers-network-servers">Application Servers, Network Servers</a></h3>
<p>æ‡‰ç”¨å’Œç¶²è·¯é™¤äº†ä½¿ç”¨è³‡æ–™é€šé“çš„è¨Šæ¯æ”¶é€è£ç½®è³‡æ–™ï¼Œä¹Ÿå¯ä»¥é€éå®¢æˆ¶ç«¯å­˜å– Sylvia-IoT HTTP API å’Œæ§åˆ¶é€šé“çš„è¨Šæ¯ä¾†æ‰“é€ è‡ªå·±çš„ç®¡ç†ç³»çµ±ã€‚</p>
<h3 id="devices"><a class="header" href="#devices">Devices</a></h3>
<p>è£ç½®ä¸€èˆ¬éƒ½å’Œç¶²è·¯æ¨¡çµ„ç¶å®šï¼›è€Œ Sylvia-IoT çš„ã€Œè£ç½®ã€æ˜¯æŒ‡ç‹¹ç¾©çš„çµ‚ç«¯è£ç½®ï¼Œåªè™•ç†æ‡‰ç”¨æ‰€éœ€è¦çš„è³‡æ–™ã€‚è‡³æ–¼ç¶²è·¯æ¨¡çµ„çš„éƒ¨åˆ†æ˜¯å¯ä»¥æŠ½æ›çš„ã€‚</p>
<p>èˆ‰å€‹æŠ½æ›ç¶²è·¯æ¨¡çµ„çš„ä¾‹å­ï¼Œå‡å¦‚è£ç½®æ˜¯ä½¿ç”¨æ¨¹è“æ´¾é€£æ¥æ„Ÿæ‡‰å™¨é€²è¡Œç‰¹å®šçš„æ‡‰ç”¨é–‹ç™¼ï¼Œç¶²è·¯çš„éƒ¨åˆ†å¯ä»¥ç”¨ USB éš¨æ™‚è®Šæ›´æˆä¸åŒçš„å”è­°ï¼ˆLoRa æ›æˆ WiFiï¼Œç”šè‡³æ˜¯æ¥ç¶²è·¯ç·šï¼‰ã€‚
åœ¨ Sylvia-IoT åªéœ€è¦ä¿®æ”¹è£ç½®å°æ‡‰çš„ç¶²è·¯å’Œä½å€å³å¯ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è³‡æ–™æµ"><a class="header" href="#è³‡æ–™æµ">è³‡æ–™æµ</a></h1>
<p>æœ¬ç« ç¯€ä»‹ç´¹ Sylvia-IoT å¦‚ä½•è™•ç†è³‡æ–™æµï¼ŒåŒ…å«ä»¥ä¸‹å¹¾ç¨®ï¼š</p>
<ul>
<li>ä¸Šè¡Œè³‡æ–™ï¼ˆuplinkï¼‰ï¼Œè£ç½®â†’æ‡‰ç”¨ã€‚</li>
<li>ä¸‹è¡Œè³‡æ–™ï¼ˆdownlinkï¼‰ï¼Œæ‡‰ç”¨â†’è£ç½®ã€‚</li>
<li>æ§åˆ¶é€šé“ï¼ŒBrokerâ†’ç¶²è·¯ã€‚</li>
<li>Coremgr æ“ä½œè³‡æ–™ï¼ˆoperationï¼‰ï¼Œç´€éŒ„ç³»çµ±æ“ä½œæ­·ç¨‹ã€‚</li>
</ul>
<h2 id="ä¸Šè¡Œè³‡æ–™-uplink"><a class="header" href="#ä¸Šè¡Œè³‡æ–™-uplink">ä¸Šè¡Œè³‡æ–™ (Uplink)</a></h2>
<p><img src="arch/flow-uplink.svg" alt="Uplink" /></p>
<p>ç•¶è£ç½®çš„è³‡æ–™é€éç¶²è·¯æœå‹™é€åˆ°å°æ‡‰çš„ä½‡åˆ—å¾Œï¼Œè³‡æ–™æœƒä»¥å¦‚ä¸‹çš„æ–¹å¼è¢«é€è‡³æ‡‰ç”¨ç«¯ï¼š</p>
<ol>
<li>å¦‚æ ¼å¼æ­£ç¢ºï¼Œç¹¼çºŒä¸‹ä¸€æ­¥ï¼›å¦å‰‡ç›´æ¥ä¸Ÿæ£„ã€‚</li>
<li>Broker å…ˆç›´æ¥å°‡è³‡æ–™é€å¾€ Data å…ƒä»¶ï¼ˆé€éä½‡åˆ—ï¼‰ï¼Œä»¥å„²å­˜å®Œæ•´çš„ä¸Šè¡Œè³‡æ–™å…§å®¹ã€‚</li>
<li>æƒææ‰€æœ‰çš„è£ç½®è·¯ç”±ï¼Œä¸¦é€²è¡Œä»¥ä¸‹çš„å‹•ä½œï¼š
<ul>
<li>é€å¾€å°æ‡‰æ‡‰ç”¨çš„ä½‡åˆ—ã€‚</li>
<li>å°‡é€å¾€æ‡‰ç”¨çš„è³‡æ–™å„²å­˜åˆ° Data å…ƒä»¶ã€‚</li>
</ul>
</li>
<li>æƒææ‰€æœ‰çš„ç¶²è·¯è·¯ç”±ï¼Œä¸¦é€²è¡Œä»¥ä¸‹çš„å‹•ä½œï¼š
<ul>
<li>æ¯”å°æ˜¯å¦å·²ç¶“åœ¨è£ç½®è·¯ç”±éšæ®µå°±å·²ç™¼é€ã€‚æœ‰å°±é€²è¡Œä¸‹ä¸€å€‹ç¶²è·¯è·¯ç”±å‹•ä½œï¼Œæ²’æœ‰å°±ç¹¼çºŒä»¥ä¸‹å‹•ä½œã€‚</li>
<li>é€å¾€å°æ‡‰æ‡‰ç”¨çš„ä½‡åˆ—ã€‚</li>
<li>å°‡é€å¾€æ‡‰ç”¨çš„è³‡æ–™å„²å­˜åˆ° Data å…ƒä»¶ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>æ­¥é©Ÿ 4 çš„æ¯”å°çš„å‹•ä½œï¼Œç›®çš„åœ¨æ–¼é¿å…è£ç½®è·¯ç”±èˆ‡ç¶²è·¯è·¯ç”±å‡ºç¾é‡ç–Šçš„æ™‚å€™ï¼Œé€ æˆé‡è¤‡ç™¼é€çš„è¡Œç‚ºã€‚</p>
</blockquote>
<h2 id="ä¸‹è¡Œè³‡æ–™-downlink"><a class="header" href="#ä¸‹è¡Œè³‡æ–™-downlink">ä¸‹è¡Œè³‡æ–™ (Downlink)</a></h2>
<p><img src="arch/flow-downlink.svg" alt="Downlink" /></p>
<p>ç•¶æ‡‰ç”¨æœå‹™å°‡è¦é€çµ¦è£ç½®çš„è³‡æ–™ç™¼é€åˆ°ä½‡åˆ—å¾Œï¼Œè³‡æ–™æœƒä»¥å¦‚ä¸‹çš„æ–¹å¼è¢«é€è‡³è£ç½®å°æ‡‰çš„ç¶²è·¯æœå‹™ï¼š</p>
<ol>
<li>å¦‚æ ¼å¼æ­£ç¢ºï¼Œç¹¼çºŒä¸‹ä¸€æ­¥ï¼›å¦å‰‡é€é <code>resp</code> ä½‡åˆ—å›æ‡‰éŒ¯èª¤è¨Šæ¯ã€‚</li>
<li>æª¢æŸ¥ç›®çš„è£ç½®æ˜¯å¦å±¬æ–¼è©²å–®ä½ï¼Œå¦‚æœæ˜¯ï¼Œç¹¼çºŒä¸‹ä¸€æ­¥ï¼›å¦å‰‡é€é <code>resp</code> ä½‡åˆ—å›æ‡‰éŒ¯èª¤è¨Šæ¯ã€‚</li>
<li>å°‡æ­¤è³‡æ–™æ–°å¢ IDï¼ˆå”¯ä¸€è­˜åˆ¥ç¢¼ï¼‰ä½œç‚ºç¨ç«‹è³‡æ–™ï¼Œç„¶å¾Œé€åˆ° Data å…ƒä»¶å„²å­˜ã€‚</li>
<li>åœ¨è³‡æ–™åº«ä¿ç•™é€™ç­†è³‡æ–™çš„ ID å’Œä¾†æºçš„æ‡‰ç”¨ï¼Œä¾¿æ–¼æ—¥å¾Œå›å ±é€™ç­†è³‡æ–™çš„å‚³é€çµæœçµ¦æ‡‰ç”¨æœå‹™ã€‚</li>
<li>å°‡è³‡æ–™ï¼ˆå«è³‡æ–™ IDï¼‰ç™¼é€åˆ°ç¶²è·¯æœå‹™çš„ä½‡åˆ—ã€‚</li>
<li>å¦‚æœç™¼é€åˆ°ç¶²è·¯æœå‹™çš„ä½‡åˆ—ï¼Œå°‡æ­¤è³‡æ–™çš„ ID å›å ±çµ¦æ‡‰ç”¨æœå‹™ï¼Œä¾†è¿½è¹¤å‚³é€çš„çµæœã€‚</li>
</ol>
<blockquote>
<p>ç›¸è¼ƒæ–¼ä¸Šè¡Œè³‡æ–™ï¼Œä¸‹è¡Œè³‡æ–™ç¨å¾®è¤‡é›œã€‚ä¸»è¦çš„é›£é¡Œåœ¨æ–¼ <strong>è¦å›å ±å‚³é€çš„çµæœ</strong>ã€‚</p>
</blockquote>
<p>Broker æ²’æœ‰ä¿ç•™ <code>resp</code> ä½‡åˆ—è®“ç¶²è·¯æœå‹™å›å ±è³‡æ–™çš„æ­£ç¢ºæ€§ï¼ŒåŸå› åœ¨ Broker ä½œç‚ºåŸºç¤è¨­æ–½ï¼Œå…§å®¹ä¸€å®šæ˜¯æ­£ç¢ºçš„ï¼
ç¶²è·¯æœå‹™åªè¦å°ˆæ³¨æ–¼å°‡è³‡æ–™é€å¾€è£ç½®ï¼Œä¸¦å›å ±æœ€å¾Œçš„çµæœå³å¯ã€‚å³ä½¿ Broker é€éå»çš„è³‡æ–™å·²ç¶“ç„¡æ•ˆï¼Œç¶²è·¯æœå‹™ç›´æ¥é€é <code>result</code> ä½‡åˆ—å›å ±å³å¯ã€‚</p>
<p><img src="arch/flow-downlink-result.svg" alt="Downlink-Result" /></p>
<p>ç•¶è³‡æ–™è™•ç†å®Œæˆï¼ˆç„¡è«–æˆåŠŸèˆ‡å¦ï¼‰ï¼Œç¶²è·¯æœå‹™ <strong>å¿…é ˆ</strong> ä½¿ç”¨è³‡æ–™ ID ä¾†å›å ±çµ¦ Brokerã€‚é †åºå¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æ ¼å¼æ­£ç¢ºï¼Œç¹¼çºŒä¸‹ä¸€æ­¥ï¼›å¦å‰‡ç›´æ¥ä¸Ÿæ£„ã€‚</li>
<li>é€é IDï¼Œå‘ Data å…ƒä»¶æäº¤çµæœçš„æ›´æ–°è¦æ±‚ã€‚</li>
<li>æŠ“å–è©² ID æ‰€å±¬çš„æ‡‰ç”¨æœå‹™è³‡è¨Šï¼Œä¸¦å°‡çµæœå›å ±çµ¦ç™¼é€æ­¤ä¸‹è¡Œè³‡æ–™çš„æ‡‰ç”¨ç¨‹å¼ï¼ˆç¢ºä¿å…¶ä»–æ‡‰ç”¨ä¸æœƒæ”¶åˆ°ï¼‰ã€‚</li>
<li>å¦‚æœæ­¥é©Ÿ 3 æˆåŠŸï¼Œæ¸…é™¤è³‡æ–™åº«ä¸­çš„ ID è³‡è¨Šã€‚</li>
</ol>
<blockquote>
<p>ä½¿ç”¨é¡å¤–çš„ ID è³‡æ–™åº«çš„ç›®çš„åœ¨æ–¼ä¿ç•™ä¸‹è¡Œè³‡æ–™çš„ä¾†æºæ‡‰ç”¨ï¼Œç•¢ç«Ÿç”±æ‡‰ç”¨ A ç™¼é€çš„è³‡æ–™ï¼Œç‚ºä»€éº¼æ‡‰ç”¨ B è¦æ”¶åˆ°çµæœå‘¢ ğŸ˜Šï¼Ÿ</p>
</blockquote>
<h2 id="æ§åˆ¶é€šé“-control-channel"><a class="header" href="#æ§åˆ¶é€šé“-control-channel">æ§åˆ¶é€šé“ (Control Channel)</a></h2>
<p><img src="arch/flow-ctrl.svg" alt="Ctrl" /></p>
<p>Broker æˆ–æ˜¯ coremgr æä¾› API å¯ä»¥è®“ç¶²è·¯æœå‹™éš¨æ™‚æ›´æ–°è£ç½®çš„è³‡æ–™ã€‚ä¸éé è‘—å®šæœŸè«‹æ±‚ API ä¾†åŒæ­¥çš„æ•ˆç‡ä¸ä½³ï¼Œä¸”å¯èƒ½å› ç‚ºé »ç¹è«‹æ±‚ï¼Œå½±éŸ¿è·¯ç”±çš„æ•ˆèƒ½ã€‚
Broker æä¾›äº†ä¸€å€‹æ©Ÿåˆ¶ï¼Œç•¶è£ç½®è³‡æ–™æœ‰è®Šæ›´çš„æ™‚å€™ï¼Œåœ¨ <code>broker.network.[å–®ä½ä»£ç¢¼].[ç¶²è·¯ä»£ç¢¼].ctrl</code> æä¾›è³‡è¨Šçµ¦å°æ‡‰çš„ç¶²è·¯æœå‹™ã€‚</p>
<p>Sylvia-IoT å…è¨±è£ç½®è®Šæ›´ä¾é™„çš„ç¶²è·¯æˆ–æ˜¯ä½å€ã€‚ç•¶é€™å€‹æ“ä½œç™¼ç”Ÿçš„æ™‚å€™ï¼Œä¾æ“šä¸åŒæƒ…å¢ƒï¼Œç¶²è·¯æœå‹™æœƒæ”¶åˆ°å¦‚ä¸‹çš„è¨Šæ¯ï¼š</p>
<ul>
<li>å¾ç¶²è·¯ A è®Šæ›´ç‚ºç¶²è·¯ B
<ul>
<li>é€šçŸ¥ç¶²è·¯ Aï¼Œæœ‰ä¸€å€‹ç‰¹å®šä½å€è¢«ç§»é™¤ã€‚</li>
<li>é€šçŸ¥ç¶²è·¯ Bï¼Œæœ‰ä¸€å€‹ç‰¹å®šä½å€è¢«æ–°å¢ã€‚</li>
</ul>
</li>
<li>åœ¨ç¶²è·¯ A ä¸­è®Šæ›´ä½å€
<ul>
<li>é€šçŸ¥ç¶²è·¯ Aï¼Œæœ‰ä¸€å€‹ç‰¹å®šä½å€è¢«ç§»é™¤ã€‚</li>
<li>é€šçŸ¥ç¶²è·¯ Aï¼Œæœ‰ä¸€å€‹ç‰¹å®šä½å€è¢«æ–°å¢ã€‚</li>
</ul>
</li>
</ul>
<h2 id="æ“ä½œç´€éŒ„-operation-data"><a class="header" href="#æ“ä½œç´€éŒ„-operation-data">æ“ä½œç´€éŒ„ (Operation Data)</a></h2>
<p><img src="arch/flow-opdata.svg" alt="OpData" /></p>
<p>Coremgr æœ‰ä¸€å€‹å¯é¸çš„è¨­å®šï¼Œç”¨ä¾†å„²å­˜æ‰€æœ‰çš„ç³»çµ±æ“ä½œç´€éŒ„ï¼ˆç•¶ç„¶é™å®š coremgr HTTP APIï¼‰ã€‚ç›®å‰çš„ç¯„åœæ˜¯ POST/PUT/PATCH/DELETE ç­‰ã€‚</p>
<p>å¦‚ä¸Šåœ–ï¼Œcoremgr æœƒåœ¨ API æ“ä½œå®Œç•¢å¾Œï¼Œè¨˜éŒ„ä¸‹åˆ—çš„è³‡æ–™ï¼š</p>
<ul>
<li>è«‹æ±‚æ™‚é–“</li>
<li>å›æ‡‰æ™‚é–“</li>
<li>è™•ç†æ™‚é–“</li>
<li>HTTP ç‹€æ…‹</li>
<li>ä¾†æº IP ä½å€</li>
<li>HTTP method</li>
<li>ï¼ˆå¯é¸ï¼‰HTTP è«‹æ±‚ body
<ul>
<li>æœƒéæ¿¾ <code>data.password</code> çš„å…§å®¹ã€‚ç•¶è«‹æ±‚ä¸­æœ‰ <code>password</code> æ¬„ä½æ™‚ï¼Œæœƒå°‡å…¶å…§å®¹æ¸…ç©ºã€‚ä¿ç•™ key æ˜¯ç‚ºäº†æç¤ºæ­¤è«‹æ±‚æœ‰ä¿®æ”¹å¯†ç¢¼çš„å‹•ä½œã€‚</li>
</ul>
</li>
<li>ä½¿ç”¨è€… ID</li>
<li>å®¢æˆ¶ç«¯ ID</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¿«å–"><a class="header" href="#å¿«å–">å¿«å–</a></h1>
<p>åœ¨ <a href="arch/flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€çš„ä»‹ç´¹ï¼Œå¯ä»¥çŸ¥é“ Broker æœ€ä¸»è¦çš„ä»»å‹™å°±æ˜¯ã€Œæ¯”å°è·¯ç”±è¦å‰‡ä¸¦è½‰ç™¼ã€ã€‚
ä¸€èˆ¬ä¾†èªªè·¯ç”±è¦å‰‡æ”¾åœ¨è³‡æ–™åº«ä¸­ï¼Œå› æ­¤æ¯”å°çš„é€Ÿåº¦å°‡æœƒæˆç‚ºé—œéµç“¶é ¸æ‰€åœ¨ã€‚å°¤å…¶åœ¨åŒæ™‚é–“è¦è½‰ç™¼æˆåƒä¸Šè¬ç­†è³‡æ–™çš„æ™‚å€™ï¼Œå°è³‡æ–™åº«çš„å£“åŠ›æ›´æ˜¯ä¸è¨€è€Œå–»ã€‚</p>
<p>çœ¾æ‰€å‘¨çŸ¥ï¼Œè¦æ¸›è¼•è³‡æ–™åº«çš„æœ€ä½³æ–¹æ¡ˆå°±æ˜¯å¿«å–ï¼Œè€Œ Redis æ˜¯ç›®å‰ç›¸ç•¶æµè¡Œçš„ä¸€å€‹è§£æ±ºæ–¹æ¡ˆã€‚</p>
<p>Sylvia-IoT å¾æœ€åˆçš„è¨­è¨ˆå°±å¸Œæœ›èƒ½ç›¡é‡ç°¡å–®ã€ç›¡å¯èƒ½åŒæ™‚æ¡ç”¨æœ€å°‘çš„æŠ€è¡“ç¨®é¡ï¼ˆæ‚¨å¯ä»¥åªä½¿ç”¨ SQLite å’Œ MQTT å°±é‹è¡Œå®Œæ•´çš„ Sylvia-IoT åŠŸèƒ½ï¼‰ã€‚
åœ¨å¿«å–æŠ€è¡“ä¸Šï¼Œä½¿ç”¨äº†ç¨‹åºè¨˜æ†¶é«”ï¼ˆin-process-memoryï¼‰çš„æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯å°‡è³‡æ–™å„²å­˜åœ¨ç¨‹åºæœ¬èº«çš„è®Šæ•¸ä¸­ï¼Œæ¯”å°çš„éç¨‹ç„¡éœ€ä½¿ç”¨ç¶²è·¯å’Œ IPCï¼Œç›´æ¥å­˜å–è‡ªèº«çš„è®Šæ•¸å³å¯ã€‚</p>
<blockquote>
<p>ç›®å‰ Broker ä½¿ç”¨ <code>std::collections::HashMap</code> å¯¦ä½œã€‚</p>
</blockquote>
<p><img src="arch/cache.svg" alt="Cache" /></p>
<p>ä¸Šåœ–ç°¡ä»‹äº† Sylvia-IoT çš„å¿«å–æ©Ÿåˆ¶ã€‚ç‚ºäº†æ»¿è¶³å¢é›†æ¶æ§‹ï¼Œå¼•å…¥äº† broadcast ä½‡åˆ—å¯¦ä½œ <strong>æ§åˆ¶é€šé“ (Control Channel)</strong>ã€‚
ç‚ºäº†ä¿æŒè³‡æ–™çš„æ­£ç¢ºæ€§ï¼Œå…ˆæ›´æ–°è³‡æ–™åº«ï¼Œç„¶å¾Œæ‰æ›´æ–°å¿«å–ã€‚ä»¥ä¸‹æˆ‘å€‘ç°¡è¿°æ­¥é©Ÿï¼š</p>
<ol>
<li>ä½¿ç”¨è€…é€é HTTP API ä¿®æ”¹è·¯ç”±è¦å‰‡ã€‚</li>
<li>å’Œæ­£å¸¸çš„ API å¯¦ä½œä¸€æ¨£ï¼Œç›´æ¥æ“ä½œè³‡æ–™åº«ã€‚</li>
<li>åœ¨ HTTP å›æ‡‰å‰ï¼Œå…ˆç™¼é€ä¸€å€‹æ›´æ–°è¨Šæ¯åˆ°æ§åˆ¶é€šé“ã€‚å…§å®¹å«æœ‰å¿…è¦çš„æ›´æ–°çš„è³‡æ–™ï¼ˆåç¨±ç­‰éå¿…è¦çš„å…§å®¹å°±ä¸åœ¨å…¶ä¸­ï¼‰ã€‚</li>
<li>åœ¨å›æ‡‰ HTTP çš„åŒæ™‚ï¼Œæ§åˆ¶é€šé“æœƒå‘å¢é›†ä¸­çš„æ‰€æœ‰ç¨‹åºç™¼é€æ›´æ–°è¨Šæ¯ã€‚</li>
<li>ç¨‹åºæ”¶åˆ°å¾Œï¼Œè®Šæ›´è®Šæ•¸çš„å…§å®¹ã€‚</li>
</ol>
<blockquote>
<p>ç‚ºäº†ç°¡å–®ï¼Œç›®å‰çš„å¯¦ä½œå¤§å¤šæ˜¯åˆªé™¤å¿«å–è³‡æ–™ï¼ˆæ­¥é©Ÿ 3 çš„å…§å®¹æ˜¯åˆªé™¤å‹•ä½œï¼‰ï¼Œç„¶å¾Œåˆ©ç”¨ cache-miss å¡«è£œå…§å®¹ã€‚</p>
</blockquote>
<p>é€™é‚Šæ¢è¨å¹¾å€‹ç‰¹æ®Šç‹€æ³ï¼š</p>
<ul>
<li>Broker å¿«å–çš„è¨­è¨ˆæ¡ç”¨ã€Œæœ€çµ‚ä¸€è‡´æ€§ï¼ˆeventual consistencyï¼‰ã€ã€‚åœ¨æ­¥é©Ÿ 3 ä¹‹å¾Œï¼Œå¯èƒ½é‚„æœƒæœ‰çŸ­æš«çš„æ™‚é–“æ¡ç”¨èˆŠçš„è·¯ç”±ï¼Œä½†æ˜¯é€™æ®µæ™‚é–“é€šå¸¸ä¸æœƒå¤ªä¹…ï¼ˆå¹¾åæˆ–å¹¾ç™¾æ¯«ç§’å…§ï¼Œæˆ–è¨±æ›´çŸ­ï¼‰ã€‚</li>
<li>ç‚ºäº†é¿å…è³‡æ–™ä¸ä¸€è‡´ï¼Œç•¶ç¨‹åºåµæ¸¬åˆ°èˆ‡æ§åˆ¶é€šé“çš„ä½‡åˆ—æœ‰é‡æ–°é€£ç·šçš„æƒ…å½¢æ™‚ï¼Œæœƒå°‡å¿«å–å…§å®¹å®Œå…¨æ¸…ç©ºï¼Œç­‰ cache-miss çš„æ™‚å€™å¾è³‡æ–™åº«è®€å–è³‡æ–™ã€‚</li>
</ul>
<blockquote>
<p><a href="arch/../guide/configuration.html"><strong>è¨­å®šæª”</strong></a> ç« ç¯€ä¸­çš„ <code>mqChannels</code>ï¼Œè£¡é¢æœ‰è¨±å¤šé—œæ–¼å„å€‹ API å°æ‡‰çš„æ§åˆ¶é€šé“è¨­å®šã€‚</p>
</blockquote>
<p>é è‘—ç¨‹åºå…§çš„è®Šæ•¸ä½œç‚ºå¿«å–ï¼Œæ­£æ˜¯ Sylvia-IoT Broker å¯ä»¥åšåˆ°é«˜æ•ˆè½‰ç™¼çš„ç§˜è¨£å”· ğŸ˜Šã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é–‹ç™¼æŒ‡å—"><a class="header" href="#é–‹ç™¼æŒ‡å—">é–‹ç™¼æŒ‡å—</a></h1>
<p>æœ¬ç« å…§å®¹ï¼š</p>
<ul>
<li>OAuth2 èªè­‰æµç¨‹ã€‚</li>
<li>é–‹ç™¼ç¶²è·¯æœå‹™ã€‚</li>
<li>é–‹ç™¼æ‡‰ç”¨æœå‹™ã€‚</li>
<li>é–‹ç™¼å’Œè²¢ç» Sylvia-IoT æ ¸å¿ƒã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="oauth2-èªè­‰"><a class="header" href="#oauth2-èªè­‰">OAuth2 èªè­‰</a></h1>
<p>Sylvia-IoT çš„ HTTP API éœ€è¦é€é OAuth2 å–å¾—ä»¤ç‰Œï¼ˆaccess tokenï¼‰ä¾†å­˜å–ã€‚ä»¥ä¸‹åˆ—å‡ºå¹¾ç¨®éœ€è¦ä½¿ç”¨ OAuth2 èªè­‰å’Œå–å¾—æˆæ¬Šä»¤ç‰Œçš„å ´æ™¯ï¼š</p>
<ul>
<li>å­˜å– Sylvia-IoT HTTP API</li>
<li>é–‹ç™¼ç¶²è·¯ã€æ‡‰ç”¨éœ€è¦æ•´åˆ <strong>sylvia-iot-auth</strong> çš„ä½¿ç”¨è€…å¸³è™Ÿä»¥åŠä»¤ç‰Œèªè­‰ã€‚</li>
</ul>
<p><strong>sylvia-iot-auth</strong> æä¾›äº†åŸºæœ¬çš„ç™»å…¥å’Œæˆæ¬Šé é¢ï¼Œæœ¬ç« ä¹Ÿæœƒæè¿°å¦‚ä½•é–‹ç™¼è‡ªå·±éœ€è¦çš„é é¢ã€‚</p>
<h2 id="é–‹å§‹ä¹‹å‰"><a class="header" href="#é–‹å§‹ä¹‹å‰">é–‹å§‹ä¹‹å‰</a></h2>
<p>åœ¨é€™ä¹‹å‰æ‚¨éœ€è¦å…ˆå»ºç«‹ç¬¬ä¸€å€‹å¸³è™Ÿå’Œå®¢æˆ¶ç«¯ã€‚åœ¨ <a href="dev/../guide/quick.html"><strong>å¿«é€Ÿé–‹å§‹</strong></a> æˆ‘å€‘å»ºç«‹äº†å¦‚ä¸‹çš„è³‡æºï¼š</p>
<ul>
<li>ä½¿ç”¨è€…å¸³è™Ÿï¼šåç¨±æ˜¯ <strong>admin</strong>ï¼Œå¯†ç¢¼æ˜¯ <strong>admin</strong>ã€‚</li>
<li>å®¢æˆ¶ç«¯ï¼šID æ˜¯ <strong>public</strong>ï¼Œé‡æ–°è½‰å‘ä½å€æ˜¯ <strong>http://localhost:1080/auth/oauth2/redirect</strong>ã€‚</li>
</ul>
<p>ä½¿ç”¨ <strong>coremgr-cli</strong> å¯ä»¥ä½¿ç”¨ä¸Šè¿°çš„è³‡è¨Šå–å¾—ä»¤ç‰Œï¼Œå¦‚æœæ‚¨æƒ³å»ºç«‹è‡ªå·±çš„å¸³è™Ÿå’Œå®¢æˆ¶ç«¯ï¼Œé™¤äº†ä½¿ç”¨ CLIï¼Œä»¥ä¸‹å°‡èªªæ˜å¸³è™Ÿçš„ç´°ç¯€ã€‚</p>
<ul>
<li>å¸³è™Ÿçš„éƒ¨åˆ†ï¼Œå¯†ç¢¼æ˜¯çµåˆäº† <strong>é¹½</strong>ï¼ˆsaltï¼‰å’Œ <a href="https://en.wikipedia.org/wiki/PBKDF2"><strong>PBKDF2</strong></a> åŠ å¯†çš„çµæœï¼Œè¿­ä»£æ¬¡æ•¸ <strong>10000</strong>ã€‚
æŠŠ <code>salt</code> å’Œ <code>password</code> æ›¿æ›æˆæ‚¨æŒ‡å®šçš„é¹½å’Œé›œæ¹Šé‹ç®—å¾Œçš„å¯†ç¢¼å³å¯ã€‚å…¶ä»–æ¬„ä½ä¹Ÿå¯ä»¥æ›¿æ›æˆæ‚¨æŒ‡å®šçš„ã€‚</li>
<li>å®¢æˆ¶ç«¯çš„éƒ¨åˆ†ï¼Œæ›¿æ› <code>clientId</code> å’Œ <code>redirectUri</code>ã€‚é‡æ–°å°å‘ç¶²å€ï¼ˆredirect URIï¼‰çš„éƒ¨åˆ†éœ€è¦å¸¶å…¥å®¢æˆ¶ç«¯çš„ä½å€ã€‚
å‡å¦‚æ‚¨çš„æœå‹™éœ€è¦é€é <strong>http://localhost</strong> æˆ–æ˜¯ <strong>https://network.example.com</strong> å­˜å–ï¼Œä¸”æ¥æ”¶ authorization code çš„è·¯å¾‘åœ¨ <strong>/network/redirect</strong>ï¼Œé‚£å…§å®¹å¯ä»¥å¡«å…¥ <code>["http://localhost/network/redirect","https://network.example.com/network/redirect"]</code>ã€‚</li>
</ul>
<h2 id="ä½¿ç”¨ç€è¦½å™¨å’Œ-curl"><a class="header" href="#ä½¿ç”¨ç€è¦½å™¨å’Œ-curl">ä½¿ç”¨ç€è¦½å™¨å’Œ curl</a></h2>
<p>é€™è£¡æˆ‘å€‘ä»‹ç´¹å¦‚ä½•ç™»å…¥å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦å–å¾—æœƒè©± IDï¼ˆsession IDï¼‰ä¾†é€²å…¥æˆæ¬Šé é¢å–å–å¾—ä»¤ç‰Œï¼Œä»¥ä¸‹ç¯„ä¾‹æ¡ç”¨ <a href="dev/../guide/quick.html"><strong>å¿«é€Ÿé–‹å§‹</strong></a> å»ºç«‹çš„å¸³è™Ÿå’Œå®¢æˆ¶ç«¯ã€‚</p>
<p>æ‰“é–‹ç€è¦½å™¨ï¼Œç¶²å€è¼¸å…¥ <code>http://localhost:1080/auth/oauth2/auth?response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A1080%2Fauth%2Foauth2%2Fredirect&amp;client_id=public</code></p>
<p>è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ï¼Œå¦‚æœèƒ½å°å‘åˆ°æˆæ¬Šç•«é¢å°±è¡¨ç¤ºç™»å…¥æˆåŠŸã€‚æ­¤æ™‚ç•«é¢æœƒå°å‡ºæ­¤å®¢æˆ¶ç«¯éœ€è¦ä½¿ç”¨çš„ API scopeï¼Œå¦‚æœåŒæ„å°±æŒ‰ä¸‹ <strong>Accept</strong> æŒ‰éˆ•ï¼Œæ¥è‘—ç€è¦½å™¨çš„ç¶²å€æœƒå‘ˆç¾å¦‚ä¸‹çš„æ¨£å­ï¼ˆæ‚¨çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>http://localhost:1080/auth/oauth2/redirect?code=62a801a7d6ceaf2d1018cbac60a6b3d1744295016214bfec6214397d73368278
</code></pre>
<p>å…¶ä¸­ <code>code</code> å°±æ˜¯ authorization codeï¼Œè«‹æ–¼ 30 ç§’å…§ä½¿ç”¨ curl æŒ‡ä»¤å–å¾—ä»¤ç‰Œï¼š</p>
<pre><code class="language-shell">curl -X POST http://localhost:1080/auth/oauth2/token -d 'grant_type=authorization_code&amp;code=62a801a7d6ceaf2d1018cbac60a6b3d1744295016214bfec6214397d73368278&amp;redirect_uri=http%3A%2F%2Flocalhost%3A1080%2Fauth%2Foauth2%2Fredirect&amp;client_id=public'
</code></pre>
<p>çœ‹åˆ°ä»¥ä¸‹ç•«é¢è¡¨ç¤ºå–å¾—ä»¤ç‰Œï¼ˆæ‚¨çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>{"access_token":"fecc5af17e254e6c5a561b7acc900c8f0449a42e77f07a19261c2e6cff518ec8","refresh_token":"5905fc23f65ca7ed92bc7be74e33fc3e79cd8bce2c9ef2ef1bb368caaf6c07f0","token_type":"bearer","expires_in":3599,"scope":""}
</code></pre>
<h2 id="ä½¿ç”¨-curl"><a class="header" href="#ä½¿ç”¨-curl">ä½¿ç”¨ curl</a></h2>
<p>å¦‚æœæ‚¨è¦ä½¿ç”¨ curl æŒ‡ä»¤ä¾†è¼”åŠ©ç¨‹å¼é–‹ç™¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å¹¾å€‹æ­¥é©Ÿã€‚å…ˆä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ç™»å…¥ä¸¦å–å¾— session IDï¼š</p>
<pre><code class="language-shell">curl -v -X POST http://localhost:1080/auth/oauth2/login -d 'state=response_type%3Dcode%26client_id%3Dpublic%26redirect_uri%3Dhttp%253A%252F%252Flocalhost%253A1080%252Fauth%252Foauth2%252Fredirect&amp;account=admin&amp;password=admin'
</code></pre>
<p>çœ‹åˆ°å¦‚ä¸‹çš„å›æ‡‰å³è¡¨ç¤ºæˆåŠŸï¼ˆæ‚¨çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>&lt; HTTP/1.1 302 Found
&lt; content-length: 0
&lt; access-control-allow-credentials: true
&lt; location: /auth/oauth2/authorize?response_type=code&amp;client_id=public&amp;redirect_uri=http%3A%2F%2Flocalhost%3A1080%2Fauth%2Foauth2%2Fredirect&amp;session_id=6643a450b4d678f7d0223fde9e118a2733f1958aa3fc55d616ec278e83d7a06a
&lt; vary: Origin, Access-Control-Request-Method, Access-Control-Request-Headers
&lt; access-control-expose-headers: location
&lt; date: Sat, 15 Jul 2023 04:25:21 GMT
</code></pre>
<p>å°‡ <strong>location</strong> ä¸­çš„ <code>session_id</code> å…§å®¹ä¿ç•™ï¼Œä¸¦æ–¼ 60 ç§’å…§å¸¶å…¥ä¸‹ä¸€å€‹ HTTP è«‹æ±‚ï¼š</p>
<pre><code class="language-shell">curl -v -X POST http://localhost:1080/auth/oauth2/authorize -d 'allow=yes&amp;session_id=6643a450b4d678f7d0223fde9e118a2733f1958aa3fc55d616ec278e83d7a06a&amp;client_id=public&amp;response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A1080%2Fauth%2Foauth2%2Fredirect'
</code></pre>
<p>çœ‹åˆ°å¦‚ä¸‹çš„å›æ‡‰å³è¡¨ç¤ºæˆåŠŸï¼ˆæ‚¨çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>&lt; HTTP/1.1 302 Found
&lt; content-length: 0
&lt; access-control-allow-credentials: true
&lt; location: http://localhost:1080/auth/oauth2/redirect?code=eee02ae34b6c93f955ebf244bccec2b7e6534e1a8dc451a2ed92a790be7b14bb
&lt; vary: Origin, Access-Control-Request-Method, Access-Control-Request-Headers
&lt; access-control-expose-headers: location
&lt; date: Sat, 15 Jul 2023 04:40:36 GMT
</code></pre>
<p>å…¶ä¸­ <strong>location</strong> ä¸­çš„ <code>code</code> å°±æ˜¯ authorization codeï¼Œè«‹æ–¼ 30 ç§’å…§ä½¿ç”¨ curl æŒ‡ä»¤å–å¾—ä»¤ç‰Œï¼š</p>
<pre><code class="language-shell">curl -X POST http://localhost:1080/auth/oauth2/token -d 'grant_type=authorization_code&amp;code=eee02ae34b6c93f955ebf244bccec2b7e6534e1a8dc451a2ed92a790be7b14bb&amp;redirect_uri=http%3A%2F%2Flocalhost%3A1080%2Fauth%2Foauth2%2Fredirect&amp;client_id=public'
</code></pre>
<p>çœ‹åˆ°ä»¥ä¸‹ç•«é¢è¡¨ç¤ºå–å¾—ä»¤ç‰Œï¼ˆæ‚¨çš„å…§å®¹æœƒæœ‰äº›ä¸åŒï¼‰ï¼š</p>
<pre><code>{"access_token":"6994982614dc9f6f2bff08169f7636873531686c34c02fbd6bb45655c8f24b13","refresh_token":"387822850a8fa9a474c413b62a17d9f218204ddcaad51ca475448827b83972fe","token_type":"bearer","expires_in":3599,"scope":""}
</code></pre>
<h2 id="èªè­‰æµç¨‹çš„ç«¯é»endpoint"><a class="header" href="#èªè­‰æµç¨‹çš„ç«¯é»endpoint">èªè­‰æµç¨‹çš„ç«¯é»ï¼ˆendpointï¼‰</a></h2>
<ul>
<li><code>GET /auth/oauth2/auth</code>
<ul>
<li>é©—è­‰å®¢æˆ¶ç«¯çš„åŸºæœ¬è¨Šæ¯ï¼ŒæˆåŠŸå°±é‡æ–°å°å‘è‡³ä¸‹ä¸€å€‹ endpointã€‚</li>
<li>Query åƒæ•¸ï¼š
<ul>
<li><code>response_type</code>: å¿…é ˆç‚º <code>code</code>ã€‚</li>
<li><code>client_id</code>: å®¢æˆ¶ç«¯è­˜åˆ¥ç¢¼ã€‚</li>
<li><code>redirect_uri</code>: é‡æ–°å°å‘ä½å€ã€‚æ­¤ä½å€å°‡æ˜¯æ¥æ”¶ authorization code çš„ endpointã€‚</li>
<li><code>scope</code>: (<strong>å¯é¸</strong>) å¸Œæœ›å­˜å–çš„æ¬Šé™ç¯„åœã€‚</li>
<li><code>state</code>: (<strong>å¯é¸</strong>) æœƒåœ¨æ‹¿åˆ° authorization code çš„æ™‚å€™é™„ä¸Šã€‚ä¸€èˆ¬ç”¨ä¾†ä¿ç•™å‰ä¸€æ¬¡æ‰€åœ¨çš„é é¢è¨Šæ¯ï¼Œä¾›ç™»å…¥å¾Œè¿”å›ç”¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>GET /auth/oauth2/login</code>
<ul>
<li>é¡¯ç¤ºå¸³è™Ÿç™»å…¥ç•«é¢ã€‚</li>
<li>Query åƒæ•¸æœƒåœ¨å‰ä¸€å€‹æ­¥é©Ÿå¾Œè‡ªå‹•å¸¶å…¥ã€‚
<ul>
<li><code>state</code>: (è‡ªå‹•ç”¢ç”Ÿ)</li>
</ul>
</li>
<li>æŒ‰ä¸‹ç™»å…¥æŒ‰éˆ•éœ€è¦è§¸ç™¼ä¸‹ä¸€æ­¥çš„ HTTP è«‹æ±‚ã€‚</li>
</ul>
</li>
<li><code>POST /auth/oauth2/login</code>
<ul>
<li>ç™»å…¥å¸³è™Ÿå¯†ç¢¼ï¼ŒæˆåŠŸå°±é‡æ–°å°å‘è‡³ä¸‹ä¸€å€‹ endpointã€‚</li>
<li>HTTP body åƒæ•¸ï¼š
<ul>
<li><code>account</code>: å¸³è™Ÿåç¨±ã€‚</li>
<li><code>password</code>: å¯†ç¢¼ã€‚
<ul>
<li>ç”±æ–¼ä½¿ç”¨æ˜ç¢¼ï¼Œå»ºè­°ä½¿ç”¨ HTTPS ä»¥åŠå¯ä¿¡ä»»çš„ç€è¦½å™¨å…ƒä»¶ï¼ˆwebviewï¼‰ã€‚</li>
</ul>
</li>
<li><code>state</code>: å‰ä¸€å€‹æ­¥é©Ÿä¸­çš„ state å…§å®¹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>GET /auth/oauth2/authorize</code>
<ul>
<li>èªè­‰å®¢æˆ¶ç«¯åƒæ•¸èˆ‡ session IDï¼Œç„¶å¾Œé¡¯ç¤ºå®¢æˆ¶ç«¯çš„æ¬Šé™éœ€æ±‚ã€‚</li>
<li>Query åƒæ•¸æœƒåœ¨å‰ä¸€å€‹æ­¥é©Ÿå¾Œè‡ªå‹•å¸¶å…¥ã€‚
<ul>
<li>(åŒ <code>GET /auth/oauth2/auth</code>)</li>
<li><code>session_id</code>: æ­¤æ¬¡ç™»å…¥æµç¨‹çš„ session IDã€‚ç›®å‰ä¿ç•™ 60 ç§’ã€‚</li>
</ul>
</li>
<li>æŒ‰ä¸‹å…è¨±æˆ–æ‹’çµ•æŒ‰éˆ•éœ€è¦è§¸ç™¼ä¸‹ä¸€æ­¥çš„ HTTP è«‹æ±‚ã€‚</li>
</ul>
</li>
<li><code>POST /auth/oauth2/authorize</code>
<ul>
<li>èªè­‰å®¢æˆ¶ç«¯ä¸¦ç”¢ç”Ÿ authorization codeã€‚æˆåŠŸæˆ–éŒ¯èª¤éƒ½æœƒé‡æ–°å°å‘è‡³å®¢æˆ¶ç«¯æŒ‡å®šçš„ä½å€ã€‚</li>
<li>HTTP body åƒæ•¸ï¼š
<ul>
<li>(åŒ <code>GET /auth/oauth2/authorize</code> query)</li>
<li><code>allow</code>: <code>yes</code> è¡¨ç¤ºå…è¨±ï¼Œå…¶é¤˜è¡¨ç¤ºæ‹’çµ•ã€‚</li>
</ul>
</li>
<li>é‡æ–°å°å‘çš„åƒæ•¸ï¼š
<ul>
<li><code>code</code>: authorization codeã€‚éœ€åœ¨ 30 ç§’å…§å°‡æ­¤å…§å®¹å¸¶å…¥ä¸‹ä¸€æ­¥çš„ HTTP è«‹æ±‚ä¸­ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>POST /auth/oauth2/token</code>
<ul>
<li>èªè­‰å®¢æˆ¶ç«¯è³‡è¨Šä»¥åŠ authorization codeï¼Œä¸¦ç”¢ç”Ÿä»¤ç‰Œã€‚</li>
<li>HTTP body åƒæ•¸ï¼š
<ul>
<li><code>grant_type</code>: å¿…é ˆç‚º <code>authorization_code</code>ã€‚</li>
<li><code>code</code>: authorization code çš„å€¼ã€‚</li>
<li><code>redirect_uri</code>: å®¢æˆ¶ç«¯å¾—é‡æ–°å°å‘ä½å€ã€‚</li>
<li><code>client_id</code>: å®¢æˆ¶ç«¯è­˜åˆ¥ç¢¼ã€‚</li>
</ul>
</li>
<li>å›å‚³å…§å®¹ï¼š
<ul>
<li><code>access_token</code>: ä»¤ç‰Œã€‚å¯å­˜å– Sylvia-IoT HTTP APIã€‚</li>
<li><code>refresh_token</code>: ç•¶ä»¤ç‰Œå¤±æ•ˆæ™‚ï¼Œä»¥æ­¤é‡æ–°å–å¾—ä»¤ç‰Œã€‚</li>
<li><code>token_type</code>: <code>bearer</code>ã€‚</li>
<li><code>expires_in</code>: éæœŸæ™‚é–“ï¼ˆç§’ï¼‰ã€‚</li>
<li><code>scope</code>: å­˜å–æ¬Šé™ç¯„åœã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>POST /auth/oauth2/refresh</code>
<ul>
<li>é‡æ–°å–å¾—ä»¤ç‰Œã€‚</li>
<li>HTTP body åƒæ•¸ï¼š
<ul>
<li><code>grant_type</code>: å¿…é ˆç‚º <code>refresh_token</code>ã€‚</li>
<li><code>refresh_token</code>: refresh token çš„å€¼ã€‚</li>
<li><code>scope</code>: (<strong>å¯é¸</strong>) å­˜å–æ¬Šé™ç¯„åœã€‚</li>
<li><code>client_id</code>: (<strong>å¯é¸</strong>) å®¢æˆ¶ç«¯è­˜åˆ¥ç¢¼ã€‚</li>
</ul>
</li>
<li>å›å‚³å…§å®¹ï¼šåŒ <code>POST /auth/oauth2/token</code> çš„å›å‚³å…§å®¹ã€‚</li>
</ul>
</li>
</ul>
<h2 id="é–‹ç™¼è‡ªå·±çš„æ¨£æ¿"><a class="header" href="#é–‹ç™¼è‡ªå·±çš„æ¨£æ¿">é–‹ç™¼è‡ªå·±çš„æ¨£æ¿</a></h2>
<p>åƒè€ƒ <a href="https://github.com/woofdogtw/sylvia-iot-core/blob/main/sylvia-iot-auth/src/routes/oauth2/template.rs"><strong>åŸå§‹ç‰ˆæœ¬</strong></a> ä¸¦æ³¨æ„è¦é ç•™çš„ Jinja2 è®Šæ•¸ <code>{{ }}</code>ã€‚</p>
<p>åœ¨å¸³è™Ÿç™»å…¥ç•«é¢ï¼Œè«‹é ç•™ä»¥ä¸‹çš„è®Šæ•¸ï¼š</p>
<ul>
<li><code>scope_path</code>: é€™å€‹ç”¨ä¾†æ±ºå®šæŒ‰ä¸‹ã€Œç™»å…¥ã€æŒ‰éˆ•æ™‚è¦ç™¼é€ <code>POST /login</code> è«‹æ±‚çš„ä½å€ã€‚
<ul>
<li>Sylvia-IoT çš„é è¨­æ˜¯ <code>SCHEME://SERVER_HOST/auth</code>ã€‚<code>SCHEME://SERVER_HOST</code> æ˜¯ <code>GET /auth</code> æ™‚å€™çš„è³‡è¨Šã€‚</li>
</ul>
</li>
<li><code>state</code>: ç•¶ <code>GET /auth</code> æˆåŠŸæ™‚ï¼Œ<strong>sylvia-iot-auth</strong> æœƒç”¢ç”Ÿ state å…§å®¹ä¸¦å¸¶å…¥æ¨£æ¿ä¸­ã€‚</li>
</ul>
<p>åœ¨å®¢æˆ¶ç«¯æˆæ¬Šç•«é¢ï¼Œè«‹é ç•™ä»¥ä¸‹çš„è®Šæ•¸ï¼š</p>
<ul>
<li><code>scope_path</code>: é€™å€‹ç”¨ä¾†æ±ºå®šæŒ‰ä¸‹ã€Œç™»å…¥ã€æŒ‰éˆ•æ™‚è¦ç™¼é€ <code>POST /authorize</code> è«‹æ±‚çš„ä½å€ã€‚
<ul>
<li>Sylvia-IoT çš„é è¨­æ˜¯ <code>SCHEME://SERVER_HOST/auth</code>ã€‚<code>SCHEME://SERVER_HOST</code> æ˜¯ <code>POST /login</code> æ™‚å€™çš„è³‡è¨Šã€‚</li>
</ul>
</li>
<li>å…¶é¤˜åƒæ•¸è«‹åƒè€ƒå‰é¢ endpoint ä¸­ <code>GET /auth/oauth2/authorize</code> çš„æ•˜è¿°ã€‚</li>
</ul>
<p>æ‚¨å¯ä»¥åªå¯¦ä½œç™»å…¥æˆ–æ˜¯æˆæ¬Šç¶²é çš„å…§å®¹ï¼Œä¸¦ä¸”æä¾› <a href="dev/../guide/configuration.html"><strong>è¨­å®šæª”</strong></a> ä¸­çš„ä¸‹åˆ—åƒæ•¸ï¼š</p>
<ul>
<li><code>auth.db.templates.login</code>: ç™»å…¥é é¢æ¨£æ¿çš„è·¯å¾‘ã€‚</li>
<li><code>auth.db.templates.grant</code>: æˆæ¬Šé é¢æ¨£æ¿çš„è·¯å¾‘ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç¶²è·¯æœå‹™"><a class="header" href="#ç¶²è·¯æœå‹™">ç¶²è·¯æœå‹™</a></h1>
<p>æœ¬ç« ç¯€ç°¡è¿°é–‹ç™¼ç¶²è·¯æœå‹™çš„å¹¾å€‹è¦é»ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li>è³‡æ–™é€šé“ (Data Channel)</li>
<li>æ§åˆ¶é€šé“ (Control Channel)</li>
<li>Rust ä½¿ç”¨ <a href="https://crates.io/crates/sylvia-iot-sdk"><strong>SDK</strong></a> é€£æ¥é€šé“</li>
</ul>
<p>åœ¨é–‹å§‹æœ¬ç« ä¹‹å‰ï¼Œè«‹å…ˆç¢ºä¿å·²ç¶“ç ”è®€é <a href="dev/../arch/flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€ä¸¦äº†è§£ä½‡åˆ—å’Œç›¸é—œè³‡æ–™çš„ç”¢ç”Ÿèˆ‡æ¶ˆè²»æ™‚æ©Ÿã€‚</p>
<h2 id="ä½‡åˆ—èˆ‡è³‡æ–™æ ¼å¼"><a class="header" href="#ä½‡åˆ—èˆ‡è³‡æ–™æ ¼å¼">ä½‡åˆ—èˆ‡è³‡æ–™æ ¼å¼</a></h2>
<ul>
<li>
<p><a href="https://github.com/woofdogtw/sylvia-iot-core/blob/main/sylvia-iot-broker/doc/message.md#between-broker-and-network"><strong>é€™ä»½æ–‡ä»¶</strong></a> å®šç¾©äº† Broker èˆ‡ç¶²è·¯æœå‹™ä½‡åˆ—çš„è³‡æ–™å…§å®¹ã€‚</p>
</li>
<li>
<p>ç„¡è«–è³‡æ–™é€šé“æˆ–æ§åˆ¶é€šé“ï¼Œéƒ½æ˜¯ä½¿ç”¨å–®æ’­æ¨¡å¼ï¼ˆunicastï¼‰ã€‚ç‰¹æ€§å¦‚ä¸‹ï¼š</p>
<ul>
<li>AMQP å±¬æ€§ï¼š
<ul>
<li>durable: true</li>
<li>exclusive: false</li>
<li>auto-delete: false</li>
<li>ttl: ç”¢ç”Ÿ network æ™‚æ±ºå®š</li>
<li>max-length: ç”¢ç”Ÿ network æ™‚æ±ºå®š</li>
</ul>
</li>
<li>MQTT å±¬æ€§ï¼š
<ul>
<li>QoS: Broker ç«¯ç‚º 1</li>
<li>clean session: Broker ç«¯ç‚º true</li>
</ul>
</li>
</ul>
</li>
<li>
<p>åœ¨ <a href="dev/../arch/flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€æœ‰æåˆ°ï¼Œç¶²è·¯æœå‹™åœ¨è™•ç†ä¸‹è¡Œè³‡æ–™æ™‚éœ€è¦ä¿ç•™ <code>dataId</code>ï¼Œä»¥ä¾¿å¾ŒçºŒå›å ±çµæœã€‚</p>
<ul>
<li>å°æ–¼æœªå›å ±çš„ä¸‹è¡Œè³‡æ–™ï¼Œå° Broker æ²’æœ‰å½±éŸ¿ã€‚
<ul>
<li>ç›®å‰åªä¿ç•™ä¸€å¤©ã€‚å¦‚æ²’æœ‰å›å ±å‰‡æ°¸é å‘ˆç¾æœªå›å ±ç‹€æ…‹ã€‚</li>
</ul>
</li>
<li>æ‡‰ç”¨æœå‹™å¯ä»¥è‡ªè¡Œæ±ºå®šå¤ªä¹…æ²’æœ‰å›å ±çš„ä¸‹è¡Œè³‡æ–™è©²å¦‚ä½•è™•ç†ã€‚</li>
</ul>
</li>
<li>
<p>é—œæ–¼ <code>result</code> çš„è¦å‰‡ï¼š</p>
<ul>
<li>å°æ–¼ 0 è¡¨ç¤ºé€²è¡Œä¸­ã€‚
<ul>
<li>-2: è¡¨ç¤ºè³‡æ–™æ­£åœ¨å¾€ç¶²è·¯æœå‹™å‚³é€ä¸­ã€‚ç”± Broker åœ¨å„²å­˜åˆ°è³‡æ–™åº«å‰è¨­å®šã€‚</li>
<li>-1: è¡¨ç¤ºç¶²è·¯æœå‹™å·²ç¶“æ¥æ”¶åˆ°ã€‚é ˆç”±ç¶²è·¯æœå‹™é€é <code>result</code> ä½‡åˆ—å›å ± -1ã€‚</li>
</ul>
</li>
<li>0 æˆ–æ˜¯æ­£æ•¸è¡¨ç¤ºè™•ç†å®Œæˆã€‚æ­¤æ™‚æœƒå¾ dldata è³‡æ–™åº«ä¸­ç§»é™¤ï¼Œä¹‹å¾Œçš„ä»»ä½•å›å ±éƒ½ç„¡æ³•å†å‚³å›æ‡‰ç”¨ç«¯ã€‚
<ul>
<li>éƒ½ç”±ç¶²è·¯æœå‹™å›å ±ã€‚</li>
<li>0: æˆåŠŸç™¼é€åˆ°è£ç½®ç«¯ï¼Œæˆ–æ˜¯è£ç½®ç«¯å›è¦†äº†æˆåŠŸã€‚</li>
<li>æ­£æ•¸: ç„¡æ³•ç™¼é€åˆ°è£ç½®ç«¯ï¼Œæˆ–æ˜¯è£ç½®ç«¯å›è¦†äº†éŒ¯èª¤ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç”±æ–¼ç›®å‰æ˜¯ç”±ç¶²è·¯æœå‹™å®šç¾©çµæœï¼Œæ‡‰ç”¨ç«¯ä»éœ€çŸ¥é“è©²è£ç½®ç›®å‰ç¶å®šåˆ°å“ªå€‹ç¶²è·¯ã€‚å»ºè­°é–‹ç™¼ç¶²è·¯æœå‹™æ™‚ï¼Œè·Ÿè‘—ä»¥ä¸Šçš„è¦å‰‡ï¼Œå¯ä»¥è®“æ‡‰ç”¨ç«¯çš„å‘ˆç¾æ›´åŠ ä¸€è‡´åŒ–ã€‚</p>
</blockquote>
</li>
</ul>
<h2 id="rust-ä½¿ç”¨-sdk"><a class="header" href="#rust-ä½¿ç”¨-sdk">Rust ä½¿ç”¨ SDK</a></h2>
<p>é‡å° Rust é–‹ç™¼äººå“¡ï¼Œç›®å‰æä¾›äº† SDK å”åŠ©é–‹ç™¼äººå“¡é–‹ç™¼ç¶²è·¯æœå‹™ï¼Œåœ¨ <a href="dev/../appendex/repo.html"><strong>é™„éŒ„</strong></a> ç« ç¯€ä¹Ÿæœ‰æä¾›ä½¿ç”¨ç¯„ä¾‹ã€‚é€™è£¡ä»‹ç´¹å¹¾å€‹ä½¿ç”¨çš„æŠ€å·§ï¼š</p>
<ul>
<li>é€šé“çš„ç¶­è­·éƒ½å¯«åœ¨ <code>mq</code> æ¨¡çµ„ä¸­çš„ <code>NetworkMgr</code> ä¸­ã€‚</li>
<li>ä¸€å€‹ <code>NetworkMgr</code> å°æ‡‰ä¸€å€‹ç¶²è·¯æœå‹™ã€‚</li>
<li>åªè¦ç®¡ç† <code>NetworkMgr</code> å³å¯ï¼Œç„¡éœ€è‡ªè¡Œç®¡ç†æ‰€æœ‰ä½‡åˆ—çš„é€£ç·šç‹€æ…‹å’Œ AMQP/MQTT çš„å±¬æ€§ã€‚</li>
<li>è¨»å†Š <code>EventHandler</code> å¯å³æ™‚æ–¼ä½‡åˆ—ç‹€æ…‹æ”¹è®Šæˆ–æ˜¯è³‡æ–™é€é”æ™‚æ”¶åˆ°ã€‚</li>
<li>å¯ä»¥é€é <code>send_uldata()</code> å’Œ <code>send_dldata_result()</code> å‚³é€è³‡æ–™çµ¦ Brokerã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ‡‰ç”¨æœå‹™"><a class="header" href="#æ‡‰ç”¨æœå‹™">æ‡‰ç”¨æœå‹™</a></h1>
<p>æœ¬ç« ç¯€ç°¡è¿°é–‹ç™¼æ‡‰ç”¨æœå‹™çš„å¹¾å€‹è¦é»ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li>è³‡æ–™é€šé“ (Data Channel)</li>
<li>Rust ä½¿ç”¨ <a href="https://crates.io/crates/sylvia-iot-sdk"><strong>SDK</strong></a> é€£æ¥é€šé“</li>
</ul>
<p>åœ¨é–‹å§‹æœ¬ç« ä¹‹å‰ï¼Œè«‹å…ˆç¢ºä¿å·²ç¶“ç ”è®€é <a href="dev/../arch/flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€ä¸¦äº†è§£ä½‡åˆ—å’Œç›¸é—œè³‡æ–™çš„ç”¢ç”Ÿèˆ‡æ¶ˆè²»æ™‚æ©Ÿã€‚</p>
<h2 id="ä½‡åˆ—èˆ‡è³‡æ–™æ ¼å¼-1"><a class="header" href="#ä½‡åˆ—èˆ‡è³‡æ–™æ ¼å¼-1">ä½‡åˆ—èˆ‡è³‡æ–™æ ¼å¼</a></h2>
<ul>
<li><a href="https://github.com/woofdogtw/sylvia-iot-core/blob/main/sylvia-iot-broker/doc/message.md#between-broker-and-application"><strong>é€™ä»½æ–‡ä»¶</strong></a> å®šç¾©äº† Broker èˆ‡æ‡‰ç”¨æœå‹™ä½‡åˆ—çš„è³‡æ–™å…§å®¹ã€‚</li>
<li>è³‡æ–™é€šé“ä½¿ç”¨å–®æ’­æ¨¡å¼ï¼ˆunicastï¼‰ã€‚ç‰¹æ€§å¦‚ä¸‹ï¼š
<ul>
<li>AMQP å±¬æ€§ï¼š
<ul>
<li>durable: true</li>
<li>exclusive: false</li>
<li>auto-delete: false</li>
<li>ttl: ç”¢ç”Ÿ network æ™‚æ±ºå®š</li>
<li>max-length: ç”¢ç”Ÿ network æ™‚æ±ºå®š</li>
</ul>
</li>
<li>MQTT å±¬æ€§ï¼š
<ul>
<li>QoS: Broker ç«¯ç‚º 1</li>
<li>clean session: Broker ç«¯ç‚º true</li>
</ul>
</li>
</ul>
</li>
<li>åœ¨ <a href="dev/../arch/flow.html"><strong>è³‡æ–™æµ</strong></a> ç« ç¯€æœ‰æåˆ°ï¼Œä¸‹è¡Œè³‡æ–™é€é <code>dldata</code> ä½‡åˆ—å‚³é€çµ¦ Broker å¾Œï¼ŒBroker æœƒç«‹å³å›å ±çµæœã€‚
<ul>
<li><code>correlationId</code> å»ºè­°å”¯ä¸€ã€‚å¦‚æœæ‡‰ç”¨æœå‹™åŒæ™‚ç™¼é€å¤§é‡çš„ä¸‹è¡Œè³‡æ–™ï¼Œå°±è¦é æ­¤ correlation ID æ‰èƒ½è¿½è¹¤æ¯ä¸€ç­†çš„å‚³è¼¸æ˜¯å¦æœ‰è¢«æ­£ç¢ºé€å¾€ç¶²è·¯æœå‹™ã€‚</li>
<li>å¦‚æœæœ‰æˆåŠŸè¢«è™•ç†ï¼Œå°‡æœƒå›æ‡‰ <code>dataId</code>ã€‚æ‡‰ç”¨æœå‹™å¯ä»¥é€éè³‡æ–™ ID è¿½è¹¤é€™ç­†ä¸‹è¡Œè³‡æ–™åœ¨ç¶²è·¯æœå‹™çš„è™•ç†æƒ…å½¢ã€‚</li>
</ul>
</li>
<li>ä¸‹è¡Œè³‡æ–™ä¸­ï¼Œå¯ä»¥é¸æ“‡ä½¿ç”¨ <code>deviceId</code> æˆ–æ˜¯ <code>networkCode</code>+<code>networkAddr</code> çš„æ–¹å¼æŒ‡å®šç›®çš„è£ç½®ã€‚
<ul>
<li>å¦‚æœè£ç½®æ˜¯åœ¨ <strong>å…¬ç”¨ç¶²è·¯</strong> ä¸Šï¼Œä¸€å®šè¦ä½¿ç”¨ <code>deviceId</code>ã€‚Sylvia-IoT ç”¨é€™æ–¹å¼é¿å…æ‡‰ç”¨æœå‹™ä»»æ„å‚³è¼¸è³‡æ–™åˆ°ä¸å±¬æ–¼ä»–å€‘å–®ä½çš„è£ç½®ã€‚</li>
</ul>
</li>
<li>ç›®å‰é‚„æ²’æœ‰æ”¯æ´æ§åˆ¶é€šé“ã€‚è£ç½®çš„è®Šæ›´å°±è¦ä¾é æ‡‰ç”¨æœå‹™è‡ªè¡Œè«‹æ±‚ Sylvia-IoT HTTP APIï¼Œæˆ–æ˜¯è‡ªå·±ç¶­è­·è£ç½®çš„åˆ—è¡¨ã€‚</li>
</ul>
<h2 id="rust-ä½¿ç”¨-sdk-1"><a class="header" href="#rust-ä½¿ç”¨-sdk-1">Rust ä½¿ç”¨ SDK</a></h2>
<p>é‡å° Rust é–‹ç™¼äººå“¡ï¼Œç›®å‰æä¾›äº† SDK å”åŠ©é–‹ç™¼äººå“¡é–‹ç™¼æ‡‰ç”¨æœå‹™ï¼Œåœ¨ <a href="dev/../appendex/repo.html"><strong>é™„éŒ„</strong></a> ç« ç¯€ä¹Ÿæœ‰æä¾›ä½¿ç”¨ç¯„ä¾‹ã€‚é€™è£¡ä»‹ç´¹å¹¾å€‹ä½¿ç”¨çš„æŠ€å·§ï¼š</p>
<ul>
<li>é€šé“çš„ç¶­è­·éƒ½å¯«åœ¨ <code>mq</code> æ¨¡çµ„ä¸­çš„ <code>ApplicationMgr</code> ä¸­ã€‚</li>
<li>ä¸€å€‹ <code>ApplicationMgr</code> å°æ‡‰ä¸€å€‹æ‡‰ç”¨æœå‹™ã€‚</li>
<li>åªè¦ç®¡ç† <code>ApplicationMgr</code> å³å¯ï¼Œç„¡éœ€è‡ªè¡Œç®¡ç†æ‰€æœ‰ä½‡åˆ—çš„é€£ç·šç‹€æ…‹å’Œ AMQP/MQTT çš„å±¬æ€§ã€‚</li>
<li>è¨»å†Š <code>EventHandler</code> å¯å³æ™‚æ–¼ä½‡åˆ—ç‹€æ…‹æ”¹è®Šæˆ–æ˜¯è³‡æ–™é€é”æ™‚æ”¶åˆ°ã€‚</li>
<li>å¯ä»¥é€é <code>send_dldata()</code> å‚³é€è³‡æ–™çµ¦ Brokerã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sylvia-iot-æ ¸å¿ƒ"><a class="header" href="#sylvia-iot-æ ¸å¿ƒ">Sylvia-IoT æ ¸å¿ƒ</a></h1>
<p>å¦‚æœæ‚¨å° Sylvia-IoT æœ‰èˆˆè¶£ï¼Œä¸”å¸Œæœ›èƒ½é–‹ç™¼æ ¸å¿ƒï¼ˆå°±æ˜¯ ABCD ğŸ˜Šï¼‰çš„ç›¸é—œåŠŸèƒ½ï¼Œæœ¬ç« ç¯€å°‡ä»‹ç´¹ä¸€äº›ç¨‹å¼ç¢¼çš„çµæ§‹å’Œæ³¨æ„äº‹é …ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç›®éŒ„çµæ§‹"><a class="header" href="#ç›®éŒ„çµæ§‹">ç›®éŒ„çµæ§‹</a></h1>
<p>é€™è£¡èªªæ˜ Sylvia-IoT å„å€‹å…ƒä»¶çš„ç›®éŒ„å’Œæª”æ¡ˆçš„ç·¨æ’çµæ§‹ã€‚</p>
<pre><code>[project]/
â”œâ”€â”€ doc/
â”‚   â”œâ”€â”€ api.md
â”‚   â”œâ”€â”€ cache.md
â”‚   â”œâ”€â”€ message.md
â”‚   â””â”€â”€ schema.md
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bin/
â”‚   â”‚   â”œâ”€â”€ [project].rs
â”‚   â”‚   â”œâ”€â”€ [bin1].rs
â”‚   â”‚   â”œâ”€â”€ [bin2].rs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ libs/
â”‚   â”‚   â”œâ”€â”€ config..rs
â”‚   â”‚   â”œâ”€â”€ [lib1]/
â”‚   â”‚   â”œâ”€â”€ [lib2].rs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ [engine1]/
â”‚   â”‚   â”‚   â”œâ”€â”€ [table1].rs
â”‚   â”‚   â”‚   â”œâ”€â”€ [table2].rs
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ [engine2]/
â”‚   â”‚   â”‚   â”œâ”€â”€ [table1].rs
â”‚   â”‚   â”‚   â”œâ”€â”€ [table2].rs
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ [table1].rs
â”‚   â”‚   â”œâ”€â”€ [table2].rs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ v1/
â”‚       â”‚   â”œâ”€â”€ [api1]/
â”‚       â”‚   â”‚   â”œâ”€â”€ api.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ request.rs
â”‚       â”‚   â”‚   â””â”€â”€ response.rs
â”‚       â”‚   â”œâ”€â”€ [api2]/
â”‚       â”‚   â”‚   â”œâ”€â”€ api.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ request.rs
â”‚       â”‚   â”‚   â””â”€â”€ response.rs
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ v2/
â”‚       â”œâ”€â”€ [non-versioned-api]/
â”‚       â”œâ”€â”€ ...
â”‚       â””â”€â”€ middleware.rs
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ libs/
â”‚   â”‚   â”œâ”€â”€ config..rs
â”‚   â”‚   â”œâ”€â”€ [lib1]/
â”‚   â”‚   â”œâ”€â”€ [lib2].rs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ [engine1]/
â”‚   â”‚   â”‚   â”œâ”€â”€ [table1].rs
â”‚   â”‚   â”‚   â”œâ”€â”€ [table2].rs
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ [engine2]/
â”‚   â”‚   â”‚   â”œâ”€â”€ [table1].rs
â”‚   â”‚   â”‚   â”œâ”€â”€ [table2].rs
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ [table1].rs
â”‚   â”‚   â”œâ”€â”€ [table2].rs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ v1/
â”‚       â”‚   â”œâ”€â”€ [api1]/
â”‚       â”‚   â”‚   â”œâ”€â”€ api.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ request.rs
â”‚       â”‚   â”‚   â””â”€â”€ response.rs
â”‚       â”‚   â”œâ”€â”€ [api2]/
â”‚       â”‚   â”‚   â”œâ”€â”€ api.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ request.rs
â”‚       â”‚   â”‚   â””â”€â”€ response.rs
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ v2/
â”‚       â”œâ”€â”€ [non-versioned-api]/
â”‚       â”œâ”€â”€ ...
â”‚       â””â”€â”€ middleware.rs
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ LICENSE
â””â”€â”€ README.md
</code></pre>
<p>é€™é‚Šåˆ—å‡ºå¹¾å€‹è¦é»ï¼š</p>
<ul>
<li><code>bin</code>: è¦æœ‰ä¸€å€‹å’Œå°ˆæ¡ˆåŒåçš„ rs æª”æ¡ˆã€‚</li>
<li><code>doc</code>: å®Œæ•´çš„æ–‡ä»¶è¦æ”¾åœ¨é€™ã€‚</li>
<li><code>libs</code>: è³‡æ–™åº«ã€API ä»¥å¤–çš„æ”¾åœ¨é€™è£¡ã€‚</li>
<li><code>models</code>: ä»¥è¡¨æ ¼ç‚ºä¸»çš„è¨­è¨ˆï¼Œä¸¦ä½¿ç”¨è³‡æ–™åº«å¼•æ“å€éš”ã€‚</li>
<li><code>routes</code>: HTTP API çš„å¯¦ä½œã€‚
<ul>
<li>é™¤äº†å¯¦ä½œæ¨™æº– APIï¼Œå¦‚ OAuth2ï¼Œå…¶ä»–éƒ½éœ€è¦ç”¨ç‰ˆæœ¬ä¾†å€éš”ã€‚</li>
</ul>
</li>
<li><code>tests</code>: å’Œ <code>src</code> ä¸€ä¸€å°æ‡‰ã€‚</li>
</ul>
<h2 id="ç›¸ä¾æ€§"><a class="header" href="#ç›¸ä¾æ€§">ç›¸ä¾æ€§</a></h2>
<ul>
<li>libsã€models ä¸ç›¸ä¾å…¶ä»–è³‡æ–™å¤¾ã€‚</li>
<li>routes
<ul>
<li>æ•´å€‹å°ˆæ¡ˆç¨‹å¼ç¢¼çš„åˆå§‹åŒ–é›†ä¸­åœ¨ <code>routes/mod.rs</code>ã€‚</li>
<li>é™¤äº†å¯ä»¥è®“ main.rs åšæœ€å°‘çš„äº‹æƒ…ï¼Œä¹Ÿèƒ½å¢åŠ æ•´åˆæ¸¬è©¦çš„è¦†è“‹ç¯„åœã€‚</li>
</ul>
</li>
<li>models å…§éƒ¨çš„æ¨¡çµ„å½¼æ­¤ä¸ç›¸ä¾ã€‚å¦‚æœ‰å…±ç”¨åŠŸèƒ½ï¼Œè«‹åœ¨çˆ¶æ¨¡çµ„å¯¦ç¾ç„¶å¾Œå¼•ç”¨ã€‚routes å…§éƒ¨çš„æ¨¡çµ„äº¦åŒã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç¨‹å¼ç¢¼é¢¨æ ¼"><a class="header" href="#ç¨‹å¼ç¢¼é¢¨æ ¼">ç¨‹å¼ç¢¼é¢¨æ ¼</a></h1>
<h2 id="ä½¿ç”¨-rustfmt"><a class="header" href="#ä½¿ç”¨-rustfmt">ä½¿ç”¨ rustfmt</a></h2>
<p>æ‰€æœ‰æª”æ¡ˆè«‹ <strong>ä¸€å®š</strong> è¦ä½¿ç”¨ <code>rustfmt</code> æ ¼å¼åŒ–ã€‚é€™é‚Šå»ºè­°ä½¿ç”¨ VSCode æ­é… <strong>rust-analyzer æ“´å……</strong> ä¾†æ’°å¯«ç¨‹å¼ç¢¼ã€‚</p>
<p>ä»¥ä¸‹æä¾›ç­†è€…çš„é–‹ç™¼ç’°å¢ƒä¾›å¤§å®¶åƒè€ƒï¼š</p>
<ul>
<li>
<p>VSCode æ“´å……</p>
<ul>
<li><strong>CodeLLDB</strong> (Vadim Chugunov)</li>
<li><strong>crates</strong> (Seray Uzgur)</li>
<li><strong>Docker</strong> (Microsoft)</li>
<li><strong>GitHub Actions</strong> (Mathieu Dutour)</li>
<li><strong>rust-analyzer</strong> (The Rust Programming Language)</li>
<li><strong>YAML</strong> (Red Hat)</li>
</ul>
</li>
<li>
<p>VSCode è¨­å®š</p>
<pre><code class="language-json">{
    "crates.listPreReleases": true,
    "editor.formatOnSave": true,
    "editor.renderWhitespace": "all",
    "editor.roundedSelection": false,
    "editor.tabSize": 4,
    "files.eol": "\n",
    "rust-analyzer.inlayHints.chainingHints.enable": false,
    "rust-analyzer.inlayHints.closingBraceHints.enable": false,
    "rust-analyzer.inlayHints.parameterHints.enable": false,
    "rust-analyzer.inlayHints.typeHints.enable": false,
    "rust-analyzer.server.extraEnv": {
        "RUSTFLAGS": "-C instrument-coverage"
    }
}
</code></pre>
<blockquote>
<p>ä½¿ç”¨ <code>-C instrument-coverage</code> ç’°å¢ƒè®Šæ•¸ï¼Œæ˜¯å› ç‚ºç­†è€…åŸ·è¡Œæ¸¬è©¦éœ€è¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Šï¼Œæ·»åŠ é€™å€‹å¯ä»¥é¿å…å­˜æª”å’Œæ¸¬è©¦è§¸ç™¼é‡æ–°ç·¨è­¯ã€‚ä¸‹é¢æ˜¯æ¸¬è©¦çš„æŒ‡ä»¤ï¼š</p>
<p><code>RUSTFLAGS="-C instrument-coverage" cargo test -p $PROJ --test integration_test -- --nocapture</code></p>
</blockquote>
</li>
</ul>
<h2 id="mvc-vs-å¾®æœå‹™"><a class="header" href="#mvc-vs-å¾®æœå‹™">MVC vs. å¾®æœå‹™</a></h2>
<p>æœ¬äººç¿’æ…£ bottom-up çš„é–‹ç™¼æ¨¡å¼ã€‚ä½¿ç”¨åƒæ˜¯ MVC é€™æ¨£å°‡è³‡æ–™åº«è¨­è¨ˆç‚ºåº•å±¤çš„é€šç”¨ä»‹é¢ã€ä¸¦ä¸”ç”± API ä¸Šå±¤ä¾æ“šå…¶æ‰€éœ€å‘¼å«ä¾†å¯¦ç¾å„ç¨®åŠŸèƒ½ï¼Œæ¯”è¼ƒç¬¦åˆæœ¬äººç¿’æ…£çš„é¢¨æ ¼ã€‚
é€™å°±æ˜¯ <code>models</code>ã€<code>routes</code> çš„ç”±ä¾†ã€‚</p>
<p>ä¸éåœ¨è¨­è¨ˆæ•´å€‹ Sylvia-IoT å¹³å°æ™‚ï¼Œä¹Ÿæ˜¯ç›¡å¯èƒ½æœå‘æ¨¡çµ„åŒ–çš„æ–¹å‘é€²è¡Œï¼Œæ–¼æ˜¯æ¡ç”¨äº†å¾®æœå‹™çš„æ–¹å¼è¨­è¨ˆï¼ˆå°±æ˜¯ ABCDï¼‰ï¼Œä¸¦ä¸”åš´æ ¼éµå®ˆæ¨¹ç‹€ç›¸ä¾çš„åŸå‰‡ã€‚</p>
<p>å³ä½¿æ˜¯å¾®æœå‹™çš„æ¶æ§‹ï¼Œå¦‚å‰ä¸€ç« ç¯€ <a href="dev/dir.html"><strong>ç›®éŒ„çµæ§‹</strong></a> æ‰€è¿°ï¼Œåªè¦ main.rs å¼•ç”¨äº†éœ€è¦çš„ routesï¼Œä¾èˆŠå¯ä»¥ç·¨è­¯æˆå–®ä¸€å¯åŸ·è¡Œæª”ä¸¦æ”¾åœ¨ä¸€å°æ©Ÿå™¨ä¸­åŸ·è¡Œã€‚
é€™æ¨£çš„è¨­è¨ˆå„ªé»åœ¨æ–¼éƒ¨ç½²çš„æ–¹å¼å¯ä»¥å¾ˆéˆæ´»ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>å–®é«”ï¼šå–®ä¸€æ©Ÿå™¨åŸ·è¡Œå–®ä¸€ all-in-one å¯åŸ·è¡Œæª”ã€‚</li>
<li>å¾®æœå‹™å¢é›†ï¼šå°‡å„å€‹å…ƒä»¶ç¨ç«‹é‹è¡Œåœ¨å„å€‹æ©Ÿå™¨ä¸­ï¼Œä¸”æ¯å€‹å…ƒä»¶å¯ä»¥è‡ªå·±æ¶è¨­å¢é›†ã€‚</li>
<li>å–®é«”å¢é›†ï¼šå°‡ all-in-one é‹ä½œåœ¨å¤šå°æ©Ÿå™¨ä¸­ï¼Œå½¢æˆå¢é›†çš„æ¶æ§‹ã€‚</li>
</ul>
<p>Sylvia-IoT å°±æ˜¯é›† MVC èˆ‡å¾®æœå‹™æ–¼ä¸€èº«çš„è¨­è¨ˆ ğŸ˜Šã€‚</p>
<h2 id="æª”æ¡ˆå…§å®¹ç·¨æ’"><a class="header" href="#æª”æ¡ˆå…§å®¹ç·¨æ’">æª”æ¡ˆå…§å®¹ç·¨æ’</a></h2>
<p>æ¯ä¸€å€‹ rs çš„æª”æ¡ˆå…§å®¹æœƒä»¥å¦‚ä¸‹çš„æ–¹å¼ç·¨æ’ï¼Œæ¯ä¸€å€‹å€å¡Šä¹‹é–“è¦æœ‰ç©ºç™½è¡Œéš”é–‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use rust_builtin_modules;

use 3rd_party_modules;

use sylvia_iot_modules;

use crate_modules;

pub struct PubStructEnums {}

struct PrvStructEnums {}

pub const PUB_CONSTANTS;

const PRV_CONSTANTS;

pub pub_static_vars;

static prv_static_vars;

impl PubStructEnums {}

pub fn pub_funcs {}

impl PrvStructEnums {}

fn prv_funcs {}
<span class="boring">}</span></code></pre></pre>
<p>å¤§è‡´ä¸Šçš„é †åºå°±æ˜¯ï¼š</p>
<ul>
<li>å¼•ç”¨æ¨¡çµ„</li>
<li>çµæ§‹</li>
<li>å¸¸æ•¸</li>
<li>è®Šæ•¸</li>
<li>å‡½æ•¸ï¼ˆåŒ…å«çµæ§‹çš„å‡½æ•¸å¯¦ä½œï¼‰</li>
</ul>
<p>è€Œå…¶ä¸­åˆä»¥ <code>pub</code> æ”¾åœ¨ private å‰é¢ã€‚</p>
<h2 id="model"><a class="header" href="#model">Model</a></h2>
<p>Model å±¤å¿…é ˆæä¾›çµ±ä¸€çš„ struct ä»¥åŠ trait ä»‹é¢ã€‚
Sylvia-IoT è¨­è¨ˆç†å¿µä¸­ï¼Œã€Œä»»æ„æŠ½æ›ã€æ˜¯ä¸€å€‹ç›¸ç•¶é‡è¦–çš„æ¦‚å¿µã€‚è¦ç›¡å¯èƒ½è®“ä½¿ç”¨è€…æ–¼ä¸åŒçš„å ´æ™¯ä¸‹é¸æ“‡åˆé©çš„å¯¦ä½œã€‚</p>
<h3 id="è³‡æ–™åº«è¨­è¨ˆ"><a class="header" href="#è³‡æ–™åº«è¨­è¨ˆ">è³‡æ–™åº«è¨­è¨ˆ</a></h3>
<p>åœ¨æä¾› CRUD çš„é †åºé ˆéµå®ˆä»¥ä¸‹è¦å‰‡ï¼š</p>
<ul>
<li>count</li>
<li>list</li>
<li>get</li>
<li>add</li>
<li>upsert</li>
<li>update</li>
<li>del</li>
</ul>
<p>å¹¾å€‹æ³¨æ„äº‹é …ï¼š</p>
<ul>
<li><strong>count</strong> èˆ‡ <strong>list</strong> éœ€æä¾›ä¸€è‡´çš„åƒæ•¸ï¼Œè®“ API å’Œ UI å‘ˆç¾çš„æ™‚å€™å¯ä»¥ç”¨ä¸€è‡´çš„æ–¹å¼å‘¼å« count å’Œ listã€‚</li>
<li>ä¸å¯ä»¥åœ¨ model ä¸­ä½¿ç”¨ loggerï¼Œéœ€è¦å›å‚³ error ç”±ä¸Šå±¤ä¾†å°å‡ºè¨Šæ¯ã€‚
<ul>
<li>ç•¶æœ‰å¤šå€‹ API å‘¼å«åŒä¸€å€‹ modelï¼Œç„¡æ³•å¾ model ä¸­å°å‡ºçš„éŒ¯èª¤è¨Šæ¯åˆ¤æ–·æ˜¯ç”±èª°å‘¼å«çš„ã€‚</li>
</ul>
</li>
<li>ç•¶å–ä¸åˆ°è³‡æ–™çš„æ™‚å€™ï¼Œè¦å› <code>None</code> æˆ–æ˜¯ç©ºçš„ <code>Vec</code>ï¼Œè€Œä¸æ˜¯ <code>Error</code>ã€‚</li>
<li>åªè¦èƒ½æ»¿è¶³ã€Œè¤‡é›œæŸ¥è©¢ã€æ¢ä»¶çš„è³‡æ–™åº«ï¼Œéƒ½æ‡‰è©²è¦å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ trait ä»‹é¢å¯¦ä½œã€‚
<ul>
<li>SQLã€MongoDB ç­‰çš†ç¬¦åˆæ­¤è¦æ±‚ã€‚</li>
<li>Redis ç„¡æ³•è¨­è¨ˆç‚ºè³‡æ–™åº«å½¢å¼ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å¿«å–è¨­è¨ˆ"><a class="header" href="#å¿«å–è¨­è¨ˆ">å¿«å–è¨­è¨ˆ</a></h3>
<ul>
<li>èƒ½æ»¿è¶³ä½è¤‡é›œåº¦çš„ <strong>key-value</strong> è®€å¯«è€…ï¼Œéƒ½è¦å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ trait ä»‹é¢å¯¦ä½œã€‚
<ul>
<li>Redisã€ç¨‹å¼èªè¨€çš„ map éƒ½ç¬¦åˆæ­¤è¦æ±‚ã€‚</li>
<li>SQLã€MongoDB ç­‰ä¹Ÿå¯ä»¥é€éæŸ¥è©¢å–®ä¸€æ¢ä»¶ä¾†å¯¦ç¾ã€‚ç•¶ç³»çµ±ä¸æƒ³å®‰è£å¤ªå¤šç¨®å·¥å…·æ™‚ï¼Œä½¿ç”¨ SQLã€MongoDB çš„å¿«å–ä»‹é¢å¯¦ä½œä¹Ÿæ˜¯å…è¨±çš„ã€‚</li>
</ul>
</li>
</ul>
<h2 id="routeshttp-api"><a class="header" href="#routeshttp-api">Routesï¼ˆHTTP APIï¼‰</a></h2>
<p>é€™é‚Šæä¾› API çš„æ–‡ä»¶å’Œå¯¦ä½œä¸Šéœ€è¦éµå®ˆçš„è¦å‰‡ã€‚</p>
<h3 id="å‹•è©é †åº"><a class="header" href="#å‹•è©é †åº">å‹•è©é †åº</a></h3>
<ul>
<li>POST</li>
<li>GET /count</li>
<li>GET /list</li>
<li>GET</li>
<li>PUT</li>
<li>PATCH</li>
<li>DELETE</li>
</ul>
<h3 id="è·¯å¾‘"><a class="header" href="#è·¯å¾‘">è·¯å¾‘</a></h3>
<ul>
<li><code>/[project]/api/v[version]/[function]</code></li>
<li><code>/[project]/api/v[version]/[function]/[op]</code></li>
<li><code>/[project]/api/v[version]/[function]/{id}</code></li>
</ul>
<p>ä¸Šé¢æœ‰å€‹æ­§ç¾©è™•ï¼š<code>[op]</code> å’Œ <code>{id}</code>ã€‚å‰è€…æ˜¯å›ºå®šçš„è¡Œç‚ºï¼Œå¾Œè€…æ˜¯æœƒè®Šå‹•çš„å°è±¡ IDã€‚è¨­è¨ˆ ID çš„æ™‚å€™è¦ç›¡é‡é¿å…èˆ‡è¡Œç‚ºçš„åç¨±è¡çªã€‚</p>
<blockquote>
<p>ä½¿ç”¨ axum æ›è¼‰è·¯ç”±çš„æ™‚å€™ï¼Œé ˆå°‡å›ºå®šçš„ <code>[op]</code> æ”¾åœ¨è®Šæ•¸ <code>{id}</code> çš„å‰é¢ã€‚</p>
</blockquote>
<p>é€™é‚Šèˆ‰ Broker çš„ <a href="https://github.com/woofdogtw/sylvia-iot-core/blob/main/sylvia-iot-broker/doc/api.md#contents"><strong>Device API</strong></a> ç‚ºä¾‹å­ï¼š</p>
<pre><code>- Device APIs
    - POST /broker/api/v1/device                Create device
    - POST /broker/api/v1/device/bulk           Bulk creating devices
    - POST /broker/api/v1/device/bulk-delete    Bulk deleting devices
    - GET  /broker/api/v1/device/count          Device count
    - GET  /broker/api/v1/device/list           Device list
    - GET  /broker/api/v1/device/{deviceId}     Get device information
</code></pre>
<p>å¯ä»¥çœ‹è¦‹ POST åŒæ™‚æœ‰å»ºç«‹å–®ä¸€ã€å»ºç«‹å¤šç­†ã€åˆªé™¤å¤šç­†çš„è¡Œç‚ºï¼Œå…¶ä¸­ <strong>bulk</strong>ã€<strong>bulk-delete</strong>ã€<strong>count</strong>ã€<strong>list</strong> å°±æ˜¯å‰è¿°çš„ <code>[op]</code>ã€‚
è€Œè£ç½® ID çš„è¨­è¨ˆä¸Šè¦é¿å…å’Œ <strong>count</strong> å’Œ <strong>list</strong> è¡çªã€‚</p>
<h3 id="å‡½æ•¸å‘½å"><a class="header" href="#å‡½æ•¸å‘½å">å‡½æ•¸å‘½å</a></h3>
<p><code>api.rs</code> çš„å‡½æ•¸å‘½åæ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code>fn [method]_[function]_[op]() {}
</code></pre>
<p>ä¸€æ¨£èˆ‰å‰›æ‰çš„ device API ç‚ºä¾‹å­ï¼Œå‡½æ•¸æœƒä»¥ä¸‹é¢çš„æ–¹å¼å‘½åï¼š</p>
<pre><code>fn post_device() {}
fn post_device_bulk() {}
fn post_device_bulk_del() {}
fn get_device_count() {}
fn get_device_list() {}
fn get_device() {}
</code></pre>
<h3 id="è«‹æ±‚èˆ‡å›æ‡‰å‘½å"><a class="header" href="#è«‹æ±‚èˆ‡å›æ‡‰å‘½å">è«‹æ±‚èˆ‡å›æ‡‰å‘½å</a></h3>
<p>è·¯å¾‘è®Šæ•¸ã€queryã€ request body å®šç¾©åœ¨ <code>request.rs</code> ä¸­ï¼›response body å‰‡æ˜¯å®šç¾©åœ¨ <code>response.rs</code> ä¸­ã€‚å‘½åå¦‚ä¸‹ï¼ˆæ³¨æ„å¤§å°å¯«ï¼‰ï¼š</p>
<pre><code>struct [Id]Path {}
struct [Method][Function]Body {}
struct Get[Function]Query {}
</code></pre>
<p>èˆ‰ä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code>struct DeviceIdPath {}      // /device/{deviceId}
struct PostDeviceBody {}
struct GetDeviceListQuery {}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ’°å¯«æ¸¬è©¦"><a class="header" href="#æ’°å¯«æ¸¬è©¦">æ’°å¯«æ¸¬è©¦</a></h1>
<p>Sylvia-IoT æ¡ç”¨ BDD æ¨¡å¼æ’°å¯«æ•´åˆæ¸¬è©¦ï¼Œæ¡†æ¶å‰‡æ˜¯é¸æ“‡ä»¿ç…§ <a href="https://mochajs.org/"><strong>Mocha</strong></a> çš„ <a href="https://enokson.github.io/laboratory/"><strong>laboratory</strong></a>ã€‚</p>
<p>æœ¬ç« ç¯€å°‡é‡å° libsã€modelsã€routes æè¿°æ’°å¯«æ¸¬è©¦æ™‚çš„åŸå‰‡å’ŒæŠ€å·§ã€‚</p>
<h2 id="teststate"><a class="header" href="#teststate">TestState</a></h2>
<p><code>TestState</code> çµæ§‹ç”¨ä¾†ä½œç‚º <code>SpecContext()</code> çš„åƒæ•¸ã€‚ä¿å­˜å¹¾ç¨®è®Šæ•¸ï¼š</p>
<ul>
<li>é•·æœŸå­˜åœ¨ï¼Œä¸”åªéœ€åˆå§‹åŒ–ä¸€æ¬¡æˆ–å¾ˆå°‘æ¬¡çš„ã€‚å¦‚ <code>runtime</code>ã€<code>mongodb</code> ç­‰ã€‚</li>
<li>éœ€è¦ç¢ºä¿åœ¨ <code>after</code> è¢«é‡‹æ”¾çš„è³‡æºã€‚ç”±æ–¼æ¸¬è©¦é …ç›®éƒ½å¯èƒ½åœ¨åŸ·è¡Œåˆ°ä¸€åŠçš„æ™‚å€™é›¢é–‹ï¼Œä¸€å®šè¦è¨˜å¾—åœ¨ <code>after</code> é‡‹æ”¾ã€‚</li>
</ul>
<h2 id="libs"><a class="header" href="#libs">libs</a></h2>
<ul>
<li>ç°¡å–®çš„å‡½æ•¸å¯ä»¥ç›´æ¥æ¸¬è©¦è¼¸å…¥ã€è¼¸å‡ºã€‚</li>
<li>åœ¨æ¸¬è©¦å‰å‹™å¿…å…ˆå•Ÿå‹•æŠŠæ‰€éœ€çš„åŸºç¤è¨­æ–½ï¼Œæ¯”å¦‚ RabbitMQã€EMQX ç­‰ã€‚</li>
<li>éœ€è¦æ¶è¨­æœå‹™çš„è¤‡é›œå ´æ™¯ï¼Œå¯ä»¥åœ¨ <code>before</code> å»ºç«‹æœå‹™ï¼ˆæ¯”å¦‚ä½‡åˆ—çš„é€£ç·šï¼‰ï¼Œä¸¦æ–¼ <code>after</code> é‡‹æ”¾ã€‚</li>
</ul>
<h2 id="models"><a class="header" href="#models">models</a></h2>
<ul>
<li>åœ¨æ¸¬è©¦å‰å‹™å¿…å…ˆå•Ÿå‹• MongoDBã€Redis ç­‰è³‡æ–™åº«ã€‚</li>
<li>æ’°å¯«æ¸¬è©¦çš„é †åºç‚º Rã€Cã€Uã€Dã€‚
<ul>
<li><strong>R</strong>: ä½¿ç”¨ <code>mongodb</code>ã€<code>sqlx</code> ç­‰åŸç”Ÿå¥—ä»¶å»ºç«‹æ¸¬è©¦è³‡æ–™é›†ï¼Œç„¶å¾Œæ¸¬è©¦ model çš„ getã€countã€list çš„çµæœã€‚</li>
<li><strong>C</strong>: ä½¿ç”¨ model çš„ addã€upsert ç­‰å‡½æ•¸å»ºç«‹è³‡æ–™ï¼Œä¸¦ä¸”ä½¿ç”¨ get é©—è­‰å…§å®¹çš„æ­£ç¢ºæ€§ã€‚</li>
<li><strong>U</strong>: ä½¿ç”¨ model çš„ addã€upsert ç­‰å‡½æ•¸å»ºç«‹æ¸¬è©¦è³‡æ–™é›†ï¼Œæ¥è‘—ç”¨ update ä¿®æ”¹è³‡æ–™ï¼Œæœ€å¾Œä½¿ç”¨ get ä¾†é©—è­‰çµæœã€‚</li>
<li><strong>D</strong>: ä½¿ç”¨ model çš„ addã€upsert ç­‰å‡½æ•¸å»ºç«‹æ¸¬è©¦è³‡æ–™é›†ï¼Œæ¥è‘—ç”¨ delete ä¿®æ”¹è³‡æ–™ï¼Œæœ€å¾Œä½¿ç”¨ get ä¾†é©—è­‰çµæœã€‚</li>
<li>å…ˆæ¸¬è©¦ <strong>R</strong> çš„åŠŸèƒ½ï¼Œç”¨æ„åœ¨æ’°å¯« Cã€Uã€D çš„æ™‚å€™å¯ä»¥ä½¿ç”¨çµ±ä¸€çš„ç¨‹å¼ç¢¼ä¾†æ’°å¯«æ¸¬è©¦é …ç›®ï¼Œçœ‹çœ‹åŒä¸€å€‹é‚è¼¯æ˜¯å¦å¯ä»¥åœ¨æ¯ä¸€ç¨®è³‡æ–™åº«å¼•æ“éƒ½æ˜¯ä¸€æ¨£çš„çµæœã€‚ä¹‹å¾Œå¼•é€²æ–°çš„å¼•æ“æ™‚ï¼Œå°±å¯ä»¥å¯«æœ€å°‘çš„æ¸¬è©¦ç¨‹å¼ç¢¼é€²è¡Œæ¸¬è©¦ã€‚</li>
</ul>
</li>
<li>åœ¨ <code>after</code> åˆªé™¤çš„æ™‚å€™ä½¿ç”¨åŸç”Ÿçš„å¥—ä»¶é€²è¡Œã€‚å› ç‚ºåœ¨æ¸¬è©¦å‰ç„¡æ³•ä¿è­‰ D ç›¸é—œçš„åŠŸèƒ½éƒ½å·²ç¶“æ­£ç¢ºè¢«å¯¦ä½œå’Œæ¸¬è©¦ã€‚</li>
</ul>
<h2 id="routes"><a class="header" href="#routes">routes</a></h2>
<ul>
<li>é›–ç„¶å¯ä»¥ä½¿ç”¨ axum çš„ <code>TestServer::new()</code> ä½œç‚ºè™›æ“¬æœå‹™ï¼Œä½† middleware æˆ–æ˜¯ API bridge èƒŒå¾Œæ‰€éœ€è¦çš„æœå‹™ï¼Œéƒ½éœ€è¦å…ˆç”¨ Tokio Task å•Ÿå‹•ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨ model trait ä»‹é¢é€²è¡Œæ¸¬è©¦è³‡æ–™é›†çš„åˆå§‹åŒ–ï¼Œä»¥åŠä½œç‚º API è«‹æ±‚å¾Œçš„è³‡æ–™æª¢æŸ¥ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨ model delete åœ¨ <code>after</code> æ™‚å€™åˆªé™¤æ¸¬è©¦è³‡æ–™ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è·¨å¹³å°ç·¨è­¯"><a class="header" href="#è·¨å¹³å°ç·¨è­¯">è·¨å¹³å°ç·¨è­¯</a></h1>
<p>Sylvia-IoT ä¸»è¦æ˜¯é‡å° x86-64 Linux å¹³å°é–‹ç™¼ã€‚ç”±æ–¼ Rust èªè¨€æœ¬èº«çš„è·¨å¹³å°ç‰¹æ€§ï¼ŒSylvia-IoT ä¹ŸåŒæ¨£å¯ä»¥ç·¨è­¯æˆä¸åŒå¹³å°çš„å¯åŸ·è¡Œæª”ã€‚
æœ¬ç« ç¯€å°‡ä»‹ç´¹ç­†è€…æ¸¬è©¦çš„å¹¾å€‹å¹³å°çš„ç·¨è­¯æµç¨‹ã€‚</p>
<p>ç·¨è­¯å‡ºä¾†çš„å¯åŸ·è¡Œæª”æ‡‰è©²å¯ä»¥åŸ·è¡Œæ–¼ç›¸å®¹çš„ç’°å¢ƒä¸‹ã€‚æ¯”å¦‚ Windows 10 çš„å¯åŸ·è¡Œæª”ä¹Ÿå¯ä»¥åŸ·è¡Œåœ¨ Windows 7ã€Windows 11 ä¸Šã€‚</p>
<blockquote>
<p>ç·¨è­¯ç’°å¢ƒéƒ½æ˜¯åŸºæ–¼ Ubuntu-22.04ã€‚</p>
</blockquote>
<h2 id="windows-10-64-bit"><a class="header" href="#windows-10-64-bit">Windows 10 64-bit</a></h2>
<pre><code class="language-shell">rustup target add x86_64-pc-windows-gnu
rustup toolchain install stable-x86_64-pc-windows-gnu
sudo apt -y install mingw-w64
echo -e "[target.x86_64-pc-windows-gnu]\nlinker = \"/usr/bin/x86_64-w64-mingw32-gcc\"\nar = \"/usr/bin/x86_64-w64-mingw32-ar\"\n" &gt;&gt; ~/.cargo/config
cargo build --target=x86_64-pc-windows-gnu -p sylvia-iot-coremgr
</code></pre>
<h2 id="raspberry-pi-os-64-bit"><a class="header" href="#raspberry-pi-os-64-bit">Raspberry Pi OS 64-bit</a></h2>
<pre><code class="language-shell">rustup target add aarch64-unknown-linux-gnu
sudo apt -y install gcc-aarch64-linux-gnu
echo -e "[target.aarch64-unknown-linux-gnu]\nlinker = \"/usr/bin/aarch64-linux-gnu-gcc\"\n" &gt;&gt; ~/.cargo/config
cargo build --target=aarch64-unknown-linux-gnu -p sylvia-iot-coremgr
</code></pre>
<h2 id="raspberry-pi-os-32-bit"><a class="header" href="#raspberry-pi-os-32-bit">Raspberry Pi OS 32-bit</a></h2>
<pre><code class="language-shell">rustup target add armv7-unknown-linux-gnueabihf
sudo apt -y install gcc-arm-linux-gnueabihf
echo -e "[target.armv7-unknown-linux-gnueabihf]\nlinker = \"arm-linux-gnueabihf-gcc\"\n" &gt;&gt; ~/.cargo/config
cargo build --target=armv7-unknown-linux-gnueabihf -p sylvia-iot-coremgr
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é™„éŒ„"><a class="header" href="#é™„éŒ„">é™„éŒ„</a></h1>
<p>æœ¬ç« å…§å®¹ï¼š</p>
<ul>
<li>ä½¿ç”¨è³‡æºçš„ä¾†æºã€‚</li>
<li>ä¸€äº›è¼”åŠ©çš„å°ˆæ¡ˆã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è³‡æ–™ä¾†æº"><a class="header" href="#è³‡æ–™ä¾†æº">è³‡æ–™ä¾†æº</a></h1>
<h2 id="åœ–ç‰‡"><a class="header" href="#åœ–ç‰‡">åœ–ç‰‡</a></h2>
<p>æœ¬æ–‡ä»¶çš„åœ–ç¤ºä¾†æºæœ‰ä»¥ä¸‹å¹¾å€‹ï¼š</p>
<ul>
<li><a href="https://draw.io">draw.io</a></li>
<li><a href="https://www.svgrepo.com/">SVG Repo</a></li>
<li><a href="https://hub.docker.com/_/emqx">EMQX</a>
<ul>
<li>ç”±æ–¼ SVG Repo æ‰¾ä¸åˆ°ï¼Œæ¶æ§‹åœ–çš„ EMQX åœ–ç¤ºå°±å¾ Docker Hub è¤‡è£½ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>å¦‚æœ‰ä¾µæ¬Šç…©è«‹ <a href="mailto:woofdogtw@hotmail.com"><strong>ä¾†ä¿¡</strong></a> å‘ŠçŸ¥ã€‚</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¼”åŠ©å°ˆæ¡ˆ"><a class="header" href="#è¼”åŠ©å°ˆæ¡ˆ">è¼”åŠ©å°ˆæ¡ˆ</a></h1>
<ul>
<li><a href="https://github.com/woofdogtw/sylvia-iot-core/tree/main/sylvia-router">sylvia-router</a>
<ul>
<li>æ•´åˆ auth/broker/coremgr/data çš„åŸºæœ¬è·¯ç”±å™¨ã€‚</li>
<li>æ”¯æ´å¤š WAN interface å’Œå–®ä¸€ LAN bridgeã€‚</li>
<li>ï¼ˆå¯é¸ï¼‰æ”¯æ´ WiFi WAN å’Œ WiFi LANã€‚</li>
</ul>
</li>
<li><a href="https://github.com/woofdogtw/sylvia-iot-core/tree/main/stress-simple">stress-simple</a>
<ul>
<li>ç°¡æ˜“çš„å£“åŠ›ç¨‹å¼ï¼Œå¯ä»¥æ¸¬è©¦ Broker çš„è½‰ç™¼é€Ÿåº¦ã€‚</li>
<li>æä¾›æœ€å¤§ã€æœ€å°ã€å¹³å‡å€¼ã€P50/P80/P90/P95/P98/P99 çš„å»¶é²æ•¸æ“šã€‚</li>
</ul>
</li>
<li><a href="https://github.com/woofdogtw/sylvia-iot-examples">sylvia-iot-examples</a>
<ul>
<li>ä½¿ç”¨ SDK å¯¦ä½œçš„æ‡‰ç”¨å’Œç¶²è·¯ç¯„ä¾‹ã€‚</li>
<li><strong>lora-ifroglab</strong>
<ul>
<li><a href="http://www.ifroglab.com/en/?p=6536">iFrogLab LoRa USB Dongle</a></li>
<li>å¯¦ä½œå°æ‡‰çš„ç¶²è·¯æœå‹™ä¸¦ç›´æ¥å’Œè£ç½®ç«¯å°é€ã€‚</li>
</ul>
</li>
<li><strong>app-demo</strong>: æ¥æ”¶ lora-ifroglab è£ç½®çš„æ„Ÿæ‡‰å™¨è³‡æ–™ä¸¦é¡¯ç¤ºã€‚æœ‰æº«åº¦ã€æ¿•åº¦ã€RSSI ç­‰ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/woofdogtw/sylvia-iot-simple-ui">sylvia-iot-simple-ui</a>
<ul>
<li>æä¾›ç°¡æ˜“çš„ Sylvia-IoT UIã€‚</li>
<li><strong>coremgr-cli</strong> æä¾›å®Œæ•´çš„åŠŸèƒ½ï¼ŒUI ä¾æ“šç•«é¢æ’ç‰ˆæä¾›å¿…è¦çš„æ“ä½œåŠŸèƒ½ã€‚</li>
<li>é™¤äº† auth/broker/coremgr/dataï¼Œé‚„æ•´åˆäº† router å’Œ examplesã€‚</li>
</ul>
</li>
<li><a href="https://github.com/woofdogtw/sylvia-iot-go">sylvia-iot-go</a>
<ul>
<li>Go å¯¦ä½œçš„å…ƒä»¶ã€‚</li>
<li>å«æœ‰ <strong>general-mq</strong>ã€<strong>sdk</strong> ç­‰ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/woofdogtw/sylvia-iot-node">sylvia-iot-node</a>
<ul>
<li>Node.js å¯¦ä½œçš„å…ƒä»¶ã€‚</li>
<li>å«æœ‰ <strong>general-mq</strong>ã€<strong>sdk</strong> ç­‰ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/woofdogtw/sylvia-iot-deployment">sylvia-iot-deployment</a>
<ul>
<li>æä¾›éƒ¨ç½²çš„æ–¹æ¡ˆï¼Œå¦‚ K8S ç­‰ã€‚</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
