<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Code Style - Sylvia-IoT Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/overview.html"><strong aria-hidden="true">1.1.</strong> What is Sylvia-IoT?</a></li><li class="chapter-item expanded "><a href="../intro/concept.html"><strong aria-hidden="true">1.2.</strong> Concept</a></li></ol></li><li class="chapter-item expanded "><a href="../guide/index.html"><strong aria-hidden="true">2.</strong> User Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guide/quick.html"><strong aria-hidden="true">2.1.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="../guide/configuration.html"><strong aria-hidden="true">2.2.</strong> Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../arch/index.html"><strong aria-hidden="true">3.</strong> Internal Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../arch/arch.html"><strong aria-hidden="true">3.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../arch/flow.html"><strong aria-hidden="true">3.2.</strong> Data Flow</a></li><li class="chapter-item expanded "><a href="../arch/cache.html"><strong aria-hidden="true">3.3.</strong> Cache</a></li></ol></li><li class="chapter-item expanded "><a href="../dev/index.html"><strong aria-hidden="true">4.</strong> Developer's Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/oauth2.html"><strong aria-hidden="true">4.1.</strong> OAuth2 Authentication</a></li><li class="chapter-item expanded "><a href="../dev/network.html"><strong aria-hidden="true">4.2.</strong> Network Services</a></li><li class="chapter-item expanded "><a href="../dev/application.html"><strong aria-hidden="true">4.3.</strong> Application Services</a></li><li class="chapter-item expanded "><a href="../dev/core.html"><strong aria-hidden="true">4.4.</strong> Sylvia-IoT Core</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/dir.html"><strong aria-hidden="true">4.4.1.</strong> Directory Structure</a></li><li class="chapter-item expanded "><a href="../dev/style.html" class="active"><strong aria-hidden="true">4.4.2.</strong> Code Style</a></li><li class="chapter-item expanded "><a href="../dev/testing.html"><strong aria-hidden="true">4.4.3.</strong> Writing Tests</a></li></ol></li><li class="chapter-item expanded "><a href="../dev/cross.html"><strong aria-hidden="true">4.5.</strong> Cross-Platform Compilation</a></li></ol></li><li class="chapter-item expanded "><a href="../appendex/index.html"><strong aria-hidden="true">5.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendex/source.html"><strong aria-hidden="true">5.1.</strong> Data Sources</a></li><li class="chapter-item expanded "><a href="../appendex/repo.html"><strong aria-hidden="true">5.2.</strong> Supplementary Projects</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sylvia-IoT Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="code-style"><a class="header" href="#code-style">Code Style</a></h1>
<h2 id="using-rustfmt"><a class="header" href="#using-rustfmt">Using rustfmt</a></h2>
<p>Please make sure to <strong>ALWAYS</strong> use <code>rustfmt</code> to format all files. We recommend using VSCode with the
<strong>rust-analyzer extension</strong> for writing code.</p>
<p>Below is the author's development environment for your reference:</p>
<ul>
<li>
<p>VSCode Extensions</p>
<ul>
<li><strong>CodeLLDB</strong> (Vadim Chugunov)</li>
<li><strong>crates</strong> (Seray Uzgur)</li>
<li><strong>Docker</strong> (Microsoft)</li>
<li><strong>GitHub Actions</strong> (Mathieu Dutour)</li>
<li><strong>rust-analyzer</strong> (The Rust Programming Language)</li>
<li><strong>YAML</strong> (Red Hat)</li>
</ul>
</li>
<li>
<p>VSCode Settings</p>
<pre><code class="language-json">{
    &quot;crates.listPreReleases&quot;: true,
    &quot;editor.formatOnSave&quot;: true,
    &quot;editor.renderWhitespace&quot;: &quot;all&quot;,
    &quot;editor.roundedSelection&quot;: false,
    &quot;editor.tabSize&quot;: 4,
    &quot;files.eol&quot;: &quot;\n&quot;,
    &quot;rust-analyzer.inlayHints.chainingHints.enable&quot;: false,
    &quot;rust-analyzer.inlayHints.closingBraceHints.enable&quot;: false,
    &quot;rust-analyzer.inlayHints.parameterHints.enable&quot;: false,
    &quot;rust-analyzer.inlayHints.typeHints.enable&quot;: false,
    &quot;rust-analyzer.server.extraEnv&quot;: {
        &quot;RUSTFLAGS&quot;: &quot;-C instrument-coverage&quot;
    }
}
</code></pre>
<blockquote>
<p>The use of the <code>-C instrument-coverage</code> environment variable is due to the author's need to generate coverage reports during testing. Adding this variable prevents recompilation triggered by saving and running tests. Below is the command for running tests:</p>
<p><code>RUSTFLAGS=&quot;-C instrument-coverage&quot; cargo test -p $PROJ --test integration_test -- --nocapture</code></p>
</blockquote>
</li>
</ul>
<h2 id="mvc-vs-microservices"><a class="header" href="#mvc-vs-microservices">MVC vs. Microservices</a></h2>
<p>I prefer a bottom-up development approach. Using an architecture like MVC, which designs the
database as a lower-level generic interface, and implementing various functionalities called by the
API upper layer, aligns well with my personal style. This is the reason behind the creation of
<code>models</code> and <code>routes</code>.</p>
<p>However, when designing the entire Sylvia-IoT platform, I also aimed for modularity and chose a
microservices-based approach (i.e., ABCD), strictly adhering to the principle of hierarchical
dependencies.</p>
<p>Even with a microservices architecture, as described in the previous section
<a href="dir.html"><strong>Directory Structure</strong></a>, when <code>main.rs</code> references the required <code>routes</code>, the entire
project can still be compiled into a single executable file and run on a single machine. This
design offers several deployment options, such as:</p>
<ul>
<li>Monolith: Running a single all-in-one executable on a single machine.</li>
<li>Microservices cluster: Running each component independently on different machines, with each
component setting up its own cluster.</li>
<li>Monolith cluster: Running the all-in-one on multiple machines to form a clustered architecture.</li>
</ul>
<p>Sylvia-IoT embodies the combination of both MVC and microservices design 😊.</p>
<h2 id="file-content-arrangement"><a class="header" href="#file-content-arrangement">File Content Arrangement</a></h2>
<p>Each rs file is structured in the following way, with blank lines separating each section:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use rust_builtin_modules;

use 3rd_party_modules;

use sylvia_iot_modules;

use crate_modules;

pub struct PubStructEnums {}

struct PrvStructEnums {}

pub const PUB_CONSTANTS;

const PRV_CONSTANTS;

pub pub_static_vars;

static prv_static_vars;

impl PubStructEnums {}

pub fn pub_funcs {}

impl PrvStructEnums {}

fn prv_funcs {}
<span class="boring">}</span></code></pre></pre>
<p>The general order is as follows:</p>
<ul>
<li>Using modules</li>
<li>Structures</li>
<li>Constants</li>
<li>Variables</li>
<li>Functions (including structure function implementations)</li>
</ul>
<p>Within each section, <code>pub</code> comes before private.</p>
<h2 id="model"><a class="header" href="#model">Model</a></h2>
<p>The Model layer must provide a unified struct and trait interface.
In the design philosophy of Sylvia-IoT, &quot;plug-and-play&quot; is a concept that is highly valued. Users
should be able to choose appropriate implementations in different scenarios.</p>
<h3 id="database-design"><a class="header" href="#database-design">Database Design</a></h3>
<p>When providing CRUD operations, the following order must be followed:</p>
<ul>
<li>count</li>
<li>list</li>
<li>get</li>
<li>add</li>
<li>upsert</li>
<li>update</li>
<li>del</li>
</ul>
<p>Some points to note:</p>
<ul>
<li><strong>count</strong> and <strong>list</strong> should provide consistent parameters so that the API and UI can call count
and list in a consistent manner.</li>
<li>Logger should not be used in the <code>model</code>. Errors should be returned to the upper layer to print
the messages.
<ul>
<li>When multiple APIs call the same <code>model</code>, errors printed from the model cannot determine who
made the call.</li>
</ul>
</li>
<li>When data cannot be retrieved, return <code>None</code> or an empty <code>Vec</code>, not an <code>Error</code>.</li>
<li>Any database that can fulfill the &quot;complex query&quot; condition should be implementable using the same
trait interface.
<ul>
<li>SQL, MongoDB meet this requirement.</li>
<li>Redis cannot be designed in the form of a database.</li>
</ul>
</li>
</ul>
<h3 id="cache-design"><a class="header" href="#cache-design">Cache Design</a></h3>
<ul>
<li>Any <strong>key-value</strong> store that can fulfill low-complexity read and write should be implementable
using the same trait interface.
<ul>
<li>Redis, language-specific maps meet this requirement.</li>
<li>SQL, MongoDB can also be implemented through querying a single condition. Using SQL or MongoDB
for cache implementation is allowed when the system does not want to install too many
different tools.</li>
</ul>
</li>
</ul>
<h2 id="routes-http-api"><a class="header" href="#routes-http-api">Routes (HTTP API)</a></h2>
<p>In this section, the documentation and rules for implementing APIs are provided.</p>
<h3 id="verb-order"><a class="header" href="#verb-order">Verb Order</a></h3>
<ul>
<li>POST</li>
<li>GET /count</li>
<li>GET /list</li>
<li>GET</li>
<li>PUT</li>
<li>PATCH</li>
<li>DELETE</li>
</ul>
<h3 id="path"><a class="header" href="#path">Path</a></h3>
<ul>
<li><code>/[project]/api/v[version]/[function]</code></li>
<li><code>/[project]/api/v[version]/[function]/[op]</code></li>
<li><code>/[project]/api/v[version]/[function]/{id}</code></li>
</ul>
<p>There is a potential ambiguity: <code>[op]</code> and <code>{id}</code>. The former represents a fixed action, while the
latter represents a variable object ID. When designing IDs, it is essential to avoid conflicts with
the names of actions.</p>
<blockquote>
<p>When mounting routes using Actix Web, the fixed <code>[op]</code> should be placed before the variable
<code>{id}</code>.</p>
</blockquote>
<p>For example, let's consider the Broker's
<a href="https://github.com/woofdogtw/sylvia-iot-core/blob/main/sylvia-iot-broker/doc/api.md#contents"><strong>Device API</strong></a>:</p>
<pre><code>- Device APIs
    - POST /broker/api/v1/device                Create device
    - POST /broker/api/v1/device/bulk           Bulk creating devices
    - POST /broker/api/v1/device/bulk-delete    Bulk deleting devices
    - GET  /broker/api/v1/device/count          Device count
    - GET  /broker/api/v1/device/list           Device list
    - GET  /broker/api/v1/device/{deviceId}     Get device information
</code></pre>
<p>Here, you can see that the POST method handles creating single devices, bulk creating devices, and
bulk deleting devices. The <strong>bulk</strong>, <strong>bulk-delete</strong>, <strong>count</strong>, <strong>list</strong> are the previously
mentioned <code>[op]</code>.
The design of device IDs should avoid conflicts with <strong>count</strong> and <strong>list</strong>.</p>
<h3 id="function-naming"><a class="header" href="#function-naming">Function Naming</a></h3>
<p>The functions in <code>api.rs</code> are named as follows:</p>
<pre><code>fn [method]_[function]_[op]() {}
</code></pre>
<p>Continuing with the previous device API example, the functions would be named like this:</p>
<pre><code>fn post_device() {}
fn post_device_bulk() {}
fn post_device_bulk_del() {}
fn get_device_count() {}
fn get_device_list() {}
fn get_device() {}
</code></pre>
<h3 id="request-and-response-naming"><a class="header" href="#request-and-response-naming">Request and Response Naming</a></h3>
<p>Path variables, queries, and request bodies are defined in <code>request.rs</code>, while response bodies are
defined in <code>response.rs</code>. The naming convention is as follows (pay attention to capitalization):</p>
<pre><code>struct [Id]Path {}
struct [Method][Function]Body {}
struct Get[Function]Query {}
</code></pre>
<p>For example:</p>
<pre><code>struct DeviceIdPath {}      // /device/{deviceId}
struct PostDeviceBody {}
struct GetDeviceListQuery {}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dev/dir.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../dev/testing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dev/dir.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../dev/testing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
